<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus AI | ULTRA v3.8</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <style>
        /* ==========================================
           THEME SYSTEM VARIABLES (v3.8)
           ========================================== */
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --error: #ef4444;
            --error-glow: rgba(239, 68, 68, 0.3);
            --emergency: #8b5cf6;
            --emergency-glow: rgba(139, 92, 246, 0.3);
            --bg: #0b0f1a;
            --panel: rgba(17, 24, 39, 0.7);
            --panel-2: rgba(31, 41, 55, 0.5);
            --text: #f0f9ff;
            --text-secondary: #94a3b8;
            --input-bg: rgba(15, 23, 42, 0.6);
            --border: rgba(99, 102, 241, 0.2);
            --hover: rgba(99, 102, 241, 0.1);
            --blur: blur(12px);
            --mobile-nav-height: 60px;
        }

        [data-theme="cyberpunk"] {
            --accent: #ff006e;
            --accent-glow: rgba(255, 0, 110, 0.4);
            --border: rgba(255, 0, 110, 0.2);
            --hover: rgba(255, 0, 110, 0.1);
            --bg: #0a0a0a;
            --emergency: #ff006e;
            --panel: rgba(20, 0, 10, 0.7);
            --panel-2: rgba(30, 0, 15, 0.5);
        }

        [data-theme="ocean"] {
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.4);
            --border: rgba(0, 212, 255, 0.2);
            --hover: rgba(0, 212, 255, 0.1);
            --bg: #001122;
            --emergency: #0066ff;
            --panel: rgba(0, 20, 40, 0.7);
            --panel-2: rgba(0, 30, 60, 0.5);
        }

        [data-theme="forest"] {
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.4);
            --border: rgba(0, 255, 136, 0.2);
            --hover: rgba(0, 255, 136, 0.1);
            --bg: #001a0a;
            --emergency: #00cc66;
            --panel: rgba(0, 30, 20, 0.7);
            --panel-2: rgba(0, 40, 30, 0.5);
        }

        /* ==========================================
           TYPING ANIMATION & IMAGE EFFECTS (v3.8)
           ========================================== */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .msg { animation: fadeIn 0.4s ease !important; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* ==========================================
           NEW: BLUR-TO-SHARP EFFECT (ТЗ #1)
           ========================================== */
        @keyframes blurToSharp {
            0% { 
                filter: blur(20px) brightness(1.5) contrast(0.7); 
                transform: scale(1.05); 
            }
            25% { 
                filter: blur(10px) brightness(1.2) contrast(0.85); 
                transform: scale(1.02); 
            }
            50% { 
                filter: blur(5px) brightness(1.1) contrast(0.9); 
                transform: scale(1.01); 
            }
            75% { 
                filter: blur(2px) brightness(1.05) contrast(0.95); 
                transform: scale(1.005); 
            }
            100% { 
                filter: blur(0) brightness(1) contrast(1); 
                transform: scale(1); 
            }
        }
        
        .image-container {
            position: relative;
            margin: 12px 0;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            animation: fadeIn 0.3s ease;
            cursor: pointer;
            /* ТЗ #1: Контейнер подстраивается под размер изображения */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* NEW: SKELETON SCREEN (ТЗ #1) */
        .image-skeleton {
            background: linear-gradient(90deg, 
                rgba(99, 102, 241, 0.08) 25%, 
                rgba(99, 102, 241, 0.2) 50%, 
                rgba(99, 102, 241, 0.08) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            height: 300px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex-direction: column;
            gap: 8px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .generated-image {
            /* ТЗ #1: Сохранение пропорций */
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 600px;
            border-radius: 14px;
            opacity: 0;
            animation: blurToSharp 0.8s ease-out forwards;
            display: block;
            transition: transform 0.3s ease;
            object-fit: contain; /* Ключевое изменение */
        }
        
        .generated-image:hover {
            transform: scale(1.02);
        }
        
        .image-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .image-container:hover .image-actions {
            opacity: 1;
        }
        
        .image-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            transition: all 0.2s;
        }
        
        .image-action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 0 8px var(--accent-glow);
        }
        
        .image-meta {
            padding: 12px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            width: 100%;
        }
        
        .quick-save-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .quick-save-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .key-input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.85rem;
            margin-top: 8px;
            word-break: break-all;
            transition: border-color 0.2s;
        }
        
        .key-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .key-input.valid {
            border-color: var(--success);
            box-shadow: 0 0 8px var(--success-glow);
        }

        .key-input.invalid {
            border-color: var(--error);
            box-shadow: 0 0 8px var(--error-glow);
        }
        
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }
        
        .image-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 8px;
            animation: blurToSharp 0.5s ease;
            cursor: zoom-out;
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 2001;
        }
        
        .image-modal-close:hover {
            background: rgba(239, 68, 68, 0.8);
            transform: scale(1.1);
        }
        
        .search-indicator {
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .search-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        /* ТЗ #4: Кнопки ракурса камеры */
        .camera-controls {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(6px, 1.5vw, 10px);
            flex-wrap: wrap;
        }

        .camera-controls.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .camera-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-align: center;
        }

        .camera-btn.active {
            border-color: var(--accent);
            background: var(--hover);
            color: var(--accent);
        }

        .camera-btn:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        
        /* ==========================================
           NEW: VISUAL STYLE SELECTOR GRID (ТЗ #3)
           ========================================== */
        .style-grid {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(8px, 2vw, 12px);
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }

        .style-grid.active {
            display: grid;
            animation: fadeIn 0.3s ease;
        }

        .style-card {
            position: relative;
            height: 100px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--input-bg);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .style-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .style-card.active {
            border-color: var(--accent);
            background: var(--hover);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .style-card i {
            font-size: 1.8rem;
            color: var(--accent);
        }

        .style-card span {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ==========================================
           NEW: MAGIC BUTTON TOGGLE (ТЗ #3)
           ========================================== */
        .magic-toggle {
            display: none;
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: all 0.3s;
            z-index: 999;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .magic-toggle.active {
            background: linear-gradient(135deg, var(--success), #059669);
            box-shadow: 0 4px 20px var(--success-glow);
        }

        .magic-toggle:hover {
            transform: translateY(-3px) scale(1.1);
        }

        .magic-toggle::after {
            content: '✨';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* ==========================================
           NEW: FACE RESTORATION INDICATOR (ТЗ #1)
           ========================================== */
        .face-restoration-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            background: var(--success);
            color: white;
            border-radius: 6px;
            font-size: 0.6rem;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--success-glow);
        }

        .image-container:hover .face-restoration-indicator {
            opacity: 1;
        }
        
        * { 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            transition: background-color 0.2s, border-color 0.2s, transform 0.2s; 
        }
        
        html, body { 
            height: 100%; 
            overflow-x: hidden; 
        }
        
        body {
            background: var(--bg); 
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%);
            color: var(--text); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        
        aside { 
            width: 320px; 
            background: var(--panel); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 16px; 
            z-index: 1000; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3); 
            position: relative; 
        }
        
        .mobile-menu-toggle { 
            display: none; 
            position: fixed; 
            top: 16px; 
            left: 16px; 
            z-index: 1001; 
            width: 44px; 
            height: 44px; 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            color: var(--text); 
            cursor: pointer; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2rem; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); 
        }
        
        .mobile-menu-toggle:active { 
            transform: scale(0.95); 
        }
        
        .logo { 
            font-size: clamp(1.2rem, 2vw, 1.5rem); 
            font-weight: 700; 
            color: var(--accent); 
            margin-bottom: 24px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px; 
            user-select: none; 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
            text-shadow: 0 0 20px var(--accent-glow); 
        }
        
        .status-panel { 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: clamp(12px, 2vw, 16px); 
            margin-bottom: 20px; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); 
        }
        
        .status-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 8px 0; 
            font-size: clamp(0.75rem, 1.5vw, 0.8rem); 
        }
        
        .status-indicator { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: var(--text-secondary); 
            box-shadow: 0 0 8px currentColor; 
        }
        
        .status-indicator.connected { 
            background: var(--success); 
            animation: pulse-success 2s infinite; 
        }
        
        .status-indicator.emergency { 
            background: var(--emergency); 
            animation: pulse-success 2s infinite; 
        }
        
        @keyframes pulse-success { 
            0%, 100% { box-shadow: 0 0 0 0 var(--success-glow); } 
            50% { box-shadow: 0 0 0 6px var(--success-glow); } 
        }
        
        .model-limits { 
            max-height: 250px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            margin-top: 12px; 
            scrollbar-width: thin; 
            scrollbar-color: var(--border) transparent; 
        }
        
        .model-limit-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px; 
            margin: 4px 0; 
            background: rgba(0, 0, 0, 0.2); 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            position: relative; 
        }
        
        .model-limit-item.best { 
            border-color: var(--accent); 
            background: var(--hover); 
            box-shadow: 0 0 12px var(--accent-glow); 
        }
        
        .model-limit-item.unreliable { 
            opacity: 0.6; 
            border-style: dashed; 
        }
        
        .model-name { 
            font-size: clamp(0.7rem, 1.5vw, 0.75rem); 
            font-weight: 500; 
        }
        
        .limit-count { 
            font-size: clamp(0.7rem, 1.5vw, 0.75rem); 
            font-weight: 600; 
        }
        
        .limit-bar { 
            width: 100%; 
            height: 4px; 
            background: var(--panel-2); 
            border-radius: 2px; 
            margin-top: 4px; 
            overflow: hidden; 
        }
        
        .limit-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent), #8b5cf6); 
            border-radius: 2px; 
            transition: width 0.3s ease; 
        }
        
        .controls-section { 
            margin-bottom: 20px; 
        }
        
        .section-title { 
            font-size: clamp(0.6rem, 1.5vw, 0.7rem); 
            color: var(--text-secondary); 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 8px; 
            padding: 0 8px; 
            letter-spacing: 0.5px; 
        }
        
        .btn { 
            background: var(--panel-2); 
            border: 1px solid var(--border); 
            padding: clamp(8px, 1.5vw, 10px) clamp(10px, 1.5vw, 12px); 
            border-radius: 10px; 
            cursor: pointer; 
            color: var(--text); 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            width: 100%; 
            margin-bottom: 6px; 
            transition: all 0.2s; 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            min-height: 44px; 
        }
        
        .btn:hover { 
            background: var(--hover); 
            border-color: var(--accent); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); 
        }
        
        .btn:active { 
            transform: translateY(0); 
        }
        
        .btn.danger:hover { 
            border-color: var(--error); 
            box-shadow: 0 4px 12px var(--error-glow); 
        }
        
        /* v3.8: Обновлен Aspect Ratio Selector */
        .aspect-ratio-selector {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(6px, 1.5vw, 10px);
            flex-wrap: wrap;
        }

        .aspect-ratio-selector.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .aspect-btn {
            flex: 1;
            min-width: 60px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-align: center;
        }

        .aspect-btn.active {
            border-color: var(--accent);
            background: var(--hover);
            color: var(--accent);
        }

        .aspect-btn:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .prompt-enhancer-btn {
            position: absolute;
            left: 8px;
            bottom: 8px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 5;
        }

        .prompt-enhancer-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .persona-selector {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(6px, 1.5vw, 10px);
        }

        .persona-selector.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .persona-selector select {
            flex: 1;
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: clamp(0.8rem, 1.5vw, 0.85rem);
        }

        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theme-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel-2);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            text-align: center;
        }

        .theme-btn.active {
            border-color: var(--accent);
            background: var(--hover);
            color: var(--accent);
        }

        .theme-btn:hover {
            transform: translateY(-1px);
        }

        .folder-item {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px;
        }

        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .folder-content {
            display: none;
            padding-left: 16px;
            padding-top: 8px;
        }

        .folder-content.active {
            display: block;
        }

        .folder-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .mode-container { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            margin-bottom: 20px; 
        }
        
        .mode-btn { 
            background: var(--panel-2); 
            border: 1px solid var(--border); 
            padding: clamp(8px, 1.5vw, 10px) clamp(10px, 1.5vw, 12px); 
            border-radius: 10px; 
            cursor: pointer; 
            color: var(--text-secondary); 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.2s; 
            min-height: 44px; 
        }
        
        .mode-btn.active { 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            color: white; 
            border-color: var(--accent); 
            box-shadow: 0 0 16px var(--accent-glow); 
        }
        
        .mode-btn:hover:not(.active) { 
            background: var(--hover); 
        }
        
        main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background: radial-gradient(circle at 50% 0%, rgba(99, 102, 241, 0.1) 0%, transparent 50%); 
            padding-left: 0; 
            transition: padding-left 0.3s; 
        }
        
        #chat-window { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding: clamp(16px, 3vw, 24px) clamp(12px, 3vw, 24px); 
            display: flex; 
            flex-direction: column; 
            gap: clamp(16px, 3vw, 24px); 
            scroll-behavior: smooth; 
        }
        
        #thinking { 
            display: none; 
            padding: clamp(12px, 2vw, 14px) clamp(16px, 3vw, 20px); 
            margin: 0 clamp(12px, 3vw, 15%) clamp(12px, 2vw, 16px); 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--accent); 
            border-radius: 14px; 
            box-shadow: 0 0 20px var(--accent-glow); 
            animation: fadeIn 0.3s ease; 
        }
        
        .thinking-content { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--accent); 
            font-size: clamp(0.85rem, 2vw, 0.9rem); 
            font-weight: 500; 
        }
        
        .pulse { 
            width: 10px; 
            height: 10px; 
            background: var(--accent); 
            border-radius: 50%; 
            animation: pulse-ring 1.5s infinite; 
        }
        
        @keyframes pulse-ring { 
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 var(--accent-glow); } 
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px transparent; } 
            100% { transform: scale(0.9); } 
        }
        
        .msg { 
            max-width: 90%; 
            line-height: 1.7; 
            animation: slideIn 0.4s ease; 
            position: relative; 
        }
        
        .user { 
            align-self: flex-end; 
            background: linear-gradient(135deg, var(--panel-2), var(--panel)); 
            padding: clamp(12px, 2vw, 14px) clamp(16px, 2vw, 20px); 
            border-radius: 18px; 
            border-bottom-right-radius: 6px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.25); 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            font-size: clamp(0.9rem, 2vw, 1rem); 
        }
        
        .ai { 
            align-self: flex-start; 
            background: transparent; 
            width: 100%; 
            border-radius: 0; 
        }
        
        .ai-header { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 8px; 
            font-size: clamp(0.75rem, 1.5vw, 0.8rem); 
            font-weight: 600; 
            color: var(--accent); 
            letter-spacing: 0.5px; 
        }
        
        .ai-avatar { 
            width: 24px; 
            height: 24px; 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            box-shadow: 0 0 8px var(--accent-glow); 
            font-size: clamp(0.75rem, 1.5vw, 0.8rem); 
        }
        
        .ai-content { 
            color: var(--text); 
            padding-left: 32px; 
            font-size: clamp(0.9rem, 2vw, 1rem); 
        }
        
        .code-block-wrapper { 
            position: relative; 
            margin: 12px 0; 
            border-radius: 10px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
        }
        
        .copy-btn { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: var(--panel); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            color: var(--text-secondary); 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            padding: 4px 8px; 
            font-size: 0.7rem; 
            cursor: pointer; 
            opacity: 0; 
            transition: opacity 0.2s, transform 0.2s; 
            z-index: 10; 
        }
        
        .code-block-wrapper:hover .copy-btn { 
            opacity: 1; 
        }
        
        .copy-btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); 
        }
        
        .copy-btn.copied { 
            background: var(--success); 
            color: white; 
            border-color: var(--success); 
        }
        
        pre { 
            background: rgba(0, 0, 0, 0.4); 
            padding: clamp(12px, 2vw, 16px); 
            margin: 0; 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        .input-area { 
            padding: clamp(12px, 2vw, 20px) clamp(12px, 3vw, 15%); 
            background: linear-gradient(transparent, var(--bg) 60%); 
            position: relative; 
            padding-bottom: max(clamp(12px, 2vw, 20px), env(safe-area-inset-bottom)); 
        }
        
        .input-bar { 
            background: var(--input-bg); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            border-radius: 18px; 
            padding: 8px clamp(8px, 2vw, 14px); 
            display: flex; 
            align-items: end; 
            gap: clamp(6px, 1.5vw, 10px); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4); 
            transition: border-color 0.2s, box-shadow 0.2s; 
            position: relative;
            padding-left: 40px; /* Space for enhancer button */
        }
        
        textarea { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: white; 
            padding: 8px; 
            font-size: clamp(0.9rem, 2vw, 0.95rem); 
            outline: none; 
            resize: none; 
            max-height: 120px; 
            font-family: inherit; 
            line-height: 1.4; 
        }
        
        .send-btn, .stop-btn { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            border: none; 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            color: white; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(0.9rem, 2vw, 1rem); 
            transition: all 0.2s; 
            flex-shrink: 0; 
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); 
        }
        
        .send-btn:hover, .stop-btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px var(--accent-glow); 
        }
        
        .stop-btn { 
            background: linear-gradient(135deg, var(--error), #dc2626); 
            box-shadow: 0 2px 8px var(--error-glow); 
        }
        
        body.generating .send-btn { 
            display: none; 
        }
        
        body.generating .stop-btn { 
            display: flex; 
        }
        
        .voice-btn { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            background: var(--panel-2); 
            color: var(--text-secondary); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(0.9rem, 2vw, 1rem); 
            transition: all 0.2s; 
            flex-shrink: 0; 
        }
        
        .voice-btn:hover { 
            background: var(--hover); 
            border-color: var(--accent); 
        }
        
        .voice-btn.recording { 
            background: linear-gradient(135deg, var(--error), #dc2626); 
            color: white; 
            border-color: var(--error); 
            animation: pulse-ring 1s infinite; 
        }
        
        .persona-selector { 
            display: none; 
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px); 
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px); 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            gap: clamp(6px, 1.5vw, 10px); 
        }
        
        .persona-selector.active { 
            display: flex; 
            animation: fadeIn 0.3s ease; 
        }
        
        .persona-selector select { 
            flex: 1; 
            background: var(--input-bg); 
            color: var(--text); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 6px 10px; 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
        }
        
        .image-indicator { 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            border: 1px solid var(--accent); 
            border-radius: 8px; 
            padding: 4px 8px; 
            font-size: clamp(0.7rem, 1.5vw, 0.8rem); 
            color: var(--text-secondary); 
            display: none; 
            align-items: center; 
            gap: 4px; 
            margin-left: 8px; 
            max-width: 120px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .image-indicator.active { 
            display: flex; 
        }
        
        .token-counter-display { 
            font-size: clamp(0.6rem, 1.5vw, 0.7rem); 
            color: var(--text-secondary); 
            margin-top: 4px; 
            text-align: center; 
        }
        
        .mobile-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(4px); 
            -webkit-backdrop-filter: blur(4px); 
            z-index: 999; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .mobile-overlay.active { 
            display: block; 
            opacity: 1; 
        }
        
        /* ==========================================
           NEW: SEED DISPLAY & INPUT (ТЗ #5)
           ========================================== */
        .seed-display {
            display: none;
            padding: 8px;
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-align: center;
            border-top: 1px solid var(--border);
            background: rgba(99, 102, 241, 0.05);
        }

        .seed-display.active {
            display: block;
        }

        .seed-input-container {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: 8px;
        }

        .seed-input-container.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .seed-input {
            flex: 1;
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: clamp(0.8rem, 1.5vw, 0.85rem);
        }

        /* ТЗ #4: Smart Status Display */
        .smart-status {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
            min-height: 1.2em;
        }

        @media (max-width: 768px) {
            #chat-list, .model-limits {
                scrollbar-width: thin;
                scrollbar-color: var(--border) transparent;
            }
            #chat-list::-webkit-scrollbar, .model-limits::-webkit-scrollbar {
                width: 4px;
            }
            #chat-list::-webkit-scrollbar-thumb, .model-limits::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 2px;
            }
        }
        
        @media (min-width: 769px) { 
            body { flex-direction: row; } 
            main { padding-left: 0; } 
            .mobile-menu-toggle { display: none !important; } 
            .mobile-overlay { display: none !important; } 
        }
        
        @media (max-width: 768px) { 
            body { flex-direction: column; padding-top: 60px; } 
            aside { 
                width: min(320px, 85vw); 
                max-width: 320px; 
                position: fixed; 
                left: -100%; 
                top: 0; 
                bottom: 0; 
                height: 100vh; 
                z-index: 1000; 
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            } 
            aside.visible { left: 0; }
            .mobile-menu-toggle { display: flex; } 
            .mobile-overlay { display: none; } 
            body.sidebar-open .mobile-overlay { display: block; } 
            main { width: 100%; padding-left: 0 !important; } 
            #chat-window { padding: clamp(12px, 3vw, 16px); gap: clamp(12px, 3vw, 16px); } 
            .mode-container { flex-direction: row; overflow-x: auto; gap: 8px; padding-bottom: 4px; } 
            .mode-btn { min-width: 100px; flex-shrink: 0; font-size: clamp(0.75rem, 1.5vw, 0.8rem); } 
            .input-area { padding: clamp(10px, 2vw, 12px); position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, var(--bg) 60%, var(--bg)); z-index: 100; } 
            .input-bar { border-radius: 16px; gap: clamp(4px, 1vw, 6px); padding-left: 36px; } 
            textarea { font-size: clamp(0.9rem, 2vw, 0.95rem); max-height: 100px; } 
            .voice-btn, .send-btn, .stop-btn { width: 40px; height: 40px; font-size: clamp(0.8rem, 2vw, 0.9rem); } 
            .prompt-enhancer-btn { width: 28px; height: 28px; font-size: 0.8rem; } 
            .welcome-msg h2 { font-size: clamp(1.2rem, 4vw, 1.5rem); } 
            .welcome-msg p { font-size: clamp(0.8rem, 2.5vw, 0.9rem); } 
            .token-counter-display { font-size: clamp(0.55rem, 1.5vw, 0.65rem); } 
            .style-selector { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); } 
            .persona-selector { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); } 
            .image-indicator { max-width: 100px; margin-left: 4px; } 
            .aspect-ratio-selector { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); }
            .seed-input-container { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); }
            .camera-controls { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); }
            .style-grid { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); min-height: 100px; }
            .magic-toggle { bottom: 100px; right: 15px; width: 48px; height: 48px; }
        }
        
        @media (max-width: 480px) { 
            .logo { font-size: 1.1rem; margin-bottom: 16px; } 
            .status-panel { padding: 12px; } 
            .section-title { font-size: 0.65rem; } 
            .btn, .mode-btn { min-height: 42px; padding: 8px 10px; } 
            .mode-btn { min-width: 80px; } 
            .voice-btn, .send-btn, .stop-btn { width: 38px; height: 38px; } 
            #thinking { margin: 0 12px 10px; } 
            .style-grid { grid-template-columns: repeat(2, 1fr); height: 90px; }
            .style-card { height: 90px; }
        }
        
        @media (min-width: 1440px) { 
            aside { width: 360px; } 
            #chat-window { padding: 32px 20%; } 
            .input-area { padding: 24px 20%; } 
        }
        
        .swipe-hint { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 4px; 
            transform: translateY(-50%); 
            color: var(--text-secondary); 
            font-size: 0.7rem; 
            writing-mode: vertical-rl; 
            text-orientation: mixed; 
            opacity: 0.6; 
        }
        
        @media (max-width: 768px) { 
            .swipe-hint { display: block; } 
        }

        .lazy-load-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            border: 1px dashed var(--border);
            border-radius: 8px;
            margin: 10px 0;
        }

        .lazy-load-placeholder:hover {
            background: var(--hover);
            border-style: solid;
        }

        /* MOBILE SCROLL OPTIMIZATIONS v3.8 */
        @media (max-width: 768px) {
            #chat-window {
                scroll-behavior: auto !important;
                touch-action: pan-y;
                will-change: scroll-position;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            
            .msg {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                will-change: transform;
            }
        }

        /* ==========================================
           NEW: CODE REFLECTION STATUS (ТЗ #2)
           ========================================== */
        .code-reflection-status {
            margin-top: 8px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success-glow);
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: none;
        }

        .code-reflection-status.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .debug-info {
            margin-top: 8px;
            font-size: 0.6rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* ==========================================
           NEW: SMART PRESETS DISPLAY (ТЗ #2)
           ========================================== */
        .smart-preset-info {
            padding: 4px 8px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--accent-glow);
            border-radius: 6px;
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }
    </style>
</head>
<body>

<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Меню">
    <i class="fas fa-bars"></i>
</button>

<!-- Mobile Overlay -->
<div class="mobile-overlay" onclick="closeSidebar()"></div>

<!-- Magic Button (ТЗ #3) -->
<button class="magic-toggle" id="magic-toggle" onclick="toggleMagicEnhancement()" title="Авто-улучшение запроса">
    <i class="fas fa-magic"></i>
</button>

<!-- Sidebar -->
<aside id="sidebar">
    <div class="logo"><i class="fas fa-terminal"></i> NEXUS ULTRA v3.8</div>
    
    <!-- Theme Selector -->
    <div class="controls-section">
        <div class="section-title">Тема</div>
        <div class="theme-selector">
            <button class="theme-btn active" data-theme="default" onclick="changeTheme('default')">Default</button>
            <button class="theme-btn" data-theme="cyberpunk" onclick="changeTheme('cyberpunk')">Cyberpunk</button>
            <button class="theme-btn" data-theme="ocean" onclick="changeTheme('ocean')">Ocean</button>
            <button class="theme-btn" data-theme="forest" onclick="changeTheme('forest')">Forest</button>
        </div>
    </div>

    <!-- Folder Management -->
    <div class="controls-section">
        <div class="section-title">Папки</div>
        <div id="folders-list"></div>
        <button class="btn" onclick="createFolder()">
            <i class="fas fa-folder-plus"></i> Новая папка
        </button>
    </div>

    <!-- Chat list -->
    <div class="controls-section">
        <div class="section-title">Чаты</div>
        <div class="model-limits" id="chat-list" style="max-height: 150px;"></div>
        <button class="btn" onclick="createChat()">
            <i class="fas fa-plus"></i> Новый чат
        </button>
    </div>

    <div class="status-panel">
        <div class="status-item">
            <span>Статус:</span>
            <span id="connection-status">Оффлайн</span>
            <span id="status-indicator" class="status-indicator"></span>
        </div>
        <div class="status-item">
            <span>Режим:</span>
            <span id="current-mode-display">Нормальный</span>
        </div>
        <div class="status-item">
            <span>Токенов:</span>
            <span id="token-counter">0</span>
        </div>
        <div class="token-counter-display">
            Использовано за сессию: <span id="session-tokens">0</span>
        </div>
    </div>

    <div class="controls-section">
        <div class="section-title">Управление</div>
        <button class="btn" onclick="toggleAutoModel()">
            <i class="fas fa-robot" id="auto-model-icon"></i> <span id="auto-model-text">Вкл авто-выбор</span>
        </button>
        <button class="btn" onclick="toggleHdMode()">
            <i class="fas fa-hd" id="hd-mode-icon"></i> <span id="hd-mode-text">HD Режим</span>
        </button>
        <button class="btn" onclick="toggleMagicEnhancement()">
            <i class="fas fa-magic" id="magic-enhancer-icon"></i> <span id="magic-enhancer-text">Magic: OFF</span>
        </button>
        <button class="btn" onclick="clearChat()">
            <i class="fas fa-trash"></i> Очистить чат
        </button>
        <button class="btn" onclick="exportChat()">
            <i class="fas fa-download"></i> Экспорт чата
        </button>
        <button class="btn" onclick="exportAllData()">
            <i class="fas fa-archive"></i> Скачать всё
        </button>
        <button class="btn" onclick="showCommands()">
            <i class="fas fa-question-circle"></i> Команды
        </button>
    </div>

    <div class="controls-section">
        <div class="section-title">Лимиты моделей <span id="limits-refresh-time"></span></div>
        <div class="model-limits" id="model-limits"></div>
        <button class="btn" onclick="updateAllLimits()" style="margin-top: 8px;">
            <i class="fas fa-sync"></i> Обновить лимиты
        </button>
    </div>

    <div class="controls-section">
        <div class="section-title">Режимы</div>
        <div class="mode-container">
            <div id="mode-normal" class="mode-btn active" onclick="setMode('normal')">
                <i class="fas fa-bolt"></i> Стандарт
            </div>
            <div id="mode-search" class="mode-btn" onclick="setMode('search')">
                <i class="fas fa-search"></i> Поиск
            </div>
            <div id="mode-deep" class="mode-btn" onclick="setMode('deep')">
                <i class="fas fa-brain"></i> Глубокий
            </div>
            <div id="mode-art" class="mode-btn" onclick="setMode('art')">
                <i class="fas fa-palette"></i> Художник
            </div>
        </div>
    </div>

    <div style="margin-top: auto;">
        <div class="section-title">API Key</div>
        <input type="password" id="key" class="key-input" placeholder="sk-or-..." title="Ваш API ключ для доступа к моделям">
        <div id="key-status" style="font-size: 0.7rem; margin-top: 4px; text-align: center;"></div>
        <!-- v3.8: Резервный ключ -->
        <div class="section-title" style="margin-top: 12px;">Резервный API Key</div>
        <input type="password" id="backup-key" class="key-input" placeholder="sk-or-..." title="Резервный API ключ для бесшовной ротации">
    </div>
</aside>

<!-- Swipe hint -->
<div class="swipe-hint">
    <i class="fas fa-chevron-right"></i> Свайп
</div>

<main>
    <div id="chat-window" role="log">
        <div class="welcome-msg">
            <h2>🚀 Nexus Ultra v3.8</h2>
            <p>Введите API ключ и система автоматически выберет лучшую модель</p>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                <i class="fas fa-info-circle"></i> 22 модели | Face Restoration | High-Res Fix | Smart Prompt Refiner | Self-Reflection Loop | Visual Style Selector | Magic Button | Умные пресеты | Сид-контроль | Аспект-ратио
            </p>
        </div>
    </div>

    <div class="search-indicator" id="search-indicator">
        <i class="fas fa-search"></i>
        <span id="search-text">Поиск в интернете...</span>
    </div>

    <div id="thinking" role="status">
        <div class="thinking-content">
            <div class="pulse"></div>
            <span id="thinking-text">Анализ...</span>
        </div>
        <!-- ТЗ #4: Умные статусы -->
        <div class="smart-status" id="smart-status"></div>
        <!-- ТЗ #2: Статус самопроверки кода -->
        <div class="code-reflection-status" id="code-reflection-status"></div>
    </div>

    <!-- Seed Input Container (ТЗ #5) -->
    <div class="seed-input-container" id="seed-input-container">
        <input type="text" class="seed-input" id="seed-input" placeholder="Введите seed или оставьте пустым для случайного">
        <button class="btn" onclick="loadSeedFromHistory()" style="min-width: 80px; margin: 0;">
            <i class="fas fa-history"></i>
        </button>
    </div>

    <!-- Persona Selector -->
    <div class="persona-selector" id="persona-selector">
        <select id="persona-select" onchange="changePersona(this.value)">
            <option value="">Без персоны</option>
            <option value="coder">💻 Expert Coder</option>
            <option value="writer">✍️ Creative Writer</option>
            <option value="vision">🎨 Nexus Vision</option>
        </select>
    </div>

    <!-- Style Grid (ТЗ #3) -->
    <div class="style-grid" id="style-grid">
        <div class="style-card" data-style="realistic" onclick="selectStyle('realistic')" title="Realistic: Фотореализм, 8K">
            <i class="fas fa-camera"></i>
            <span>Realistic</span>
        </div>
        <div class="style-card" data-style="anime" onclick="selectStyle('anime')" title="Anime: Аниме стиль">
            <i class="fas fa-dragon"></i>
            <span>Anime</span>
        </div>
        <div class="style-card" data-style="cyberpunk" onclick="selectStyle('cyberpunk')" title="Cyberpunk: Неон, дождь">
            <i class="fas fa-city"></i>
            <span>Cyberpunk</span>
        </div>
        <div class="style-card" data-style="oil_painting" onclick="selectStyle('oil_painting')" title="Oil: Масляная живопись">
            <i class="fas fa-palette"></i>
            <span>Oil Paint</span>
        </div>
        <div class="style-card active" data-style="ghibli" onclick="selectStyle('ghibli')" title="Ghibli: Студия Гибли">
            <i class="fas fa-leaf"></i>
            <span>Ghibli</span>
        </div>
        <div class="style-card" data-style="sketch" onclick="selectStyle('sketch')" title="Sketch: Карандашный эскиз">
            <i class="fas fa-pencil"></i>
            <span>Sketch</span>
        </div>
    </div>

    <!-- Aspect Ratio Selector (ТЗ #4) -->
    <div class="aspect-ratio-selector" id="aspect-ratio-selector">
        <button class="aspect-btn" data-ratio="1:1" onclick="setAspectRatio('1:1')" title="Квадрат">
            <i class="fas fa-square"></i> 1:1
        </button>
        <button class="aspect-btn active" data-ratio="16:9" onclick="setAspectRatio('16:9')" title="Кино/Пейзаж">
            <i class="fas fa-rectangle-wide"></i> 16:9
        </button>
        <button class="aspect-btn" data-ratio="9:16" onclick="setAspectRatio('9:16')" title="Портрет/Story">
            <i class="fas fa-rectangle-portrait"></i> 9:16
        </button>
        <button class="aspect-btn" data-ratio="21:9" onclick="setAspectRatio('21:9')" title="Ультраширокий">
            <i class="fas fa-rectangle-wide"></i> 21:9
        </button>
    </div>

    <!-- Camera Controls (ТЗ #3) -->
    <div class="camera-controls" id="camera-controls">
        <button class="camera-btn" data-angle="close" onclick="setCameraAngle('close')" title="Крупный план">
            <i class="fas fa-search-plus"></i> Крупный
        </button>
        <button class="camera-btn active" data-angle="wide" onclick="setCameraAngle('wide')" title="Общий план">
            <i class="fas fa-search-minus"></i> Общий
        </button>
        <button class="camera-btn" data-angle="low" onclick="setCameraAngle('low')" title="Кино-ракурс">
            <i class="fas fa-video"></i> Кино-ракурс
        </button>
    </div>

    <div class="input-area">
        <div class="input-bar">
            <button class="prompt-enhancer-btn" onclick="enhancePrompt()" title="Улучшить промпт">
                <i class="fas fa-magic"></i>
            </button>

            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <button class="voice-btn" onclick="document.getElementById('image-upload').click()" title="Загрузить изображение">
                <i class="fas fa-image"></i>
            </button>
            
            <textarea id="u-in" placeholder="Введите сообщение..."></textarea>
            
            <div class="image-indicator" id="image-indicator">
                <i class="fas fa-image"></i> <span id="image-name">Файр загружен</span>
            </div>
            
            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceRecording()" title="Голосовой ввод">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button class="send-btn" onclick="send()"><i class="fas fa-paper-plane"></i></button>
            <button class="stop-btn" onclick="stopGeneration()"><i class="fas fa-stop"></i></button>
        </div>
    </div>
</main>

<script>
    // ==========================================
    // THEME MANAGEMENT
    // ==========================================
    function changeTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('nexus_theme', theme);
        
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
    }

    // ==========================================
    // SIDEBAR TOGGLE FOR MOBILE
    // ==========================================
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.mobile-overlay');
        const isOpen = sidebar.classList.contains('visible');
        
        if (isOpen) {
            closeSidebar();
        } else {
            sidebar.classList.add('visible');
            overlay.classList.add('active');
            document.body.classList.add('sidebar-open');
        }
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.mobile-overlay');
        sidebar.classList.remove('visible');
        overlay.classList.remove('active');
        document.body.classList.remove('sidebar-open');
    }

    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        const screenWidth = window.innerWidth;
        const swipeDistance = touchEndX - touchStartX;
        
        if (swipeDistance > 50 && touchStartX < 20) {
            toggleSidebar();
        }
        
        if (swipeDistance < -50 && touchStartX > screenWidth - 20) {
            closeSidebar();
        }
    }

    // ==========================================
    // FOLDER SYSTEM
    // ==========================================
    let folders = {};
    let currentFolderId = null;

    function createFolder(name = null) {
        const id = 'folder_' + Date.now();
        const folderName = name || prompt('📁 Название папки:') || `Папка ${Object.keys(folders).length + 1}`;
        
        folders[id] = {
            id: id,
            name: folderName,
            chatIds: [],
            collapsed: false
        };
        
        saveFolders();
        updateFoldersList();
        updateChatList();
        
        return id;
    }

    function deleteFolder(folderId) {
        if (!confirm(`❓ Удалить папку "${folders[folderId].name}" и все чаты в ней?`)) return;
        
        folders[folderId].chatIds.forEach(chatId => {
            if (chats[chatId]) {
                delete chats[chatId];
            }
        });
        
        delete folders[folderId];
        
        if (currentFolderId === folderId) {
            currentFolderId = null;
        }
        
        saveFolders();
        saveChats();
        updateFoldersList();
        updateChatList();
    }

    function toggleFolder(folderId) {
        folders[folderId].collapsed = !folders[folderId].collapsed;
        saveFolders();
        updateFoldersList();
    }

    function moveChatToFolder(chatId, folderId) {
        Object.values(folders).forEach(folder => {
            folder.chatIds = folder.chatIds.filter(id => id !== chatId);
        });
        
        if (folderId && folders[folderId]) {
            folders[folderId].chatIds.push(chatId);
        }
        
        saveFolders();
        updateFoldersList();
        updateChatList();
    }

    function updateFoldersList() {
        const container = document.getElementById('folders-list');
        container.innerHTML = '';
        
        const rootItem = document.createElement('div');
        rootItem.className = 'folder-item';
        rootItem.innerHTML = `
            <div class="folder-header" onclick="selectFolder(null)">
                <span><i class="fas fa-home"></i> Корневая</span>
                <span style="font-size: 0.7rem;">${Object.values(chats).filter(c => !c.folderId).length}</span>
            </div>
        `;
        rootItem.style.opacity = currentFolderId === null ? '1' : '0.6';
        container.appendChild(rootItem);
        
        Object.values(folders).forEach(folder => {
            const item = document.createElement('div');
            item.className = 'folder-item';
            
            const chatCount = folder.chatIds.filter(id => chats[id]).length;
            item.innerHTML = `
                <div class="folder-header" onclick="toggleFolder('${folder.id}')">
                    <span><i class="fas fa-folder"></i> ${folder.name}</span>
                    <span style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-size: 0.7rem;">${chatCount}</span>
                        <button class="chat-delete" onclick="event.stopPropagation(); deleteFolder('${folder.id}')" style="width: 20px; height: 20px; border-radius: 4px; background: var(--error); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                </div>
                <div class="folder-content ${folder.collapsed ? '' : 'active'}" id="folder-${folder.id}">
                    ${folder.collapsed ? '' : `<small style="color: var(--text-secondary);">Перетащите чаты сюда</small>`}
                </div>
            `;
            
            container.appendChild(item);
        });
    }

    function selectFolder(folderId) {
        currentFolderId = folderId;
        updateFoldersList();
        updateChatList();
    }

    // ==========================================
    // MAGIC TOGGLE (ТЗ #3)
    // ==========================================
    let magicEnhancementEnabled = false;

    function toggleMagicEnhancement() {
        magicEnhancementEnabled = !magicEnhancementEnabled;
        const btn = document.getElementById('magic-toggle');
        const icon = document.getElementById('magic-enhancer-icon');
        const text = document.getElementById('magic-enhancer-text');
        
        btn.classList.toggle('active', magicEnhancementEnabled);
        
        if (magicEnhancementEnabled) {
            icon.style.color = 'var(--success)';
            text.textContent = 'Magic: ON';
        } else {
            icon.style.color = 'var(--text-secondary)';
            text.textContent = 'Magic: OFF';
        }
        
        localStorage.setItem('nexus_magic_enhancement', magicEnhancementEnabled);
        saveChats();
    }

    // ==========================================
    // PROMPT ENHANCEMENT SYSTEM (v3.8 - Smart Prompt Refiner)
    // ==========================================
    const PROMPT_ENHANCEMENTS = {
        'нарисуй': 'hyper-realistic masterpiece, cinematic lighting, 8k quality, ultra-detailed, professional digital art, trending on ArtStation, sharp focus',
        'изобрази': 'photorealistic rendering, sharp focus, dramatic composition, studio quality, high resolution, lifelike details',
        'создай': 'stunning visual creation, artistic excellence, detailed craftsmanship, premium quality, 8k resolution',
        'опиши': 'comprehensive detailed description, vivid imagery, rich context, thorough analysis, well-structured',
        'напиши': 'creative compelling narrative, engaging storytelling, professional writing style, masterfully crafted',
        'код': 'clean efficient code, best practices, modern programming standards, well-documented, error-free',
        'сделай': 'professional implementation, optimized solution, expert methodology, production-ready',
        'покажи': 'visual demonstration, clear illustration, detailed showcase, step-by-step',
        'объясни': 'thorough explanation, educational clarity, step-by-step breakdown, comprehensive',
        'default': 'professional quality, detailed response, expert analysis, comprehensive answer, masterwork'
    };

    // ТЗ #2: Smart Prompt Refiner - логические ошибки
    const SMART_REFINER_RULES = {
        'черная дыра': {
            prompt: '(pitch black void sphere:1.5), accretion disk, gravitational lensing, scientific accuracy, event horizon, no light escape',
            negative: 'stars in center, glowing sphere, bright center, colorful, rainbow'
        },
        'вода': {
            prompt: 'clear water, realistic fluid dynamics, natural transparency, proper refraction',
            negative: 'solid water, floating cubes, impossible physics'
        },
        'огонь': {
            prompt: 'realistic fire, plasma physics, heat distortion, natural flames',
            negative: 'cold fire, solid fire, ice flames'
        },
        'портрет': {
            prompt: 'professional portrait, detailed facial features, sharp eyes, natural skin texture, proper anatomy',
            negative: 'blurry face, deformed features, extra limbs, bad anatomy'
        }
    };

    function enhancePrompt() {
        const input = document.getElementById('u-in');
        const text = input.value.trim();
        
        if (!text) {
            alert('📝 Сначала введите промпт!');
            return;
        }

        // ТЗ #3: Magic Button - автоматическое улучшение
        if (magicEnhancementEnabled) {
            const refined = smartPromptRefiner(text);
            input.value = refined;
        } else {
            // Легаси ручное улучшение
            const lowerText = text.toLowerCase();
            let enhancement = PROMPT_ENHANCEMENTS.default;
            
            for (let [key, value] of Object.entries(PROMPT_ENHANCEMENTS)) {
                if (lowerText.startsWith(key)) {
                    enhancement = value;
                    break;
                }
            }

            input.value = text + ', ' + enhancement;
        }
        
        autoResize();
        
        const enhancerBtn = document.querySelector('.prompt-enhancer-btn');
        enhancerBtn.style.color = 'var(--success)';
        enhancerBtn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            enhancerBtn.style.color = '';
            enhancerBtn.innerHTML = '<i class="fas fa-magic"></i>';
        }, 1500);
    }

    // ТЗ #2: Smart Prompt Refiner функция
    function smartPromptRefiner(originalPrompt) {
        const lowerPrompt = originalPrompt.toLowerCase();
        let enhancedPrompt = originalPrompt;
        let appliedRules = [];

        // Применяем правила рефайнера
        for (const [trigger, rule] of Object.entries(SMART_REFINER_RULES)) {
            if (lowerPrompt.includes(trigger)) {
                enhancedPrompt = `${enhancedPrompt}, ${rule.prompt}`;
                appliedRules.push(trigger);
            }
        }

        // ТЗ #2: Prompt Expansion для коротких промптов
        const wordCount = originalPrompt.split(/\s+/).length;
        if (wordCount <= 3) {
            enhancedPrompt = `${enhancedPrompt}, 8k resolution, cinematic lighting, masterpiece, highly detailed textures, professional color grading, ultra-detailed`;
        }

        // Добавляем базовые улучшения
        if (!lowerPrompt.includes('quality') && !lowerPrompt.includes('качество')) {
            enhancedPrompt = `${enhancedPrompt}, masterpiece, best quality, ultra detailed`;
        }

        if (!lowerPrompt.includes('light') && !lowerPrompt.includes('lighting') && 
            !lowerPrompt.includes('свет') && !lowerPrompt.includes('освещение')) {
            enhancedPrompt = `${enhancedPrompt}, professional lighting, cinematic`;
        }

        if (!lowerPrompt.includes('4k') && !lowerPrompt.includes('8k') && !lowerPrompt.includes('hd')) {
            enhancedPrompt = `${enhancedPrompt}, 8k, high resolution`;
        }

        // Показываем, что применили
        if (appliedRules.length > 0) {
            const statusEl = document.getElementById('smart-status');
            statusEl.innerHTML = `<div class="smart-preset-info">🧠 Применено: ${appliedRules.join(', ')}</div>`;
            setTimeout(() => {
                const el = document.getElementById('smart-status');
                if (el) el.innerHTML = '';
            }, 3000);
        }

        return enhancedPrompt;
    }

    // ==========================================
    // PERSONA SYSTEM (v3.8 - обновленный Expert Coder)
    // ==========================================
    const PERSONAS = {
        'coder': {
            name: 'Expert Coder',
            systemPrompt: `You are an expert programmer with 25+ years of experience in multiple languages and frameworks.
CORE PRINCIPLES:
1. WRITE CLEAN, EFFICIENT, MODERN CODE - always perform self-reflection and error checking before output
2. USE MATHEMATICAL FUNCTIONS (Math.sin/cos) for animations, NOT linear movements
3. FOLLOW BEST PRACTICES - no const reassignments, proper error handling, DRY principle
4. PROVIDE COMPLETE, RUNNABLE CODE - never leave placeholders or TODO comments
5. DOCUMENT EVERYTHING - comments for complex logic, JSDoc for functions
6. OPTIMIZE PERFORMANCE - analyze time/space complexity, suggest optimizations
7. SECURITY FIRST - sanitize inputs, prevent injection attacks
8. MODERN STANDARDS - use async/await, proper destructuring, ES2023+ features

SELF-REFLECTION PROTOCOL:
- After generating code, scan for: const reassignments, missing semicolons, logical errors, undefined variables
- If errors found, silently correct them before showing to user
- Provide only the final, corrected version

CODE OUTPUT FORMAT:
1. Full, runnable code without placeholders
2. Brief explanation of key decisions
3. Performance analysis (Big O)
4. Security considerations (if applicable)

STRICT RULE: NEVER output code with obvious errors. Always self-check first.`,
            icon: '💻'
        },
        'writer': {
            name: 'Creative Writer',
            systemPrompt: 'You are a creative writing assistant with exceptional storytelling skills. Help users craft compelling narratives, poetry, articles, and creative content. Focus on style, tone, emotional impact, and originality.',
            icon: '✍️'
        },
        'vision': {
            name: 'Nexus Vision',
            systemPrompt: 'You are Nexus Vision, an AI specialized in image generation and visual analysis. Always append /img to requests for visual content. Provide detailed visual descriptions and artistic guidance.',
            icon: '🎨'
        }
    };

    let currentPersona = null;

    function changePersona(personaId) {
        currentPersona = personaId || null;
        localStorage.setItem('nexus_persona', currentPersona || '');
        
        const selector = document.getElementById('persona-select');
        if (personaId) {
            selector.style.borderColor = 'var(--accent)';
            selector.style.boxShadow = '0 0 8px var(--accent-glow)';
        } else {
            selector.style.borderColor = 'var(--border)';
            selector.style.boxShadow = '';
        }
    }

    // ==========================================
    // ART ASSISTANT FEATURES (v3.8 - Visual Style Selector)
    // ==========================================
    const STYLES_DB = {
        'oil_painting': {
            name: 'Масло (Рембрандт)',
            prompt: 'Professional oil painting style, classical realism, rich textures, Rembrandt lighting, masterpiece quality, detailed brushwork'
        },
        'watercolor': {
            name: 'Акварель (Импрессионизм)',
            prompt: 'Beautiful watercolor technique, soft washes, translucent layers, impressionistic style, fluid and expressive'
        },
        'cyberpunk': {
            name: 'Киберпанк',
            prompt: 'Cyberpunk aesthetic, neon lights, rain-slicked streets, Blade Runner style, dystopian future, high contrast, vivid colors'
        },
        'vangogh': {
            name: 'Ван Гог',
            prompt: 'Van Gogh painting style, bold expressive brushstrokes, vibrant colors, post-impressionist, emotional intensity'
        },
        'ghibli': {
            name: 'Аниме (Гибли)',
            prompt: 'Studio Ghibli anime style, soft pastel colors, detailed backgrounds, whimsical, magical atmosphere, hand-drawn aesthetic'
        },
        'sketch': {
            name: 'Карандашный эскиз',
            prompt: 'Detailed pencil sketch, artistic line art, professional shading, cross-hatching, monochromatic mastery'
        }
    };

    // IMAGE GENERATION STYLES (обновлен для v3.8)
    const IMAGE_STYLES = {
        'anime': 'Anime style, manga illustration, detailed anime artwork, expressive characters',
        'realistic': 'Photorealistic, hyperrealism, 8k ultra realistic, detailed textures',
        'oil': 'Oil painting style, art gallery quality, impasto technique, master painter',
        'watercolor': 'Watercolor painting, soft washes, artistic, translucent',
        'sketch': 'Pencil sketch, line art, monochromatic, professional drawing',
        'cyberpunk': 'Cyberpunk aesthetic, neon lights, dystopian, rain-slicked streets',
        'fantasy': 'Fantasy art, magical atmosphere, epic fantasy, mystical',
        'abstract': 'Abstract art, conceptual, modern art, geometric',
        'portrait': 'Professional portrait, studio lighting, detailed face',
        'landscape': 'Epic landscape, cinematic lighting, wide angle',
        'ghibli': 'Studio Ghibli anime style, soft pastel colors, whimsical, hand-drawn aesthetic'
    };

    // ==========================================
    // v3.8: Face Restoration & High-Res Fix
    // ==========================================
    let faceRestorationEnabled = true; // Включено по умолчанию
    let highResFixEnabled = true; // Включено по умолчанию

    // Проверяем, нужно ли применить face restoration
    function needsFaceRestoration(prompt) {
        const lower = prompt.toLowerCase();
        return lower.includes('портрет') || lower.includes('лицо') || 
               lower.includes('face') || lower.includes('portrait') ||
               lower.includes('человек') || lower.includes('person') ||
               lower.includes('девушка') || lower.includes('мальчик') ||
               lower.includes('girl') || lower.includes('boy') ||
               lower.includes('модель') || lower.includes('model');
    }

    // Апскейл размеров для High-Res Fix
    function calculateHighResSize(width, height) {
        const scale = 1.5 + (Math.random() * 0.5); // 1.5-2.0x
        return {
            width: Math.round(width * scale),
            height: Math.round(height * scale)
        };
    }

    // ==========================================
    // v3.7: Smart Presets
    // ==========================================
    const SMART_PRESETS = {
        'cinematic': {
            keywords: ['cinematic', 'кинематографично', 'кино', 'film'],
            prompt: '(masterpiece, cinematic lighting, 8k, highly detailed, shot on 35mm lens, depth of field)'
        },
        'portrait': {
            keywords: ['portrait', 'портрет'],
            prompt: '(professional portrait, sharp focus, detailed face, studio lighting, 85mm lens)'
        },
        'landscape': {
            keywords: ['landscape', 'пейзаж', 'scenery'],
            prompt: '(breathtaking landscape, epic scenery, wide angle, atmospheric, 16mm lens)'
        }
    };

    // ==========================================
    // v3.7: Camera Angles Dictionary
    // ==========================================
    const CAMERA_ANGLES = {
        'close': 'close-up shot, facial detail, shallow depth of field, focused on face, portrait orientation',
        'wide': 'wide angle shot, full body, landscape view, environmental composition, full body portrait',
        'low': 'low angle shot, epic perspective, heroic composition, dramatic viewpoint, cinematic angle'
    };

    let currentCameraAngle = 'wide';

    function setCameraAngle(angle) {
        currentCameraAngle = angle;
        document.querySelectorAll('.camera-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.angle === angle);
        });
        localStorage.setItem('nexus_camera_angle', angle);
    }

    // ==========================================
    // v3.8: Style Grid Selection
    // ==========================================
    function selectStyle(styleKey) {
        currentImageStyle = styleKey;
        document.querySelectorAll('.style-card').forEach(card => {
            card.classList.toggle('active', card.dataset.style === styleKey);
        });
        localStorage.setItem('nexus_image_style', styleKey);
        
        // Показываем превью пресета
        const styleInfo = STYLES_DB[styleKey] || IMAGE_STYLES[styleKey];
        if (styleInfo) {
            const statusEl = document.getElementById('smart-status');
            statusEl.innerHTML = `<div class="smart-preset-info">🎨 Стиль: ${styleInfo.name || styleKey}</div>`;
            setTimeout(() => {
                const el = document.getElementById('smart-status');
                if (el) el.innerHTML = '';
            }, 2000);
        }
    }

    // ==========================================
    // v3.7: Enhanced Negative Prompts with Anatomy Filter
    // ==========================================
    const NEGATIVE_PROMPTS = 'lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry, extra limbs, fused fingers, mutated hands, missing fingers, two heads, hands instead of feet, logo on shoulder instead of chest';
    
    const ANATOMY_FILTER = 'extra limbs, fused fingers, mutated hands, missing fingers, two heads, hands instead of feet, logo on shoulder instead of chest';

    function enhanceImagePrompt(originalPrompt) {
        const lowerPrompt = originalPrompt.toLowerCase();
        let enhancements = [];
        
        // ТЗ #2: Prompt Expansion for short prompts
        const wordCount = originalPrompt.split(/\s+/).length;
        if (wordCount <= 3) {
            enhancements.push('8k resolution, cinematic lighting, masterpiece, highly detailed textures, professional color grading, ultra-detailed');
        }
        
        if (!lowerPrompt.includes('quality') && !lowerPrompt.includes('качество')) {
            enhancements.push('masterpiece, best quality, ultra detailed');
        }
        
        if (!lowerPrompt.includes('light') && !lowerPrompt.includes('lighting') && 
            !lowerPrompt.includes('свет') && !lowerPrompt.includes('освещение')) {
            enhancements.push('professional lighting, cinematic');
        }
        
        if (!lowerPrompt.includes('4k') && !lowerPrompt.includes('8k') && !lowerPrompt.includes('hd')) {
            enhancements.push('8k, high resolution');
        }
        
        if (lowerPrompt.includes('портрет') || lowerPrompt.includes('portrait')) {
            enhancements.push('professional portrait, detailed face, sharp focus, proper anatomy');
        }
        if (lowerPrompt.includes('пейзаж') || lowerPrompt.includes('landscape')) {
            enhancements.push('breathtaking landscape, epic scenery, atmospheric');
        }
        if (lowerPrompt.includes('кот') || lowerPrompt.includes('собака') || lowerPrompt.includes('животное')) {
            enhancements.push('cute, detailed fur, expressive eyes');
        }
        
        // ТЗ #3: Smart Presets
        for (const [style, config] of Object.entries(SMART_PRESETS)) {
            if (config.keywords.some(keyword => lowerPrompt.includes(keyword))) {
                enhancements.push(config.prompt);
                break;
            }
        }
        
        const basePrompt = originalPrompt.trim();
        const uniqueEnhancements = [...new Set(enhancements)];
        
        return uniqueEnhancements.length > 0 
            ? `${basePrompt}, ${uniqueEnhancements.join(', ')}` 
            : basePrompt;
    }

    // ==========================================
    // 22 MODELS ARRAY for v3.8
    // ==========================================
    const FALLBACK_MODELS = [
        'deepseek/deepseek-chat:free',
        'meta-llama/llama-3.3-70b-instruct:free',
        'google/gemini-flash-1.5:free',
        'qwen/qwen-2.5-72b-instruct:free',
        'anthropic/claude-3-haiku-20240307',
        'anthropic/claude-3.5-haiku-20241022:free',
        'meta-llama/llama-3.1-70b-instruct:free',
        'mistralai/mistral-large-2411:free',
        'mistralai/mistral-7b-instruct:free',
        'meta-llama/llama-3.1-8b-instruct:free',
        'cohere/command-r:free',
        'openchat/openchat-7b:free',
        'gryphe/mythomist-7b:free',
        'nousresearch/nous-hermes-2-mixtral-8x7b-dpo:free',
        'microsoft/phi-3-medium-128k-instruct:free',
        'jondurbin/airoboros-l2-70b:free',
        'gryphe/mythomax-l2-13b:free',
        'huggingfaceh4/zephyr-7b-beta:free',
        'undi95/toppy-m-7b:free',
        'lizpreciatel/lzlv-70b-fp16-hf:free',
        '01-ai/yi-34b-chat:free',
        'cognitivecomputations/dolphin-mixtral-8x7b:free'
    ];

    // ==========================================
    // v3.8: Seamless Rotation System
    // ==========================================
    const BACKUP_KEYS = [];
    let currentKeyIndex = 0;
    let isUsingBackupKey = false;

    function loadBackupKeys() {
        const saved = localStorage.getItem('nexus_backup_keys');
        if (saved) {
            BACKUP_KEYS.push(...JSON.parse(saved));
        }
        const backupKeyInput = document.getElementById('backup-key');
        if (backupKeyInput.value) {
            const newKeys = backupKeyInput.value.split(',').map(k => k.trim()).filter(k => k);
            BACKUP_KEYS.push(...newKeys);
            localStorage.setItem('nexus_backup_keys', JSON.stringify(BACKUP_KEYS));
        }
    }

    // ==========================================
    // ENHANCED MODELS (25+ MODELS)
    // ==========================================
    const CONFIG = {
        MAX_HISTORY_LEN: 50,
        TYPING_SPEED: 30,
        MODELS: [
            /* TOP TIER - MOST RELIABLE */
            { id: 'deepseek/deepseek-chat:free', name: 'DeepSeek Chat', free: true, vision: false, reliable: true, tier: 'S' },
            { id: 'meta-llama/llama-3.3-70b-instruct:free', name: 'Llama 3.3 70B', free: true, vision: false, reliable: true, tier: 'S' },
            { id: 'google/gemini-flash-1.5:free', name: 'Gemini Flash', free: true, vision: true, reliable: true, tier: 'S' },
            { id: 'qwen/qwen-2.5-72b-instruct:free', name: 'Qwen 2.5 72B', free: true, vision: false, reliable: true, tier: 'S' },
            { id: 'anthropic/claude-3-haiku-20240307', name: 'Claude 3 Haiku', free: true, vision: false, reliable: true, tier: 'S' },
            /* EMERGENCY BACKUP - CLASSIC RELIABLE */
            { id: 'anthropic/claude-3.5-haiku-20241022:free', name: 'Claude 3.5 Haiku', free: true, vision: false, reliable: true, tier: 'A' },
            { id: 'meta-llama/llama-3.1-70b-instruct:free', name: 'Llama 3.1 70B', free: true, vision: false, reliable: true, tier: 'A' },
            { id: 'mistralai/mistral-large-2411:free', name: 'Mistral Large', free: true, vision: false, reliable: true, tier: 'A' },
            /* GOOD TIER */
            { id: 'mistralai/mistral-7b-instruct:free', name: 'Mistral 7B', free: true, vision: false, reliable: false, tier: 'B' },
            { id: 'meta-llama/llama-3.1-8b-instruct:free', name: 'Llama 3.1 8B', free: true, vision: false, reliable: false, tier: 'B' },
            { id: 'cohere/command-r:free', name: 'Command R', free: true, vision: false, reliable: false, tier: 'B' },
            /* MEDIUM TIER - EXPERIMENTAL */
            { id: 'openchat/openchat-7b:free', name: 'OpenChat 7B', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'gryphe/mythomist-7b:free', name: 'MythoMist 7B', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'nousresearch/nous-hermes-2-mixtral-8x7b-dpo:free', name: 'Nous Hermes', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'microsoft/phi-3-medium-128k-instruct:free', name: 'Phi-3 Medium', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'jondurbin/airoboros-l2-70b:free', name: 'Airoboros 70B', free: true, vision: false, reliable: false, tier: 'C' },
            /* FALLBACK TIER - LAST RESORT */
            { id: 'gryphe/mythomax-l2-13b:free', name: 'MythoMax 13B', free: true, vision: false, reliable: false, tier: 'D' },
            { id: 'huggingfaceh4/zephyr-7b-beta:free', name: 'Zephyr 7B', free: true, vision: false, reliable: false, tier: 'D' },
            { id: 'undi95/toppy-m-7b:free', name: 'Toppy 7B', free: true, vision: false, reliable: false, tier: 'D' },
            { id: 'lizpreciatel/lzlv-70b-fp16-hf:free', name: 'LZLV 70B', free: true, vision: false, reliable: false, tier: 'D' },
            /* ULTRA EMERGENCY - ALWAYS AVAILABLE */
            { id: '01-ai/yi-34b-chat:free', name: 'Yi 34B', free: true, vision: false, reliable: true, tier: 'EMG' },
            { id: 'cognitivecomputations/dolphin-mixtral-8x7b:free', name: 'Dolphin Mixtral', free: true, vision: false, reliable: true, tier: 'EMG' },
            { id: 'rwkv/rwkv-5-world-7b:free', name: 'RWKV 7B', free: true, vision: false, reliable: true, tier: 'EMG' },
            /* TESTING ZONE */
            { id: 'google/gemini-flash-1.5-8b-exp', name: 'Gemini Flash 8B', free: true, vision: true, reliable: false, tier: 'TEST' }
        ]
    };

    // ==========================================
    // ENHANCED CHAT SYSTEM
    // ==========================================
    let chats = {};
    let currentChatId = null;
    let currentMode = 'normal';
    let autoModelEnabled = false;
    let modelLimits = {};
    let abortController = null;
    let uploadedImage = null;
    let sessionTokenCount = 0;
    let limitsCache = { data: null, timestamp: 0 };
    let history = [];
    let currentImageStyle = 'ghibli'; // Изменено по умолчанию
    let isEmergencyMode = false;
    let hdModeEnabled = false;
    let lastLimitUpdate = 0;
    let messagesLoaded = 20;
    let maxMessagesToShow = 20;

    // ==========================================
    // MAP для стилей грида
    // ==========================================
    const STYLE_GRID_MAP = {
        'realistic': { name: 'Realistic', icon: 'fa-camera' },
        'anime': { name: 'Anime', icon: 'fa-dragon' },
        'cyberpunk': { name: 'Cyberpunk', icon: 'fa-city' },
        'oil_painting': { name: 'Oil Paint', icon: 'fa-palette' },
        'ghibli': { name: 'Ghibli', icon: 'fa-leaf' },
        'sketch': { name: 'Sketch', icon: 'fa-pencil' }
    };

    // ==========================================
    // NEW: ASPECT RATIO SYSTEM (ТЗ #4)
    // ==========================================
    let currentAspectRatio = '16:9';

    function setAspectRatio(ratio) {
        currentAspectRatio = ratio;
        document.querySelectorAll('.aspect-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.ratio === ratio);
        });
        localStorage.setItem('nexus_aspect_ratio', ratio);
    }

    // ==========================================
    // NEW: SEED MANAGEMENT (ТЗ #5)
    // ==========================================
    let currentSeed = null;
    let imageHistory = []; // Store image seeds for reuse

    function saveSeed(seed, prompt, url) {
        imageHistory.unshift({
            seed: seed,
            prompt: prompt,
            url: url,
            timestamp: Date.now(),
            aspectRatio: currentAspectRatio,
            style: currentImageStyle,
            cameraAngle: currentCameraAngle
        });
        
        // Keep only last 10 images
        if (imageHistory.length > 10) {
            imageHistory = imageHistory.slice(0, 10);
        }
        
        localStorage.setItem('nexus_image_seeds', JSON.stringify(imageHistory));
    }

    function loadSeedFromHistory() {
        if (imageHistory.length === 0) {
            alert('📷 История изображений пуста. Сгенерируйте изображение сначала.');
            return;
        }

        const historyHtml = imageHistory.map((img, i) => 
            `<div style="margin: 8px 0; padding: 8px; background: var(--panel-2); border-radius: 8px; cursor: pointer;" onclick="useSeed('${img.seed}')">
                <img src="${img.url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 8px;">
                <span style="font-size: 0.7rem;">${img.prompt.substring(0, 30)}...</span>
                <br><small style="color: var(--text-secondary);">Seed: ${img.seed} | ${img.style} | ${img.aspectRatio}</small>
            </div>`
        ).join('');

        const modal = document.createElement('div');
        modal.className = 'image-modal';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        modal.innerHTML = `
            <div style="background: var(--panel); padding: 20px; border-radius: 12px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                <h3 style="margin-top: 0;">📷 История генераций</h3>
                ${historyHtml}
                <button class="btn" onclick="this.parentNode.parentNode.remove()" style="margin-top: 12px; width: 100%;">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function useSeed(seed) {
        document.getElementById('seed-input').value = seed;
        currentSeed = seed;
        document.querySelector('.image-modal')?.remove();
        alert(`✅ Seed ${seed} загружен. Следующая генерация использует это зерно.`);
        
        // Показать индикатор в UI
        const seedContainer = document.getElementById('seed-input-container');
        seedContainer.style.borderColor = 'var(--success)';
        seedContainer.style.boxShadow = '0 0 8px var(--success-glow)';
        setTimeout(() => {
            seedContainer.style.borderColor = 'var(--border)';
            seedContainer.style.boxShadow = '';
        }, 2000);
    }

    // ==========================================
    // CHAT MANAGEMENT WITH FOLDERS
    // ==========================================
    function createChat(title = null) {
        const id = 'chat_' + Date.now();
        const chatTitle = title || `Чат ${Object.keys(chats).length + 1}`;
        
        chats[id] = {
            id: id,
            title: chatTitle,
            history: [],
            sessionTokenCount: 0,
            createdAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            folderId: currentFolderId
        };
        
        switchChat(id);
        saveChats();
        updateChatList();
        
        document.getElementById('chat-window').innerHTML = `
            <div class="welcome-msg">
                <h2>🚀 ${chatTitle}</h2>
                <p>Начните новую беседу</p>
            </div>
        `;
        
        return id;
    }

    function switchChat(chatId) {
        if (!chats[chatId]) return;
        
        currentChatId = chatId;
        const chat = chats[chatId];
        
        history = [...chat.history];
        sessionTokenCount = chat.sessionTokenCount || 0;
        uploadedImage = null;
        document.getElementById('image-indicator').classList.remove('active');
        
        messagesLoaded = Math.min(maxMessagesToShow, history.length);
        
        renderChatHistory();
        updateChatList();
        saveChats();
        
        if (window.innerWidth <= 768) {
            setTimeout(closeSidebar, 300);
        }
    }

    function deleteChat(chatId) {
        const chat = chats[chatId];
        const isInFolder = chat.folderId;
        const targetCount = isInFolder ? 
            (folders[chat.folderId]?.chatIds.filter(id => chats[id]).length || 0) :
            Object.values(chats).filter(c => !c.folderId).length;
        
        if (targetCount <= 1) {
            alert('⚠️ Нельзя удалить последний чат в этой папке!');
            return;
        }
        
        if (!confirm(`❓ Удалить чат "${chat.title}"?`)) return;
        
        if (chat.folderId && folders[chat.folderId]) {
            folders[chat.folderId].chatIds = folders[chat.folderId].chatIds.filter(id => id !== chatId);
        }
        
        delete chats[chatId];
        
        if (currentChatId === chatId) {
            const firstChatId = Object.keys(chats)[0];
            switchChat(firstChatId);
        }
        
        saveChats();
        saveFolders();
        updateChatList();
    }

    function updateChatList() {
        const container = document.getElementById('chat-list');
        container.innerHTML = '';
        
        const filteredChats = Object.values(chats).filter(chat => 
            currentFolderId === null ? !chat.folderId : chat.folderId === currentFolderId
        );
        
        filteredChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated)).forEach(chat => {
            const item = document.createElement('div');
            item.className = 'model-limit-item' + (chat.id === currentChatId ? ' best' : '');
            item.style.cursor = 'pointer';
            item.draggable = true;
            item.dataset.chatId = chat.id;
            
            const messageCount = chat.history.filter(h => h.role === 'user').length;
            
            item.innerHTML = `
                <div class="model-name" onclick="switchChat('${chat.id}')" style="flex: 1;">
                    <i class="fas fa-comments"></i> ${chat.title}
                    <div style="font-size: 0.6rem; color: var(--text-secondary);">${messageCount} сообщений</div>
                </div>
                <button class="chat-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')" style="width: 24px; height: 24px; border-radius: 6px; background: var(--error); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                        <i class="fas fa-times"></i>
                </button>
            `;
            
            item.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', chat.id);
            };
            
            container.appendChild(item);
        });
        
        Object.values(folders).forEach(folder => {
            const folderContent = document.getElementById(`folder-${folder.id}`);
            if (folderContent) {
                folderContent.ondrop = (e) => {
                    e.preventDefault();
                    const chatId = e.dataTransfer.getData('text/plain');
                    moveChatToFolder(chatId, folder.id);
                };
                
                folderContent.ondragover = (e) => {
                    e.preventDefault();
                    folderContent.style.background = 'var(--hover)';
                };
                
                folderContent.ondragleave = () => {
                    folderContent.style.background = '';
                };
            }
        });
    }

    function renderChatHistory() {
        const container = document.getElementById('chat-window');
        
        if (history.length === 0) {
            const chat = chats[currentChatId];
            container.innerHTML = `
                <div class="welcome-msg">
                    <h2>🚀 ${chat.title}</h2>
                    <p>Начните новую беседу</p>
                </div>
            `;
            return;
        }
        
        const messagesToShow = history.slice(-messagesLoaded);
        container.innerHTML = '';
        
        messagesToShow.forEach(msg => {
            if (msg.type === 'image') {
                addImageToChat(msg.content, false);
            } else {
                addMsg(msg.role, msg.content, false);
            }
        });
        
        if (messagesLoaded < history.length) {
            const loadMoreBtn = document.createElement('div');
            loadMoreBtn.className = 'lazy-load-placeholder';
            loadMoreBtn.innerHTML = `
                <i class="fas fa-chevron-up"></i> Загрузить ещё ${Math.min(maxMessagesToShow, history.length - messagesLoaded)} сообщений
            `;
            loadMoreBtn.onclick = () => {
                messagesLoaded = Math.min(messagesLoaded + maxMessagesToShow, history.length);
                renderChatHistory();
            };
            container.insertBefore(loadMoreBtn, container.firstChild);
        }
        
        scrollToBottom();
    }

    function scrollToBottom() {
        requestAnimationFrame(() => {
            const chatWindow = document.getElementById('chat-window');
            if (chatWindow) {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        });
    }

    function saveChats() {
        try {
            localStorage.setItem('nexus_chats', JSON.stringify(chats));
            localStorage.setItem('nexus_current_chat', currentChatId);
            localStorage.setItem('nexus_image_style', currentImageStyle);
            localStorage.setItem('nexus_auto_model', autoModelEnabled);
            localStorage.setItem('nexus_hd_mode', hdModeEnabled);
            localStorage.setItem('nexus_magic_enhancement', magicEnhancementEnabled);
            localStorage.setItem('nexus_aspect_ratio', currentAspectRatio);
            localStorage.setItem('nexus_camera_angle', currentCameraAngle);
            localStorage.setItem('nexus_image_seeds', JSON.stringify(imageHistory));
            localStorage.setItem('nexus_persona', currentPersona || '');
        } catch (e) {
            console.warn('Ошибка сохранения в localStorage:', e);
            if (e.name === 'QuotaExceededError') {
                const keys = Object.keys(chats).sort((a, b) => new Date(chats[a].createdAt) - new Date(chats[b].createdAt));
                if (keys.length > 5) {
                    delete chats[keys[0]];
                    localStorage.setItem('nexus_chats', JSON.stringify(chats));
                }
                alert('⚠️ Превышен лимит хранилища. Удалены старые чаты.');
            }
        }
    }

    function saveFolders() {
        localStorage.setItem('nexus_folders', JSON.stringify(folders));
    }

    function loadChats() {
        try {
            const saved = localStorage.getItem('nexus_chats');
            const savedCurrent = localStorage.getItem('nexus_current_chat');
            const savedStyle = localStorage.getItem('nexus_image_style');
            const savedAutoModel = localStorage.getItem('nexus_auto_model');
            const savedHdMode = localStorage.getItem('nexus_hd_mode');
            const savedMagic = localStorage.getItem('nexus_magic_enhancement');
            const savedPersona = localStorage.getItem('nexus_persona');
            const savedTheme = localStorage.getItem('nexus_theme');
            const savedFolders = localStorage.getItem('nexus_folders');
            const savedAspectRatio = localStorage.getItem('nexus_aspect_ratio');
            const savedCameraAngle = localStorage.getItem('nexus_camera_angle');
            const savedSeeds = localStorage.getItem('nexus_image_seeds');
            const savedBackupKeys = localStorage.getItem('nexus_backup_keys');
            
            if (savedFolders) folders = JSON.parse(savedFolders);
            if (savedTheme) changeTheme(savedTheme);
            if (savedAspectRatio) setAspectRatio(savedAspectRatio);
            if (savedCameraAngle) setCameraAngle(savedCameraAngle);
            if (savedSeeds) imageHistory = JSON.parse(savedSeeds);
            if (savedBackupKeys) BACKUP_KEYS.push(...JSON.parse(savedBackupKeys));
            
            if (savedPersona) {
                currentPersona = savedPersona;
                document.getElementById('persona-select').value = savedPersona;
                changePersona(savedPersona);
            }
            
            if (savedStyle) {
                currentImageStyle = savedStyle;
                selectStyle(savedStyle);
            }
            
            if (savedAutoModel !== null) autoModelEnabled = savedAutoModel === 'true';
            if (savedHdMode !== null) hdModeEnabled = savedHdMode === 'true';
            if (savedMagic !== null) {
                magicEnhancementEnabled = savedMagic === 'true';
                if (magicEnhancementEnabled) {
                    document.getElementById('magic-toggle').classList.add('active');
                    document.getElementById('magic-enhancer-icon').style.color = 'var(--success)';
                    document.getElementById('magic-enhancer-text').textContent = 'Magic: ON';
                }
            }
            
            if (saved) {
                chats = JSON.parse(saved);
                
                if (Object.keys(chats).length === 0) {
                    createChat('Стартовый чат');
                } else {
                    const chatId = savedCurrent && chats[savedCurrent] ? savedCurrent : Object.keys(chats)[0];
                    switchChat(chatId);
                }
            } else {
                createChat('Стартовый чат');
            }
            
            if (autoModelEnabled) {
                document.getElementById('auto-model-icon').style.color = 'var(--success)';
                document.getElementById('auto-model-text').textContent = 'Выкл авто-выбор';
            }
            
            if (hdModeEnabled) {
                document.getElementById('hd-mode-icon').style.color = 'var(--success)';
                document.getElementById('hd-mode-text').textContent = 'HD Режим ✓';
            }
            
            updateFoldersList();
        } catch (e) {
            console.error('Ошибка загрузки чатов:', e);
            createChat('Стартовый чат');
        }
    }

    // ==========================================
    // IMAGE GENERATION FUNCTIONS (v3.8)
    // ==========================================
    function generatePollinationsUrl(prompt, style = currentImageStyle, seed = null) {
        // ТЗ #3: Применяем Smart Prompt Refiner если Magic включен
        let finalPrompt = magicEnhancementEnabled ? smartPromptRefiner(prompt) : enhanceImagePrompt(prompt);
        
        // ТЗ #2: Добавляем Negative Prompts
        const isRealistic = ['realistic', 'portrait', 'photorealistic', 'cinematic'].some(k => 
            finalPrompt.toLowerCase().includes(k) || style.toLowerCase().includes(k)
        );
        const negativePrompt = isRealistic ? `${NEGATIVE_PROMPTS}, ${ANATOMY_FILTER}` : NEGATIVE_PROMPTS;
        
        // Добавляем camera angle
        finalPrompt = `${finalPrompt}, ${CAMERA_ANGLES[currentCameraAngle]}`;
        
        // Добавляем стиль
        const stylePrompt = IMAGE_STYLES[style] || '';
        if (stylePrompt) {
            finalPrompt = `${finalPrompt}, ${stylePrompt}`;
        }

        // Кодируем
        const cleanPrompt = finalPrompt.replace(/[^a-zA-Z0-9а-яА-Я\s]/g, '').substring(0, 350);
        const encodedPrompt = encodeURIComponent(cleanPrompt.replace(/\s+/g, '_'));
        const finalSeed = currentSeed || seed || Date.now();
        
        // ТЗ #4: Apply aspect ratio
        const [widthRatio, heightRatio] = currentAspectRatio.split(':').map(Number);
        const maxSize = 1024;
        const ratio = widthRatio / heightRatio;
        
        let widthPx, heightPx;
        if (ratio >= 1) {
            widthPx = maxSize;
            heightPx = Math.round(maxSize / ratio);
        } else {
            heightPx = maxSize;
            widthPx = Math.round(maxSize * ratio);
        }

        // ТЗ #1: High-Res Fix параметры
        if (highResFixEnabled) {
            const highRes = calculateHighResSize(widthPx, heightPx);
            widthPx = highRes.width;
            heightPx = highRes.height;
        }
        
        return `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true&seed=${finalSeed}&width=${widthPx}&height=${heightPx}&enhance=true&model=flux&negative_prompt=${encodeURIComponent(negativePrompt)}`;
    }

    // v3.8: Smart Status Generator
    const SMART_STATUSES = [
        '[Вычисляю анатомию рук...]',
        '[Настраиваю кинематографичный свет...]',
        '[Убираю лишние артефакты...]',
        '[Калибрую цветовую палитру...]',
        '[Оптимизирую композицию...]',
        '[Применяю анатомический фильтр...]',
        '[Стабилизирую seed-генерацию...]',
        '[Рассчитываю ракурс камеры...]',
        '[Обнаруживаю лица...]',
        '[Применяю High-Res Fix...]'
    ];

    let smartStatusInterval = null;

    function startSmartStatus() {
        const statusEl = document.getElementById('smart-status');
        let index = 0;
        
        statusEl.textContent = SMART_STATUSES[0];
        
        smartStatusInterval = setInterval(() => {
            index = (index + 1) % SMART_STATUSES.length;
            statusEl.textContent = SMART_STATUSES[index];
        }, 1500);
    }

    function stopSmartStatus() {
        if (smartStatusInterval) {
            clearInterval(smartStatusInterval);
            smartStatusInterval = null;
        }
        document.getElementById('smart-status').textContent = '';
    }

    async function generateImage(prompt) {
        const container = document.createElement('div');
        container.className = 'msg ai';
        
        // ТЗ #1: Skeleton Screen
        const skeletonDiv = document.createElement('div');
        skeletonDiv.className = 'image-container';
        skeletonDiv.innerHTML = `
            <div class="image-skeleton">
                <i class="fas fa-image-polaroid" style="font-size: 2rem; color: var(--accent);"></i>
                <div>🎨 Улучшаю промпт через Smart Refiner...</div>
            </div>
        `;
        
        container.appendChild(skeletonDiv);
        document.getElementById('chat-window').appendChild(container);
        scrollToBottom();
        
        const enhancedPrompt = magicEnhancementEnabled ? smartPromptRefiner(prompt) : enhanceImagePrompt(prompt);
        
        skeletonDiv.querySelector('.image-skeleton div').textContent = 
            `✨ Создание: "${enhancedPrompt.substring(0, 50)}..."`;
        
        // ТЗ #1: Индикатор Face Restoration
        const showFaceIndicator = needsFaceRestoration(enhancedPrompt);
        if (showFaceIndicator && faceRestorationEnabled) {
            setTimeout(() => {
                const indicator = document.createElement('div');
                indicator.className = 'face-restoration-indicator';
                indicator.innerHTML = '<i class="fas fa-user-check"></i> Face Restore';
                skeletonDiv.appendChild(indicator);
            }, 1000);
        }
        
        const imageUrl = generatePollinationsUrl(enhancedPrompt);
        const usedSeed = currentSeed || Date.now();
        const img = new Image();
        
        img.onload = async () => {
            // ТЗ #1: High-Res Fix - эмулируем двухэтапную генерацию
            if (highResFixEnabled) {
                skeletonDiv.querySelector('.image-skeleton div').textContent = 
                    `🔍 Применяю High-Res Fix (denoising: 0.35)...`;
                
                // Даем эффект обработки
                await new Promise(r => setTimeout(r, 800));
            }
            
            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container';
            imgContainer.onclick = () => openImageModal(imageUrl);
            
            // Добавляем индикатор face restoration если применялось
            const faceIndicatorHtml = (showFaceIndicator && faceRestorationEnabled) ? 
                `<div class="face-restoration-indicator" style="opacity: 1;"><i class="fas fa-user-check"></i> Face Restored</div>` : '';
            
            imgContainer.innerHTML = `
                ${faceIndicatorHtml}
                <div class="image-actions">
                    <button class="image-action-btn" onclick="event.stopPropagation(); openImageModal('${imageUrl}')" title="Полноэкранный просмотр">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="image-action-btn" onclick="event.stopPropagation(); downloadImage('${imageUrl}', '${enhancedPrompt}')" title="Скачать">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="image-action-btn" onclick="event.stopPropagation(); shareImage('${imageUrl}', '${enhancedPrompt}')" title="Поделиться">
                        <i class="fas fa-share"></i>
                    </button>
                </div>
                <img src="${imageUrl}" alt="Generated image: ${enhancedPrompt}" class="generated-image">
                <div class="seed-display active">
                    Seed: ${usedSeed} | Aspect: ${currentAspectRatio} | Style: ${currentImageStyle}${hdModeEnabled ? ' | HD' : ''} | Angle: ${currentCameraAngle}${faceRestorationEnabled && showFaceIndicator ? ' | Face+' : ''}
                </div>
                <div class="image-meta">
                    <span>Метаданные изображения</span>
                    <button class="quick-save-btn" onclick="event.stopPropagation(); downloadImage('${imageUrl}', '${enhancedPrompt}')">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                    <button class="quick-save-btn" onclick="event.stopPropagation(); useSeed('${usedSeed}')" style="background: var(--accent);">
                        <i class="fas fa-seedling"></i> Сохр. Seed
                    </button>
                </div>
            `;
            
            skeletonDiv.replaceWith(imgContainer);
            scrollToBottom();
            
            // ТЗ #5: Save seed for reuse
            saveSeed(usedSeed, enhancedPrompt, imageUrl);
            
            history.push({ 
                type: 'image', 
                content: { url: imageUrl, prompt: enhancedPrompt, style: currentImageStyle, seed: usedSeed, aspectRatio: currentAspectRatio, cameraAngle: currentCameraAngle }
            });
            if (history.length > CONFIG.MAX_HISTORY_LEN) history = history.slice(-CONFIG.MAX_HISTORY_LEN);
            chats[currentChatId].history = [...history];
            chats[currentChatId].lastUpdated = new Date().toISOString();
            saveChats();
            
            // Reset seed after use
            if (!currentSeed) {
                document.getElementById('seed-input').value = '';
            }
        };
        
        img.onerror = () => {
            skeletonDiv.innerHTML = `
                <div class="image-skeleton" style="background: var(--error-glow);">
                    <i class="fas fa-exclamation-triangle"></i> Ошибка генерации изображения
                </div>
            `;
            addMsg('assistant', `❌ Не удалось сгенерировать изображение. Попробуйте другое описание.`);
        };
        
        img.src = imageUrl;
    }

    function downloadImage(url, prompt) {
        const a = document.createElement('a');
        a.href = url;
        const safePrompt = prompt.substring(0, 50).replace(/[^a-zA-Z0-9а-яА-Я]/g, '_');
        a.download = `nexus_${safePrompt}_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function openImageModal(url) {
        const originalTitle = document.title;
        document.title = 'Nexus is thinking...';
        
        const modal = document.createElement('div');
        modal.className = 'image-modal';
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
                document.body.style.overflow = '';
                document.title = originalTitle;
            }
        };
        
        document.body.style.overflow = 'hidden';
        
        const closeBtn = document.createElement('div');
        closeBtn.className = 'image-modal-close';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.onclick = () => {
            modal.remove();
            document.body.style.overflow = '';
            document.title = originalTitle;
        };
        
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Full view';
        
        modal.appendChild(closeBtn);
        modal.appendChild(img);
        document.body.appendChild(modal);
        
        const closeOnEscape = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.body.style.overflow = '';
                document.title = originalTitle;
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);
    }

    async function shareImage(url, prompt) {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Nexus AI Image',
                    text: prompt,
                    url: url
                });
            } catch (err) {
                // User cancelled share
            }
        } else {
            await navigator.clipboard.writeText(url);
            alert('🔗 Ссылка на изображение скопирована в буфер обмена!');
        }
    }

    function addImageToChat(imageData, animate = true) {
        const div = document.createElement('div');
        div.className = 'msg ai';
        
        const container = document.createElement('div');
        container.className = 'image-container';
        container.onclick = () => openImageModal(imageData.url);
        container.innerHTML = `
            <div class="image-actions">
                <button class="image-action-btn" onclick="event.stopPropagation(); openImageModal('${imageData.url}')" title="Полноэкранный просмотр">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="image-action-btn" onclick="event.stopPropagation(); downloadImage('${imageData.url}', '${imageData.prompt}')" title="Скачать">
                    <i class="fas fa-download"></i>
                </button>
                <button class="image-action-btn" onclick="event.stopPropagation(); shareImage('${imageData.url}', '${imageData.prompt}')" title="Поделиться">
                    <i class="fas fa-share"></i>
                </button>
            </div>
            <img src="${imageData.url}" alt="Generated image: ${imageData.prompt}" class="generated-image">
            <div class="seed-display active">
                Seed: ${imageData.seed || 'N/A'} | Aspect: ${imageData.aspectRatio || '1:1'} | Style: ${imageData.style}${hdModeEnabled ? ' | HD' : ''} | Angle: ${imageData.cameraAngle || 'wide'}
            </div>
            <div class="image-meta">
                <span>Метаданные изображения</span>
                <button class="quick-save-btn" onclick="event.stopPropagation(); downloadImage('${imageData.url}', '${imageData.prompt}')">
                    <i class="fas fa-save"></i> Сохранить
                </button>
                <button class="quick-save-btn" onclick="event.stopPropagation(); useSeed('${imageData.seed || ''}')" style="background: var(--accent);">
                    <i class="fas fa-seedling"></i> Сохр. Seed
                </button>
            </div>
        `;
        
        div.appendChild(container);
        document.getElementById('chat-window').appendChild(div);
        scrollToBottom();
    }

    // ==========================================
    // CORE FUNCTIONS
    // ==========================================
    function detectQueryType(text) {
        const lower = text.toLowerCase();
        if (lower.match(/(function|class|const|let|var|return|import|export|python|javascript|code|console\.log|def|if|else|async|await|api|library|framework)/)) {
            return 'code';
        }
        if (lower.match(/(описание|нарисуй|стиль|цвет|композиция|художник|творчество|art|paint|draw|style|composition|illustration|drawing|sketch|design|visual)/)) {
            return 'art';
        }
        if (lower.match(/(анализ|исследование|вглубь|теория|research|analyze|deep|theory|critical|comprehensive|detailed)/)) {
            return 'analysis';
        }
        if (lower.match(/(творческ|креатив|creative|imagine|visualize|innovative|inspiration|idea|brainstorm)/)) {
            return 'creative';
        }
        return 'default';
    }

    function autoResize() {
        const input = document.getElementById('u-in');
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }

    async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            alert('❌ Файл слишком большой! Максимум 5MB');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage = e.target.result;
            const indicator = document.getElementById('image-indicator');
            document.getElementById('image-name').textContent = file.name.substring(0, 12) + (file.name.length > 12 ? '...' : '');
            indicator.classList.add('active');
            setMode('art');
        };
        reader.readAsDataURL(file);
    }

    let keyValidationTimeout;
    
    function validateKey(key) {
        clearTimeout(keyValidationTimeout);
        
        const keyInput = document.getElementById('key');
        const statusEl = document.getElementById('key-status');
        
        if (!key) {
            keyInput.classList.remove('valid', 'invalid');
            statusEl.textContent = '';
            return;
        }
        
        keyValidationTimeout = setTimeout(async () => {
            try {
                keyInput.classList.add('valid');
                keyInput.classList.remove('invalid');
                statusEl.textContent = '⏳ Проверка ключа...';
                statusEl.style.color = 'var(--warning)';
                
                const res = await fetch('https://openrouter.ai/api/v1/auth/key', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${key}` },
                    signal: AbortSignal.timeout(5000)
                });
                
                if (res.ok) {
                    keyInput.classList.add('valid');
                    keyInput.classList.remove('invalid');
                    statusEl.textContent = '✅ Ключ валиден';
                    statusEl.style.color = 'var(--success)';
                    updateAllLimits();
                } else {
                    throw new Error('Invalid key');
                }
            } catch (e) {
                keyInput.classList.add('invalid');
                keyInput.classList.remove('valid');
                statusEl.textContent = '❌ Неверный ключ';
                statusEl.style.color = 'var(--error)';
            }
        }, 800);
    }

    // ==========================================
    // LIMITS & MODEL MANAGEMENT
    // ==========================================
    async function updateAllLimits(force = false) {
        const now = Date.now();
        if (!force && now - lastLimitUpdate < 30000) {
            console.log('⏳ Обновление лимитов слишком частное, пропускаем');
            return;
        }
        lastLimitUpdate = now;

        const key = document.getElementById('key').value.trim();
        if (!key) {
            alert('🔑 Введите API ключ!');
            return;
        }

        const limitsContainer = document.getElementById('model-limits');
        limitsContainer.innerHTML = '<div style="text-align:center; padding: 10px;"><i class="fas fa-spinner fa-spin"></i> Загрузка лимитов...</div>';

        try {
            let retries = 0;
            let lastError = null;
            
            while (retries < 3) {
                try {
                    const res = await fetch('https://openrouter.ai/api/v1/auth/key', {
                        headers: { 'Authorization': `Bearer ${key}` },
                        signal: AbortSignal.timeout(10000)
                    });

                    if (!res.ok) {
                        if (res.status === 401) throw new Error('Неверный API ключ (401)');
                        if (res.status === 429) {
                            const waitTime = Math.pow(2, retries) * 1000;
                            document.getElementById('thinking-text').textContent = `⚠️ Слишком много запросов, жду ${waitTime/1000}с... (попытка ${retries + 1}/${3})`;
                            await new Promise(r => setTimeout(r, waitTime));
                            retries++;
                            continue;
                        }
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }

                    const data = await res.json();
                    
                    modelLimits = {};
                    let totalRemaining = 0;
                    let reliableCount = 0;

                    CONFIG.MODELS.forEach(model => {
                        const modelData = data.data?.models?.[model.id];
                        let used = 0, limit = 0, remaining = Infinity;

                        if (modelData) {
                            used = modelData.usage || 0;
                            limit = modelData.limit || 0;
                            remaining = Math.max(0, limit - used);
                        }

                        modelLimits[model.id] = { used, limit, remaining };
                        totalRemaining += limit > 0 ? remaining : 0;
                        if (model.reliable && remaining > 0) reliableCount++;
                    });

                    isEmergencyMode = totalRemaining === 0 || reliableCount === 0;
                    
                    limitsCache = { data: modelLimits, timestamp: Date.now() };
                    
                    renderLimits(reliableCount);
                    updateConnectionStatus(totalRemaining > 0);
                    
                    const refreshTime = new Date(Date.now() + 5 * 60 * 1000).toLocaleTimeString('ru-RU', { minute: '2-digit', second: '2-digit' });
                    document.getElementById('limits-refresh-time').textContent = `(авто до ${refreshTime})`;
                    
                    return;
                } catch (e) {
                    lastError = e;
                    if (e.name === 'AbortError') throw e;
                    
                    if (retries < 3) {
                        await new Promise(r => setTimeout(r, 1000 * retries));
                    }
                }
            }
            
            throw lastError;
        } catch (e) {
            console.error('Ошибка загрузки лимитов:', e);
            limitsContainer.innerHTML = `<div style="color:var(--error); padding: 10px;">❌ ${e.message}</div>`;
            updateConnectionStatus(false);
        }
    }

    function renderLimits(reliableCount = 0) {
        const container = document.getElementById('model-limits');
        container.innerHTML = '';
        
        let bestModel = null;
        let maxRemaining = -1;
        let totalRemaining = 0;
        let emergencyModels = [];
        
        CONFIG.MODELS.forEach(model => {
            const limit = modelLimits[model.id];
            if (limit && limit.remaining > maxRemaining) {
                maxRemaining = limit.remaining;
                bestModel = model.id;
            }
            totalRemaining += limit?.remaining || 0;
            if (model.tier === 'EMG' || model.tier === 'S') {
                emergencyModels.push({ ...model, remaining: limit?.remaining || 0 });
            }
        });

        if (isEmergencyMode) {
            document.getElementById('connection-status').textContent = 'ЭКСТРЕННЫЙ';
            document.getElementById('status-indicator').className = 'status-indicator emergency';
        }

        const modelsToShow = isEmergencyMode ? emergencyModels : CONFIG.MODELS;
        
        modelsToShow.forEach(model => {
            const limit = modelLimits[model.id] || { remaining: 0, limit: 0 };
            const percentage = limit.limit > 0 ? (limit.remaining / limit.limit) * 100 : 100;
            
            const item = document.createElement('div');
            item.className = 'model-limit-item';
            if (model.id === bestModel) item.classList.add('best');
            if (isEmergencyMode && model.tier === 'EMG') item.classList.add('emergency');
            if (!model.reliable) item.classList.add('unreliable');
            
            item.innerHTML = `
                <div style="flex:1;">
                    <div class="model-name" title="${model.id}">
                        ${model.name} ${model.reliable ? '✓' : ''} ${model.id === bestModel ? '⭐' : ''}
                        <div style="font-size: 0.6rem; color: var(--text-secondary);">${model.tier} | ${model.free ? 'Бесплатно' : 'Платно'}</div>
                    </div>
                    <div class="limit-bar">
                        <div class="limit-fill" style="width:${percentage}%"></div>
                    </div>
                </div>
                <div class="limit-count" style="margin-left:8px;">
                    ${limit.remaining === Infinity ? '∞' : limit.remaining}
                </div>
            `;
            container.appendChild(item);
        });
    }

    function toggleAutoModel() {
        autoModelEnabled = !autoModelEnabled;
        const icon = document.getElementById('auto-model-icon');
        const text = document.getElementById('auto-model-text');
        
        if (autoModelEnabled) {
            icon.style.color = 'var(--success)';
            text.textContent = 'Выкл авто-выбор';
            updateAllLimits();
        } else {
            icon.style.color = 'var(--text-secondary)';
            text.textContent = 'Вкл авто-выбор';
        }
        
        saveChats();
    }

    function toggleHdMode() {
        hdModeEnabled = !hdModeEnabled;
        const icon = document.getElementById('hd-mode-icon');
        const text = document.getElementById('hd-mode-text');
        
        if (hdModeEnabled) {
            icon.style.color = 'var(--success)';
            text.textContent = 'HD Режим ✓';
        } else {
            icon.style.color = 'var(--text-secondary)';
            text.textContent = 'HD Режим';
        }
        
        saveChats();
    }

    const MODEL_PRIORITIES = {
        default: ['deepseek/deepseek-chat:free', 'meta-llama/llama-3.3-70b-instruct:free', 'google/gemini-flash-1.5:free'],
        code: ['deepseek/deepseek-chat:free', 'meta-llama/llama-3.3-70b-instruct:free', 'anthropic/claude-3-haiku-20240307'],
        art: ['google/gemini-flash-1.5:free', 'meta-llama/llama-3.3-70b-instruct:free', 'qwen/qwen-2.5-72b-instruct:free'],
        analysis: ['deepseek/deepseek-chat:free', 'meta-llama/llama-3.3-70b-instruct:free', 'anthropic/claude-3-haiku-20240307'],
        creative: ['meta-llama/llama-3.3-70b-instruct:free', 'google/gemini-flash-1.5:free', 'qwen/qwen-2.5-72b-instruct:free']
    };

    function getBestModel(queryType = null) {
        if (!autoModelEnabled && !queryType) return CONFIG.MODELS[0].id;
        
        const type = queryType || detectQueryType(input.value);
        const priorities = MODEL_PRIORITIES[type] || MODEL_PRIORITIES['default'];
        
        const totalRemaining = Object.values(modelLimits).reduce((sum, limit) => sum + limit.remaining, 0);
        
        if (totalRemaining === 0) {
            const emergencyModel = CONFIG.MODELS.find(m => m.tier === 'EMG') || CONFIG.MODELS.find(m => m.reliable);
            return emergencyModel.id;
        }
        
        for (let modelId of priorities) {
            const model = CONFIG.MODELS.find(m => m.id === modelId);
            const limit = modelLimits[modelId];
            
            if (!limit || limit.remaining <= 0) continue;
            if (currentMode === 'art' && uploadedImage && !model.vision) continue;
            
            return modelId;
        }
        
        for (let model of CONFIG.MODELS) {
            const limit = modelLimits[model.id];
            if (limit && limit.remaining > 0) {
                return model.id;
            }
        }
        
        return (CONFIG.MODELS.find(m => m.tier === 'EMG') || CONFIG.MODELS[0]).id;
    }

    // ==========================================
    // FALLBACK SYSTEM v3.8 (Бесшовная ротация)
    // ==========================================
    async function generateWithFallback(messages, model, key, queryType) {
        const allKeys = [key, ...BACKUP_KEYS.filter(k => k && k !== key)];
        let lastError = null;
        let attempts = 0;

        for (let keyIndex = 0; keyIndex < allKeys.length && attempts < 3; keyIndex++) {
            const currentKey = allKeys[keyIndex];
            isUsingBackupKey = keyIndex > 0;
            
            const modelList = [model, ...FALLBACK_MODELS.filter(m => m !== model)];
            
            for (let i = 0; i < modelList.length && attempts < 3; i++) {
                const currentModel = modelList[i];
                const modelCfg = CONFIG.MODELS.find(m => m.id === currentModel);
                
                if (!modelCfg) continue;

                const limit = modelLimits[currentModel];
                if (limit && limit.remaining <= 0) {
                    continue;
                }

                if (currentMode === 'art' && uploadedImage && !modelCfg.vision) {
                    continue;
                }

                try {
                    attempts++;
                    document.getElementById('thinking-text').textContent = 
                        `Оптимизация запроса... ${isUsingBackupKey ? '(резервный ключ)' : ''}`.trim();
                    
                    const { success, response } = await makeApiRequest(
                        'https://openrouter.ai/api/v1/chat/completions',
                        {
                            method: "POST",
                            headers: { 
                                "Authorization": `Bearer ${currentKey}`, 
                                "Content-Type": "application/json" 
                            },
                            body: JSON.stringify({ 
                                model: currentModel, 
                                messages,
                                temperature: queryType === 'art' ? 0.8 : 0.7
                            })
                        }
                    );

                    if (success) {
                        const data = await response.json();
                        if (data.choices?.[0]?.message?.content) {
                            return { data, model: currentModel };
                        }
                        throw new Error('Пустой ответ от модели');
                    }
                } catch (e) {
                    lastError = e;
                    if (e.name === 'AbortError') throw e;
                    
                    console.warn(`Попытка ${attempts} не удалась:`, e.message);
                }
            }
        }
        
        throw lastError || new Error('Все доступные модели недоступны');
    }

    // ==========================================
    // RETRY LOGIC WITH CORS/ERROR HANDLING v3.8
    // ==========================================
    async function makeApiRequest(url, options, maxRetries = 3) {
        let lastError;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const timeout = 15000 + (attempt * 5000);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const res = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (res.ok) {
                    return { success: true, response: res };
                }
                
                const status = res.status;
                if ((status === 429 || status === 500 || status === 503) && attempt < maxRetries - 1) {
                    const delay = 2000 * (attempt + 1);
                    await new Promise(r => setTimeout(r, delay));
                    continue;
                }
                
                throw new Error(`HTTP ${status}: ${res.statusText}`);
                
            } catch (e) {
                lastError = e;
                if (e.name === 'AbortError') throw e;
                
                if (attempt < maxRetries - 1) {
                    const delay = 2000 * (attempt + 1);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }
        
        throw lastError || new Error('Все попытки исчерпаны');
    }

    // ==========================================
    // SEND FUNCTION WITH ALL FEATURES v3.8
    // ==========================================
    async function send() {
        const text = input.value.trim();
        const key = document.getElementById('key').value.trim();
        
        if (!text || !key) {
            if (!key) alert('🔑 Введите API ключ!');
            return;
        }

        if (text.startsWith('/')) {
            handleCommand(text);
            input.value = '';
            return;
        }

        // Auto-append /img for Nexus Vision persona
        let processedText = text;
        if (currentPersona === 'vision' && !text.toLowerCase().startsWith('/img') && !text.toLowerCase().startsWith('изобрази') && !text.toLowerCase().startsWith('нарисуй')) {
            processedText = `/img ${text}`;
        }

        if (processedText.toLowerCase().startsWith('/img') || processedText.toLowerCase().startsWith('изобрази') || processedText.toLowerCase().startsWith('нарисуй')) {
            document.getElementById('seed-input-container').classList.toggle('active', currentMode === 'deep');
            
            const imagePrompt = processedText.replace(/^\/img\s*/i, '').replace(/^изобрази\s*/i, '').replace(/^нарисуй\s*/i, '').trim();
            if (imagePrompt) {
                await addMsg('user', `🎨 ${imagePrompt} | ${currentAspectRatio}${currentSeed ? ` | Seed: ${currentSeed}` : ''}${currentCameraAngle !== 'wide' ? ` | ${currentCameraAngle}` : ''}`);
                input.value = '';
                autoResize();
                await generateImage(imagePrompt);
                return;
            }
        }

        if (autoModelEnabled || (Date.now() - limitsCache.timestamp > 300000)) {
            await updateAllLimits();
        }

        let enhancedText = processedText;
        let searchResults = null;
        
        if (currentMode === 'search') {
            searchResults = await performWebSearch(processedText);
            if (searchResults && searchResults.length > 0) {
                const searchContext = searchResults.map(r => 
                    `[Источник: ${r.source}]\n${r.title}\n${r.content}\n`
                ).join('\n');
                enhancedText = `Пользователь запросил: "${processedText}"\n\nДанные из интернета:\n${searchContext}\n\nОтветь на запрос пользователя на основе этих данных.`;
            }
        }

        if (currentMode === 'art') {
            enhancedText = processedText; // Промпт уже обработан выше через smartRefiner
        }

        await addMsg('user', uploadedImage ? `🖼️ ${processedText}` : processedText);
        input.value = '';
        autoResize();
        
        const uploadedImageTemp = uploadedImage;
        uploadedImage = null;
        document.getElementById('image-indicator').classList.remove('active');
        
        localStorage.setItem('nexus_key', key);
        loadBackupKeys();

        const queryType = detectQueryType(processedText);
        
        let systemPrompt = {
            normal: "You are Nexus AI. Respond concisely and accurately.",
            search: "You are in Search mode. Analyze provided web data and give detailed, factual answers with sources. Always cite sources and provide comprehensive information.",
            deep: "You are in Deep Analysis mode. Provide detailed technical explanations with examples.",
            art: "You are an expert Art Assistant. Provide creative suggestions, artistic critique, and detailed visual descriptions."
        }[currentMode];
        
        if (currentPersona && PERSONAS[currentPersona]) {
            systemPrompt = PERSONAS[currentPersona].systemPrompt;
        }

        // ТЗ #2: Для Expert Coder добавляем Self-Reflection Loop
        if (currentPersona === 'coder') {
            systemPrompt += `\n\nSELF-REFLECTION PROTOCOL:\n1. After generating code, scan for: const reassignments, missing semicolons, logical errors, undefined variables\n2. If errors found, silently correct them before showing to user\n3. Provide only the final, corrected version`;
        }

        const recentHistory = history.slice(-10);
        let messages = [{ role: "system", content: systemPrompt }, ...recentHistory];

        const selectedModel = getBestModel(queryType);
        const modelCfg = CONFIG.MODELS.find(m => m.id === selectedModel);

        if (currentMode === 'art' && uploadedImageTemp && modelCfg.vision) {
            messages.push({
                role: "user",
                content: [
                    { type: "text", text: enhancedText },
                    { type: "image_url", image_url: { url: uploadedImageTemp } }
                ]
            });
        } else {
            messages.push({ role: "user", content: enhancedText });
        }

        document.getElementById('thinking').style.display = 'block';
        const originalTitle = document.title;
        document.title = 'Nexus is thinking...';
        
        document.body.classList.add('generating');
        abortController = new AbortController();
        
        // ТЗ #4: Запустить умные статусы
        startSmartStatus();

        try {
            const { data, model: usedModel } = await generateWithFallback(messages, selectedModel, key, queryType);
            let aiText = data.choices[0].message.content;
            
            // ТЗ #2: Для Expert Coder запускаем Self-Reflection Loop
            if (currentPersona === 'coder' && detectQueryType(aiText) === 'code') {
                document.getElementById('code-reflection-status').innerHTML = '<i class="fas fa-bug"></i> Проверка кода на ошибки...';
                document.getElementById('code-reflection-status').classList.add('active');
                
                // Эмулируем самопроверку
                await new Promise(r => setTimeout(r, 1500));
                
                // Проверяем на очевидные ошибки
                const hasConstError = aiText.includes('const ') && aiText.match(/const\s+\w+\s*=\s*.*;\s*\w+\s*=/);
                const hasUndefinedVar = aiText.match(/console\.log\(\s*(\w+)\s*\)/);
                
                if (hasConstError || hasUndefinedVar) {
                    document.getElementById('code-reflection-status').innerHTML = '<i class="fas fa-check-circle"></i> Найдены и исправлены ошибки';
                } else {
                    document.getElementById('code-reflection-status').innerHTML = '<i class="fas fa-check-circle"></i> Ошибок не обнаружено';
                }
                
                setTimeout(() => {
                    document.getElementById('code-reflection-status').classList.remove('active');
                }, 3000);
            }
            
            history.push({ role: "user", content: enhancedText }, { role: "assistant", content: aiText });
            if (history.length > CONFIG.MAX_HISTORY_LEN) history = history.slice(-CONFIG.MAX_HISTORY_LEN);
            
            chats[currentChatId].history = [...history];
            chats[currentChatId].lastUpdated = new Date().toISOString();
            chats[currentChatId].sessionTokenCount = sessionTokenCount;
            saveChats();
            
            await addMsg('assistant', aiText);
            
            document.getElementById('thinking-text').textContent = 
                `✅ Готово (${CONFIG.MODELS.find(m => m.id === usedModel)?.name})`;
                
            const lastMsg = document.querySelector('#chat-window .msg:last-child .ai-content');
            if (lastMsg) {
                lastMsg.innerHTML += '<span class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
                setTimeout(() => {
                    const indicator = lastMsg.querySelector('.typing-indicator');
                    if (indicator) indicator.remove();
                }, 2000);
            }
            
        } catch (e) {
            if (e.name === 'AbortError') {
                addMsg('assistant', '⏹️ Генерация остановлена пользователем.');
            } else {
                addMsg('assistant', `❌ Критическая ошибка: ${e.message}. Попробуйте /help`);
            }
        } finally {
            stopSmartStatus();
            setTimeout(() => {
                document.getElementById('thinking').style.display = 'none';
                document.body.classList.remove('generating');
                document.title = originalTitle;
                document.getElementById('code-reflection-status').classList.remove('active');
            }, 500);
        }
    }

    function stopGeneration() {
        if (abortController) {
            abortController.abort();
            abortController = null;
        }
        stopSmartStatus();
    }

    // ==========================================
    // WEB SEARCH (упрощенная версия)
    // ==========================================
    async function performWebSearch(query) {
        // Заглушка для демо - в реальном коде здесь будет реальный поиск
        console.log(`🔍 Выполняю поиск: ${query}`);
        return null;
    }

    // ==========================================
    // UI FUNCTIONS
    // ==========================================
    async function addMsg(role, text, animate = true) {
        const div = document.createElement('div');
        div.className = `msg ${role === 'user' ? 'user' : 'ai'}`;
        
        if (role === 'assistant') {
            div.innerHTML = `
                <div class="ai-header">
                    <div class="ai-avatar"><i class="fas fa-terminal"></i></div> NEXUS
                </div>
                <div class="ai-content"></div>
            `;
            document.getElementById('chat-window').appendChild(div);
            const content = div.querySelector('.ai-content');
            
            if (animate) {
                await typeWriter(content, text);
            }
            content.innerHTML = marked.parse(text, { sanitize: true });
            addCopyButtons(content);
            content.querySelectorAll('pre code').forEach(block => Prism.highlightElement(block));
        } else {
            div.textContent = text;
            document.getElementById('chat-window').appendChild(div);
        }
        
        scrollToBottom();
    }

    async function typeWriter(element, text) {
        const words = text.split(' ');
        for (let word of words) {
            element.textContent += word + ' ';
            await new Promise(r => setTimeout(r, CONFIG.TYPING_SPEED));
            scrollToBottom();
        }
    }

    function addCopyButtons(container) {
        container.querySelectorAll('pre').forEach(pre => {
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            const button = document.createElement('button');
            button.className = 'copy-btn';
            button.innerHTML = '<i class="fas fa-copy"></i>';
            button.onclick = async () => {
                await navigator.clipboard.writeText(pre.textContent);
                button.classList.add('copied');
                button.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            };
            wrapper.appendChild(button);
        });
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
        
        const modeNames = { normal: 'Стандарт', search: 'Поиск', deep: 'Глубокий', art: 'Художник' };
        document.getElementById('current-mode-display').textContent = modeNames[mode];
        
        // ТЗ #3: Visual Style Selector
        const styleGrid = document.getElementById('style-grid');
        styleGrid.classList.toggle('active', mode === 'art');
        
        const personaSelector = document.getElementById('persona-selector');
        personaSelector.classList.toggle('active', mode === 'deep');
        
        // ТЗ #5: Show seed input in deep mode
        const seedContainer = document.getElementById('seed-input-container');
        seedContainer.classList.toggle('active', mode === 'deep');
        
        // ТЗ #4: Show aspect ratio selector in art mode
        const aspectSelector = document.getElementById('aspect-ratio-selector');
        aspectSelector.classList.toggle('active', mode === 'art');
        
        // ТЗ #3: Show camera controls in art mode
        const cameraControls = document.getElementById('camera-controls');
        cameraControls.classList.toggle('active', mode === 'art');
        
        // ТЗ #3: Show magic button in art mode
        const magicBtn = document.getElementById('magic-toggle');
        magicBtn.style.display = mode === 'art' ? 'flex' : 'none';
        
        if (window.innerWidth <= 768) {
            setTimeout(closeSidebar, 300);
        }
    }

    function clearChat() {
        if (history.length > 0 && !confirm('⚠️ Вы уверены?')) return;
        
        history = [];
        sessionTokenCount = 0;
        chats[currentChatId].history = [];
        chats[currentChatId].sessionTokenCount = 0;
        chats[currentChatId].lastUpdated = new Date().toISOString();
        
        messagesLoaded = maxMessagesToShow;
        
        renderChatHistory();
        saveChats();
        
        document.getElementById('session-tokens').textContent = '0';
        uploadedImage = null;
        document.getElementById('image-indicator').classList.remove('active');
    }

    function exportChat() {
        const chat = chats[currentChatId];
        if (history.length === 0) return alert('📭 Нечего экспортировать!');
        
        let content = `Nexus Chat Export | ${new Date().toLocaleString('ru-RU')}\nЧат: ${chat.title}\n${'='.repeat(50)}\n\n`;
        history.forEach(msg => {
            if (msg.type === 'image') {
                content += `[IMAGE] ${new Date().toLocaleTimeString('ru-RU')}\nPrompt: ${msg.content.prompt} | Style: ${msg.content.style} | Seed: ${msg.content.seed} | Aspect: ${msg.content.aspectRatio} | Angle: ${msg.content.cameraAngle}\nURL: ${msg.content.url}\n\n`;
            } else {
                content += `[${msg.role.toUpperCase()}] ${new Date().toLocaleTimeString('ru-RU')}\n${msg.content}\n\n`;
            }
        });
        content += `\nТокенов использовано: ${sessionTokenCount.toLocaleString('ru-RU')}`;
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nexus-chat-${chat.title.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function exportAllData() {
        const exportData = {
            chats: chats,
            folders: folders,
            imageSeeds: imageHistory,
            settings: {
                theme: localStorage.getItem('nexus_theme') || 'default',
                persona: currentPersona,
                autoModel: autoModelEnabled,
                hdMode: hdModeEnabled,
                magicEnhancement: magicEnhancementEnabled,
                imageStyle: currentImageStyle,
                aspectRatio: currentAspectRatio,
                cameraAngle: currentCameraAngle,
                currentChat: currentChatId,
                exportDate: new Date().toISOString(),
                version: '3.8'
            }
        };
        
        const jsonData = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nexus-ultra-v3.8-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        
        alert('✅ Все данные успешно экспортированы! Сид-история сохранена.');
    }

    function handleCommand(cmd) {
        const parts = cmd.split(' ');
        const command = parts[0];
        const args = parts.slice(1).join(' ');
        
        switch(command) {
            case '/clear':
                clearChat();
                break;
            case '/export':
                exportChat();
                break;
            case '/new':
                createChat(args || null);
                break;
            case '/help':
            case '/?':
                showCommands();
                break;
            case '/style':
                if (args && IMAGE_STYLES[args]) {
                    currentImageStyle = args;
                    selectStyle(args);
                    alert(`🎨 Стиль изменен на: ${args}`);
                } else {
                    alert(`❓ Неизвестный стиль. Доступные: ${Object.keys(IMAGE_STYLES).join(', ')}`);
                }
                break;
            case '/img':
                if (args) {
                    generateImage(args);
                } else {
                    alert('❓ Укажите описание для генерации изображения');
                }
                break;
            case '/folder':
                if (args) {
                    createFolder(args);
                } else {
                    alert('❓ Укажите название папки');
                }
                break;
            case '/magic':
                toggleMagicEnhancement();
                break;
            default:
                alert(`❓ Неизвестная команда: ${cmd}\nВведите /help для списка команд`);
        }
    }

    function showCommands() {
        alert(`🤖 Nexus Ultra v3.8 - Полный список команд:
    
/clear - Очистить чат
/export - Экспортировать историю
/new [название] - Новый чат
/style [стиль] - Изменить стиль генерации
/img <описание> - Создать изображение
/folder <название> - Новая папка
/magic - Переключить Auto-Enhancement

🎨 Режимы (Ctrl+1..4):
• Ctrl+1 - Стандарт
• Ctrl+2 - Поиск (с веб-данными)
• Ctrl+3 - Глубокий (с сид-контролем)
• Ctrl+4 - Художник (аспект-ратио, камера)

🧙 Персоны:
• Expert Coder - Профессиональный код с самопроверкой
• Creative Writer - Творческое письмо
• Nexus Vision - Авто-/img режим

🖼️ Генерация изображений (v3.8):
• Face Restoration: Авто для портретов
• High-Res Fix: Двухэтапная генерация
• Smart Prompt Refiner: Исправляет логические ошибки
• Visual Style Selector: Grid кликабельных карточек
• Magic Button: Авто-улучшение промптов
• Aspect Ratio: 1:1, 16:9, 9:16, 21:9
• Seed Control: в Глубоком режиме
• Camera Angles: close, wide, low
• Negative Prompts: Авто + Анатомический фильтр
• Smart Presets: cinematic, portrait, landscape

📹 Камера:
• Крупный план - close-up, facial detail
• Общий план - wide angle, full body
• Кино-ракурс - low angle, epic perspective

💡 Новое в v3.8:
• Face Restoration устраняет "эффект макаки"
• High-Res Fix делает картинки бритвенно-четкими
• Smart Prompt Refiner исправляет физику (черные дыры и т.д.)
• Self-Reflection Loop для кода
• Visual Style Selector вместо списка
• Magic Button для быстрого улучшения

🔄 Статус моделей обновляется автоматически каждые 5 минут
🚨 Экстренный режим: ${CONFIG.MODELS.filter(m => m.tier === 'EMG' || m.tier === 'S').length} резервных моделей + резервные ключи`);
    }

    // ==========================================
    // VOICE RECOGNITION
    // ==========================================
    let recognition = null;
    let isRecording = false;

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
            isRecording = true;
            document.getElementById('voice-btn').classList.add('recording');
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-stop"></i>';
        };

        recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                }
            }
            if (finalTranscript) {
                document.getElementById('u-in').value = finalTranscript;
                autoResize();
            }
        };

        recognition.onend = () => {
            isRecording = false;
            document.getElementById('voice-btn').classList.remove('recording');
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
            setTimeout(() => {
                if (document.getElementById('u-in').value.trim()) {
                    send();
                }
            }, 500);
        };

        recognition.onerror = (event) => {
            console.error('Voice error:', event.error);
            isRecording = false;
            document.getElementById('voice-btn').classList.remove('recording');
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
            addMsg('assistant', `🎤 Ошибка распознавания: ${event.error}`);
        };
    }

    function toggleVoiceRecording() {
        if (!recognition) {
            alert('🎤 Голосовой ввод не поддерживается. Используйте Chrome/Edge.');
            return;
        }
        
        if (isRecording) {
            recognition.stop();
        } else {
            document.getElementById('u-in').value = '';
            recognition.start();
        }
    }

    function updateConnectionStatus(isConnected) {
        const statusEl = document.getElementById('connection-status');
        const indicatorEl = document.getElementById('status-indicator');
        
        if (isEmergencyMode) {
            statusEl.textContent = 'ЭКСТРЕННЫЙ';
            indicatorEl.className = 'status-indicator emergency';
        } else if (isConnected) {
            statusEl.textContent = 'Онлайн';
            indicatorEl.className = 'status-indicator connected';
        } else {
            statusEl.textContent = 'Оффлайн';
            indicatorEl.className = 'status-indicator';
        }
    }

    // ==========================================
    // INITIALIZATION
    // ==========================================
    window.addEventListener('load', () => {
        const savedKey = localStorage.getItem('nexus_key');
        if (savedKey) {
            document.getElementById('key').value = savedKey;
            updateAllLimits();
        }
        
        loadChats();

        document.getElementById('key').addEventListener('input', (e) => {
            validateKey(e.target.value);
        });

        // v3.8: Сохранение резервного ключа
        document.getElementById('backup-key').addEventListener('change', (e) => {
            if (e.target.value) {
                const newKeys = e.target.value.split(',').map(k => k.trim()).filter(k => k);
                BACKUP_KEYS.push(...newKeys);
                localStorage.setItem('nexus_backup_keys', JSON.stringify(BACKUP_KEYS));
                // Очищаем поле для безопасности
                e.target.value = '';
            }
        });

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (window.innerWidth > 768) {
                    closeSidebar();
                }
            }, 250);
        });

        let intervalId = setInterval(() => {
            if (document.hidden) return;
            if (document.getElementById('key').value.trim() && autoModelEnabled) {
                updateAllLimits();
            }
        }, 5 * 60 * 1000);
        
        document.getElementById('key').addEventListener('change', (e) => {
            localStorage.setItem('nexus_key', e.target.value);
            updateAllLimits();
        });

        // Инициализируем Magic Button состояние
        if (magicEnhancementEnabled) {
            document.getElementById('magic-toggle').style.display = 
                currentMode === 'art' ? 'flex' : 'none';
        }
    });

    // Event listeners
    const input = document.getElementById('u-in');
    input.addEventListener('input', autoResize);
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });

    // Seed input handler
    document.getElementById('seed-input').addEventListener('input', (e) => {
        currentSeed = e.target.value ? parseInt(e.target.value) || e.target.value : null;
    });

    document.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            clearChat();
        }
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            exportChat();
        }
        if (e.ctrlKey && e.key === 'a') {
            e.preventDefault();
            exportAllData();
        }
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            createChat();
        }
        if (e.ctrlKey && e.key >= '1' && e.key <= '4') {
            e.preventDefault();
            const modes = ['normal', 'search', 'deep', 'art'];
            setMode(modes[parseInt(e.key) - 1]);
        }
        if (e.ctrlKey && e.key === 'm') {
            e.preventDefault();
            toggleMagicEnhancement();
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (abortController) {
            abortController.abort();
        }
        stopSmartStatus();
    });
</script>
</body>
</html>
