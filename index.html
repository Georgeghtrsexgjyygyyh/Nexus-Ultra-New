<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus AI | ULTRA v3.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <style>
        /* ==========================================
           THEME SYSTEM VARIABLES (v3.7)
           ========================================== */
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --error: #ef4444;
            --error-glow: rgba(239, 68, 68, 0.3);
            --emergency: #8b5cf6;
            --emergency-glow: rgba(139, 92, 246, 0.3);
            --bg: #0b0f1a;
            --panel: rgba(17, 24, 39, 0.7);
            --panel-2: rgba(31, 41, 55, 0.5);
            --text: #f0f9ff;
            --text-secondary: #94a3b8;
            --input-bg: rgba(15, 23, 42, 0.6);
            --border: rgba(99, 102, 241, 0.2);
            --hover: rgba(99, 102, 241, 0.1);
            --blur: blur(12px);
            --mobile-nav-height: 60px;
        }

        [data-theme="cyberpunk"] {
            --accent: #ff006e;
            --accent-glow: rgba(255, 0, 110, 0.4);
            --border: rgba(255, 0, 110, 0.2);
            --hover: rgba(255, 0, 110, 0.1);
            --bg: #0a0a0a;
            --emergency: #ff006e;
            --panel: rgba(20, 0, 10, 0.7);
            --panel-2: rgba(30, 0, 15, 0.5);
        }

        [data-theme="ocean"] {
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.4);
            --border: rgba(0, 212, 255, 0.2);
            --hover: rgba(0, 212, 255, 0.1);
            --bg: #001122;
            --emergency: #0066ff;
            --panel: rgba(0, 20, 40, 0.7);
            --panel-2: rgba(0, 30, 60, 0.5);
        }

        [data-theme="forest"] {
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.4);
            --border: rgba(0, 255, 136, 0.2);
            --hover: rgba(0, 255, 136, 0.1);
            --bg: #001a0a;
            --emergency: #00cc66;
            --panel: rgba(0, 30, 20, 0.7);
            --panel-2: rgba(0, 40, 30, 0.5);
        }

        /* ==========================================
           TYPING ANIMATION & IMAGE EFFECTS (v3.7)
           ========================================== */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .msg { animation: fadeIn 0.4s ease !important; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* ==========================================
           NEW: BLUR-TO-SHARP EFFECT (–¢–ó #1)
           ========================================== */
        @keyframes blurToSharp {
            0% { 
                filter: blur(20px) brightness(1.5) contrast(0.7); 
                transform: scale(1.05); 
            }
            25% { 
                filter: blur(10px) brightness(1.2) contrast(0.85); 
                transform: scale(1.02); 
            }
            50% { 
                filter: blur(5px) brightness(1.1) contrast(0.9); 
                transform: scale(1.01); 
            }
            75% { 
                filter: blur(2px) brightness(1.05) contrast(0.95); 
                transform: scale(1.005); 
            }
            100% { 
                filter: blur(0) brightness(1) contrast(1); 
                transform: scale(1); 
            }
        }
        
        .image-container {
            position: relative;
            margin: 12px 0;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            animation: fadeIn 0.3s ease;
            cursor: pointer;
            /* –¢–ó #1: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* NEW: SKELETON SCREEN (–¢–ó #1) */
        .image-skeleton {
            background: linear-gradient(90deg, 
                rgba(99, 102, 241, 0.08) 25%, 
                rgba(99, 102, 241, 0.2) 50%, 
                rgba(99, 102, 241, 0.08) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            height: 300px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex-direction: column;
            gap: 8px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .generated-image {
            /* –¢–ó #1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π */
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 600px;
            border-radius: 14px;
            opacity: 0;
            animation: blurToSharp 0.8s ease-out forwards;
            display: block;
            transition: transform 0.3s ease;
            object-fit: contain; /* –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ */
        }
        
        .generated-image:hover {
            transform: scale(1.02);
        }
        
        .image-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .image-container:hover .image-actions {
            opacity: 1;
        }
        
        .image-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            transition: all 0.2s;
        }
        
        .image-action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 0 8px var(--accent-glow);
        }
        
        .image-meta {
            padding: 12px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            width: 100%;
        }
        
        .quick-save-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .quick-save-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .key-input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.85rem;
            margin-top: 8px;
            word-break: break-all;
            transition: border-color 0.2s;
        }
        
        .key-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .key-input.valid {
            border-color: var(--success);
            box-shadow: 0 0 8px var(--success-glow);
        }

        .key-input.invalid {
            border-color: var(--error);
            box-shadow: 0 0 8px var(--error-glow);
        }
        
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }
        
        .image-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 8px;
            animation: blurToSharp 0.5s ease;
            cursor: zoom-out;
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 2001;
        }
        
        .image-modal-close:hover {
            background: rgba(239, 68, 68, 0.8);
            transform: scale(1.1);
        }
        
        .search-indicator {
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .search-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        /* –¢–ó #4: –ö–Ω–æ–ø–∫–∏ —Ä–∞–∫—É—Ä—Å–∞ –∫–∞–º–µ—Ä—ã */
        .camera-controls {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(6px, 1.5vw, 10px);
            flex-wrap: wrap;
        }

        .camera-controls.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .camera-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-align: center;
        }

        .camera-btn.active {
            border-color: var(--accent);
            background: var(--hover);
            color: var(--accent);
        }

        .camera-btn:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        
        * { 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            transition: background-color 0.2s, border-color 0.2s, transform 0.2s; 
        }
        
        html, body { 
            height: 100%; 
            overflow-x: hidden; 
        }
        
        body {
            background: var(--bg); 
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%);
            color: var(--text); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        
        aside { 
            width: 320px; 
            background: var(--panel); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 16px; 
            z-index: 1000; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3); 
            position: relative; 
        }
        
        .mobile-menu-toggle { 
            display: none; 
            position: fixed; 
            top: 16px; 
            left: 16px; 
            z-index: 1001; 
            width: 44px; 
            height: 44px; 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            color: var(--text); 
            cursor: pointer; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2rem; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); 
        }
        
        .mobile-menu-toggle:active { 
            transform: scale(0.95); 
        }
        
        .logo { 
            font-size: clamp(1.2rem, 2vw, 1.5rem); 
            font-weight: 700; 
            color: var(--accent); 
            margin-bottom: 24px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px; 
            user-select: none; 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
            text-shadow: 0 0 20px var(--accent-glow); 
        }
        
        .status-panel { 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: clamp(12px, 2vw, 16px); 
            margin-bottom: 20px; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); 
        }
        
        .status-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 8px 0; 
            font-size: clamp(0.75rem, 1.5vw, 0.8rem); 
        }
        
        .status-indicator { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: var(--text-secondary); 
            box-shadow: 0 0 8px currentColor; 
        }
        
        .status-indicator.connected { 
            background: var(--success); 
            animation: pulse-success 2s infinite; 
        }
        
        .status-indicator.emergency { 
            background: var(--emergency); 
            animation: pulse-success 2s infinite; 
        }
        
        @keyframes pulse-success { 
            0%, 100% { box-shadow: 0 0 0 0 var(--success-glow); } 
            50% { box-shadow: 0 0 0 6px var(--success-glow); } 
        }
        
        .model-limits { 
            max-height: 250px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            margin-top: 12px; 
            scrollbar-width: thin; 
            scrollbar-color: var(--border) transparent; 
        }
        
        .model-limit-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px; 
            margin: 4px 0; 
            background: rgba(0, 0, 0, 0.2); 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            position: relative; 
        }
        
        .model-limit-item.best { 
            border-color: var(--accent); 
            background: var(--hover); 
            box-shadow: 0 0 12px var(--accent-glow); 
        }
        
        .model-limit-item.unreliable { 
            opacity: 0.6; 
            border-style: dashed; 
        }
        
        .model-name { 
            font-size: clamp(0.7rem, 1.5vw, 0.75rem); 
            font-weight: 500; 
        }
        
        .limit-count { 
            font-size: clamp(0.7rem, 1.5vw, 0.75rem); 
            font-weight: 600; 
        }
        
        .limit-bar { 
            width: 100%; 
            height: 4px; 
            background: var(--panel-2); 
            border-radius: 2px; 
            margin-top: 4px; 
            overflow: hidden; 
        }
        
        .limit-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent), #8b5cf6); 
            border-radius: 2px; 
            transition: width 0.3s ease; 
        }
        
        .controls-section { 
            margin-bottom: 20px; 
        }
        
        .section-title { 
            font-size: clamp(0.6rem, 1.5vw, 0.7rem); 
            color: var(--text-secondary); 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 8px; 
            padding: 0 8px; 
            letter-spacing: 0.5px; 
        }
        
        .btn { 
            background: var(--panel-2); 
            border: 1px solid var(--border); 
            padding: clamp(8px, 1.5vw, 10px) clamp(10px, 1.5vw, 12px); 
            border-radius: 10px; 
            cursor: pointer; 
            color: var(--text); 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            width: 100%; 
            margin-bottom: 6px; 
            transition: all 0.2s; 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            min-height: 44px; 
        }
        
        .btn:hover { 
            background: var(--hover); 
            border-color: var(--accent); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); 
        }
        
        .btn:active { 
            transform: translateY(0); 
        }
        
        .btn.danger:hover { 
            border-color: var(--error); 
            box-shadow: 0 4px 12px var(--error-glow); 
        }
        
        /* v3.7: –û–±–Ω–æ–≤–ª–µ–Ω Aspect Ratio Selector */
        .aspect-ratio-selector {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(6px, 1.5vw, 10px);
            flex-wrap: wrap;
        }

        .aspect-ratio-selector.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .aspect-btn {
            flex: 1;
            min-width: 60px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-align: center;
        }

        .aspect-btn.active {
            border-color: var(--accent);
            background: var(--hover);
            color: var(--accent);
        }

        .aspect-btn:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .prompt-enhancer-btn {
            position: absolute;
            left: 8px;
            bottom: 8px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 5;
        }

        .prompt-enhancer-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .persona-selector {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: clamp(6px, 1.5vw, 10px);
        }

        .persona-selector.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .persona-selector select {
            flex: 1;
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: clamp(0.8rem, 1.5vw, 0.85rem);
        }

        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theme-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel-2);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            text-align: center;
        }

        .theme-btn.active {
            border-color: var(--accent);
            background: var(--hover);
            color: var(--accent);
        }

        .theme-btn:hover {
            transform: translateY(-1px);
        }

        .folder-item {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px;
        }

        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .folder-content {
            display: none;
            padding-left: 16px;
            padding-top: 8px;
        }

        .folder-content.active {
            display: block;
        }

        .folder-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .mode-container { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            margin-bottom: 20px; 
        }
        
        .mode-btn { 
            background: var(--panel-2); 
            border: 1px solid var(--border); 
            padding: clamp(8px, 1.5vw, 10px) clamp(10px, 1.5vw, 12px); 
            border-radius: 10px; 
            cursor: pointer; 
            color: var(--text-secondary); 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.2s; 
            min-height: 44px; 
        }
        
        .mode-btn.active { 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            color: white; 
            border-color: var(--accent); 
            box-shadow: 0 0 16px var(--accent-glow); 
        }
        
        .mode-btn:hover:not(.active) { 
            background: var(--hover); 
        }
        
        main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background: radial-gradient(circle at 50% 0%, rgba(99, 102, 241, 0.1) 0%, transparent 50%); 
            padding-left: 0; 
            transition: padding-left 0.3s; 
        }
        
        #chat-window { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding: clamp(16px, 3vw, 24px) clamp(12px, 3vw, 24px); 
            display: flex; 
            flex-direction: column; 
            gap: clamp(16px, 3vw, 24px); 
            scroll-behavior: smooth; 
        }
        
        #thinking { 
            display: none; 
            padding: clamp(12px, 2vw, 14px) clamp(16px, 3vw, 20px); 
            margin: 0 clamp(12px, 3vw, 15%) clamp(12px, 2vw, 16px); 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--accent); 
            border-radius: 14px; 
            box-shadow: 0 0 20px var(--accent-glow); 
            animation: fadeIn 0.3s ease; 
        }
        
        .thinking-content { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--accent); 
            font-size: clamp(0.85rem, 2vw, 0.9rem); 
            font-weight: 500; 
        }
        
        .pulse { 
            width: 10px; 
            height: 10px; 
            background: var(--accent); 
            border-radius: 50%; 
            animation: pulse-ring 1.5s infinite; 
        }
        
        @keyframes pulse-ring { 
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 var(--accent-glow); } 
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px transparent; } 
            100% { transform: scale(0.9); } 
        }
        
        .msg { 
            max-width: 90%; 
            line-height: 1.7; 
            animation: slideIn 0.4s ease; 
            position: relative; 
        }
        
        .user { 
            align-self: flex-end; 
            background: linear-gradient(135deg, var(--panel-2), var(--panel)); 
            padding: clamp(12px, 2vw, 14px) clamp(16px, 2vw, 20px); 
            border-radius: 18px; 
            border-bottom-right-radius: 6px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.25); 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            font-size: clamp(0.9rem, 2vw, 1rem); 
        }
        
        .ai { 
            align-self: flex-start; 
            background: transparent; 
            width: 100%; 
            border-radius: 0; 
        }
        
        .ai-header { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 8px; 
            font-size: clamp(0.75rem, 1.5vw, 0.8rem); 
            font-weight: 600; 
            color: var(--accent); 
            letter-spacing: 0.5px; 
        }
        
        .ai-avatar { 
            width: 24px; 
            height: 24px; 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            box-shadow: 0 0 8px var(--accent-glow); 
            font-size: clamp(0.75rem, 1.5vw, 0.8rem); 
        }
        
        .ai-content { 
            color: var(--text); 
            padding-left: 32px; 
            font-size: clamp(0.9rem, 2vw, 1rem); 
        }
        
        .code-block-wrapper { 
            position: relative; 
            margin: 12px 0; 
            border-radius: 10px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
        }
        
        .copy-btn { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: var(--panel); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            color: var(--text-secondary); 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            padding: 4px 8px; 
            font-size: 0.7rem; 
            cursor: pointer; 
            opacity: 0; 
            transition: opacity 0.2s, transform 0.2s; 
            z-index: 10; 
        }
        
        .code-block-wrapper:hover .copy-btn { 
            opacity: 1; 
        }
        
        .copy-btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); 
        }
        
        .copy-btn.copied { 
            background: var(--success); 
            color: white; 
            border-color: var(--success); 
        }
        
        pre { 
            background: rgba(0, 0, 0, 0.4); 
            padding: clamp(12px, 2vw, 16px); 
            margin: 0; 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        .input-area { 
            padding: clamp(12px, 2vw, 20px) clamp(12px, 3vw, 15%); 
            background: linear-gradient(transparent, var(--bg) 60%); 
            position: relative; 
            padding-bottom: max(clamp(12px, 2vw, 20px), env(safe-area-inset-bottom)); 
        }
        
        .input-bar { 
            background: var(--input-bg); 
            backdrop-filter: var(--blur); 
            -webkit-backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            border-radius: 18px; 
            padding: 8px clamp(8px, 2vw, 14px); 
            display: flex; 
            align-items: end; 
            gap: clamp(6px, 1.5vw, 10px); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4); 
            transition: border-color 0.2s, box-shadow 0.2s; 
            position: relative;
            padding-left: 40px; /* Space for enhancer button */
        }
        
        textarea { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: white; 
            padding: 8px; 
            font-size: clamp(0.9rem, 2vw, 0.95rem); 
            outline: none; 
            resize: none; 
            max-height: 120px; 
            font-family: inherit; 
            line-height: 1.4; 
        }
        
        .send-btn, .stop-btn { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            border: none; 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
            color: white; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(0.9rem, 2vw, 1rem); 
            transition: all 0.2s; 
            flex-shrink: 0; 
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); 
        }
        
        .send-btn:hover, .stop-btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px var(--accent-glow); 
        }
        
        .stop-btn { 
            background: linear-gradient(135deg, var(--error), #dc2626); 
            box-shadow: 0 2px 8px var(--error-glow); 
        }
        
        body.generating .send-btn { 
            display: none; 
        }
        
        body.generating .stop-btn { 
            display: flex; 
        }
        
        .voice-btn { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            background: var(--panel-2); 
            color: var(--text-secondary); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(0.9rem, 2vw, 1rem); 
            transition: all 0.2s; 
            flex-shrink: 0; 
        }
        
        .voice-btn:hover { 
            background: var(--hover); 
            border-color: var(--accent); 
        }
        
        .voice-btn.recording { 
            background: linear-gradient(135deg, var(--error), #dc2626); 
            color: white; 
            border-color: var(--error); 
            animation: pulse-ring 1s infinite; 
        }
        
        .style-selector { 
            display: none; 
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px); 
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px); 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            gap: clamp(6px, 1.5vw, 10px); 
        }
        
        .style-selector.active { 
            display: flex; 
            animation: fadeIn 0.3s ease; 
        }
        
        .style-selector select { 
            flex: 1; 
            background: var(--input-bg); 
            color: var(--text); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 6px 10px; 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
        }
        
        .image-indicator { 
            background: var(--panel-2); 
            backdrop-filter: var(--blur); 
            border: 1px solid var(--accent); 
            border-radius: 8px; 
            padding: 4px 8px; 
            font-size: clamp(0.7rem, 1.5vw, 0.8rem); 
            color: var(--text-secondary); 
            display: none; 
            align-items: center; 
            gap: 4px; 
            margin-left: 8px; 
            max-width: 120px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .image-indicator.active { 
            display: flex; 
        }
        
        .token-counter-display { 
            font-size: clamp(0.6rem, 1.5vw, 0.7rem); 
            color: var(--text-secondary); 
            margin-top: 4px; 
            text-align: center; 
        }
        
        .mobile-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(4px); 
            -webkit-backdrop-filter: blur(4px); 
            z-index: 999; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .mobile-overlay.active { 
            display: block; 
            opacity: 1; 
        }
        
        /* ==========================================
           NEW: SEED DISPLAY & INPUT (–¢–ó #5)
           ========================================== */
        .seed-display {
            display: none;
            padding: 8px;
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-align: center;
            border-top: 1px solid var(--border);
            background: rgba(99, 102, 241, 0.05);
        }

        .seed-display.active {
            display: block;
        }

        .seed-input-container {
            display: none;
            margin: 0 clamp(12px, 3vw, 15%) clamp(8px, 2vw, 12px);
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 14px);
            background: var(--panel-2);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: 12px;
            gap: 8px;
        }

        .seed-input-container.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .seed-input {
            flex: 1;
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: clamp(0.8rem, 1.5vw, 0.85rem);
        }

        /* –¢–ó #4: Smart Status Display */
        .smart-status {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
            min-height: 1.2em;
        }

        @media (max-width: 768px) {
            #chat-list, .model-limits {
                scrollbar-width: thin;
                scrollbar-color: var(--border) transparent;
            }
            #chat-list::-webkit-scrollbar, .model-limits::-webkit-scrollbar {
                width: 4px;
            }
            #chat-list::-webkit-scrollbar-thumb, .model-limits::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 2px;
            }
        }
        
        @media (min-width: 769px) { 
            body { flex-direction: row; } 
            main { padding-left: 0; } 
            .mobile-menu-toggle { display: none !important; } 
            .mobile-overlay { display: none !important; } 
        }
        
        @media (max-width: 768px) { 
            body { flex-direction: column; padding-top: 60px; } 
            aside { 
                width: min(320px, 85vw); 
                max-width: 320px; 
                position: fixed; 
                left: -100%; 
                top: 0; 
                bottom: 0; 
                height: 100vh; 
                z-index: 1000; 
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            } 
            aside.visible { left: 0; }
            .mobile-menu-toggle { display: flex; } 
            .mobile-overlay { display: none; } 
            body.sidebar-open .mobile-overlay { display: block; } 
            main { width: 100%; padding-left: 0 !important; } 
            #chat-window { padding: clamp(12px, 3vw, 16px); gap: clamp(12px, 3vw, 16px); } 
            .mode-container { flex-direction: row; overflow-x: auto; gap: 8px; padding-bottom: 4px; } 
            .mode-btn { min-width: 100px; flex-shrink: 0; font-size: clamp(0.75rem, 1.5vw, 0.8rem); } 
            .input-area { padding: clamp(10px, 2vw, 12px); position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, var(--bg) 60%, var(--bg)); z-index: 100; } 
            .input-bar { border-radius: 16px; gap: clamp(4px, 1vw, 6px); padding-left: 36px; } 
            textarea { font-size: clamp(0.9rem, 2vw, 0.95rem); max-height: 100px; } 
            .voice-btn, .send-btn, .stop-btn { width: 40px; height: 40px; font-size: clamp(0.8rem, 2vw, 0.9rem); } 
            .prompt-enhancer-btn { width: 28px; height: 28px; font-size: 0.8rem; } 
            .welcome-msg h2 { font-size: clamp(1.2rem, 4vw, 1.5rem); } 
            .welcome-msg p { font-size: clamp(0.8rem, 2.5vw, 0.9rem); } 
            .token-counter-display { font-size: clamp(0.55rem, 1.5vw, 0.65rem); } 
            .style-selector { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); } 
            .persona-selector { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); } 
            .image-indicator { max-width: 100px; margin-left: 4px; } 
            .aspect-ratio-selector { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); }
            .seed-input-container { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); }
            .camera-controls { margin: 0 clamp(10px, 2vw, 12px) clamp(8px, 2vw, 10px); }
        }
        
        @media (max-width: 480px) { 
            .logo { font-size: 1.1rem; margin-bottom: 16px; } 
            .status-panel { padding: 12px; } 
            .section-title { font-size: 0.65rem; } 
            .btn, .mode-btn { min-height: 42px; padding: 8px 10px; } 
            .mode-btn { min-width: 80px; } 
            .voice-btn, .send-btn, .stop-btn { width: 38px; height: 38px; } 
            #thinking { margin: 0 12px 10px; } 
        }
        
        @media (min-width: 1440px) { 
            aside { width: 360px; } 
            #chat-window { padding: 32px 20%; } 
            .input-area { padding: 24px 20%; } 
        }
        
        .swipe-hint { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 4px; 
            transform: translateY(-50%); 
            color: var(--text-secondary); 
            font-size: 0.7rem; 
            writing-mode: vertical-rl; 
            text-orientation: mixed; 
            opacity: 0.6; 
        }
        
        @media (max-width: 768px) { 
            .swipe-hint { display: block; } 
        }

        .lazy-load-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            border: 1px dashed var(--border);
            border-radius: 8px;
            margin: 10px 0;
        }

        .lazy-load-placeholder:hover {
            background: var(--hover);
            border-style: solid;
        }

        /* MOBILE SCROLL OPTIMIZATIONS v3.65 */
        @media (max-width: 768px) {
            #chat-window {
                scroll-behavior: auto !important;
                touch-action: pan-y;
                will-change: scroll-position;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            
            .msg {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                will-change: transform;
            }
        }
    </style>
</head>
<body>

<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="–ú–µ–Ω—é">
    <i class="fas fa-bars"></i>
</button>

<!-- Mobile Overlay -->
<div class="mobile-overlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<aside id="sidebar">
    <div class="logo"><i class="fas fa-terminal"></i> NEXUS ULTRA v3.7</div>
    
    <!-- Theme Selector -->
    <div class="controls-section">
        <div class="section-title">–¢–µ–º–∞</div>
        <div class="theme-selector">
            <button class="theme-btn active" data-theme="default" onclick="changeTheme('default')">Default</button>
            <button class="theme-btn" data-theme="cyberpunk" onclick="changeTheme('cyberpunk')">Cyberpunk</button>
            <button class="theme-btn" data-theme="ocean" onclick="changeTheme('ocean')">Ocean</button>
            <button class="theme-btn" data-theme="forest" onclick="changeTheme('forest')">Forest</button>
        </div>
    </div>

    <!-- Folder Management -->
    <div class="controls-section">
        <div class="section-title">–ü–∞–ø–∫–∏</div>
        <div id="folders-list"></div>
        <button class="btn" onclick="createFolder()">
            <i class="fas fa-folder-plus"></i> –ù–æ–≤–∞—è –ø–∞–ø–∫–∞
        </button>
    </div>

    <!-- Chat list -->
    <div class="controls-section">
        <div class="section-title">–ß–∞—Ç—ã</div>
        <div class="model-limits" id="chat-list" style="max-height: 150px;"></div>
        <button class="btn" onclick="createChat()">
            <i class="fas fa-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç
        </button>
    </div>

    <div class="status-panel">
        <div class="status-item">
            <span>–°—Ç–∞—Ç—É—Å:</span>
            <span id="connection-status">–û—Ñ—Ñ–ª–∞–π–Ω</span>
            <span id="status-indicator" class="status-indicator"></span>
        </div>
        <div class="status-item">
            <span>–†–µ–∂–∏–º:</span>
            <span id="current-mode-display">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</span>
        </div>
        <div class="status-item">
            <span>–¢–æ–∫–µ–Ω–æ–≤:</span>
            <span id="token-counter">0</span>
        </div>
        <div class="token-counter-display">
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞ —Å–µ—Å—Å–∏—é: <span id="session-tokens">0</span>
        </div>
    </div>

    <div class="controls-section">
        <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        <button class="btn" onclick="toggleAutoModel()">
            <i class="fas fa-robot" id="auto-model-icon"></i> <span id="auto-model-text">–í–∫–ª –∞–≤—Ç–æ-–≤—ã–±–æ—Ä</span>
        </button>
        <button class="btn" onclick="toggleHdMode()">
            <i class="fas fa-hd" id="hd-mode-icon"></i> <span id="hd-mode-text">HD –†–µ–∂–∏–º</span>
        </button>
        <button class="btn" onclick="clearChat()">
            <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
        </button>
        <button class="btn" onclick="exportChat()">
            <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞
        </button>
        <button class="btn" onclick="exportAllData()">
            <i class="fas fa-archive"></i> –°–∫–∞—á–∞—Ç—å –≤—Å—ë
        </button>
        <button class="btn" onclick="showCommands()">
            <i class="fas fa-question-circle"></i> –ö–æ–º–∞–Ω–¥—ã
        </button>
    </div>

    <div class="controls-section">
        <div class="section-title">–õ–∏–º–∏—Ç—ã –º–æ–¥–µ–ª–µ–π <span id="limits-refresh-time"></span></div>
        <div class="model-limits" id="model-limits"></div>
        <button class="btn" onclick="updateAllLimits()" style="margin-top: 8px;">
            <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç—ã
        </button>
    </div>

    <div class="controls-section">
        <div class="section-title">–†–µ–∂–∏–º—ã</div>
        <div class="mode-container">
            <div id="mode-normal" class="mode-btn active" onclick="setMode('normal')">
                <i class="fas fa-bolt"></i> –°—Ç–∞–Ω–¥–∞—Ä—Ç
            </div>
            <div id="mode-search" class="mode-btn" onclick="setMode('search')">
                <i class="fas fa-search"></i> –ü–æ–∏—Å–∫
            </div>
            <div id="mode-deep" class="mode-btn" onclick="setMode('deep')">
                <i class="fas fa-brain"></i> –ì–ª—É–±–æ–∫–∏–π
            </div>
            <div id="mode-art" class="mode-btn" onclick="setMode('art')">
                <i class="fas fa-palette"></i> –•—É–¥–æ–∂–Ω–∏–∫
            </div>
        </div>
    </div>

    <div style="margin-top: auto;">
        <div class="section-title">API Key</div>
        <input type="password" id="key" class="key-input" placeholder="sk-or-..." title="–í–∞—à API –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª—è–º">
        <div id="key-status" style="font-size: 0.7rem; margin-top: 4px; text-align: center;"></div>
        <!-- v3.7: –†–µ–∑–µ—Ä–≤–Ω—ã–π –∫–ª—é—á -->
        <div class="section-title" style="margin-top: 12px;">–†–µ–∑–µ—Ä–≤–Ω—ã–π API Key</div>
        <input type="password" id="backup-key" class="key-input" placeholder="sk-or-..." title="–†–µ–∑–µ—Ä–≤–Ω—ã–π API –∫–ª—é—á –¥–ª—è –±–µ—Å—à–æ–≤–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏">
    </div>
</aside>

<!-- Swipe hint -->
<div class="swipe-hint">
    <i class="fas fa-chevron-right"></i> –°–≤–∞–π–ø
</div>

<main>
    <div id="chat-window" role="log">
        <div class="welcome-msg">
            <h2>üöÄ Nexus Ultra v3.7</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –ª—É—á—à—É—é –º–æ–¥–µ–ª—å</p>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                <i class="fas fa-info-circle"></i> 22 –º–æ–¥–µ–ª–∏ | –£–º–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è | –í–µ–±-–ø–æ–∏—Å–∫ | –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º | –ú—É–ª—å—Ç–∏-—á–∞—Ç | –ü–∞–ø–∫–∏ | –°–∏–¥-—Ä–µ–∂–∏–º | –ê—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ | –£–º–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã
            </p>
        </div>
    </div>

    <div class="search-indicator" id="search-indicator">
        <i class="fas fa-search"></i>
        <span id="search-text">–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...</span>
    </div>

    <div id="thinking" role="status">
        <div class="thinking-content">
            <div class="pulse"></div>
            <span id="thinking-text">–ê–Ω–∞–ª–∏–∑...</span>
        </div>
        <!-- –¢–ó #4: –£–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã -->
        <div class="smart-status" id="smart-status"></div>
    </div>

    <!-- Seed Input Container (–¢–ó #5) -->
    <div class="seed-input-container" id="seed-input-container">
        <input type="text" class="seed-input" id="seed-input" placeholder="–í–≤–µ–¥–∏—Ç–µ seed –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ">
        <button class="btn" onclick="loadSeedFromHistory()" style="min-width: 80px; margin: 0;">
            <i class="fas fa-history"></i>
        </button>
    </div>

    <!-- Persona Selector -->
    <div class="persona-selector" id="persona-selector">
        <select id="persona-select" onchange="changePersona(this.value)">
            <option value="">–ë–µ–∑ –ø–µ—Ä—Å–æ–Ω—ã</option>
            <option value="coder">üíª Expert Coder</option>
            <option value="writer">‚úçÔ∏è Creative Writer</option>
            <option value="vision">üé® Nexus Vision</option>
        </select>
    </div>

    <!-- Style selector for Art mode -->
    <div class="style-selector" id="style-selector">
        <select id="art-style-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å...</option>
            <option value="oil_painting">üé® –ú–∞—Å–ª–æ (–†–µ–º–±—Ä–∞–Ω–¥—Ç)</option>
            <option value="watercolor">üíß –ê–∫–≤–∞—Ä–µ–ª—å (–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º)</option>
            <option value="cyberpunk">üåÉ –ö–∏–±–µ—Ä–ø–∞–Ω–∫</option>
            <option value="vangogh">üåª –í–∞–Ω –ì–æ–≥</option>
            <option value="ghibli">üèÆ –ê–Ω–∏–º–µ (–ì–∏–±–ª–∏)</option>
            <option value="sketch">‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à–Ω—ã–π —ç—Å–∫–∏–∑</option>
        </select>
    </div>

    <!-- Aspect Ratio Selector (–¢–ó #4) -->
    <div class="aspect-ratio-selector" id="aspect-ratio-selector">
        <button class="aspect-btn" data-ratio="1:1" onclick="setAspectRatio('1:1')" title="–ö–≤–∞–¥—Ä–∞—Ç">
            <i class="fas fa-square"></i> 1:1
        </button>
        <button class="aspect-btn active" data-ratio="16:9" onclick="setAspectRatio('16:9')" title="–ö–∏–Ω–æ/–ü–µ–π–∑–∞–∂">
            <i class="fas fa-rectangle-wide"></i> 16:9
        </button>
        <button class="aspect-btn" data-ratio="9:16" onclick="setAspectRatio('9:16')" title="–ü–æ—Ä—Ç—Ä–µ—Ç/Story">
            <i class="fas fa-rectangle-portrait"></i> 9:16
        </button>
        <button class="aspect-btn" data-ratio="21:9" onclick="setAspectRatio('21:9')" title="–£–ª—å—Ç—Ä–∞—à–∏—Ä–æ–∫–∏–π">
            <i class="fas fa-rectangle-wide"></i> 21:9
        </button>
    </div>

    <!-- Camera Controls (–¢–ó #3) -->
    <div class="camera-controls" id="camera-controls">
        <button class="camera-btn" data-angle="close" onclick="setCameraAngle('close')" title="–ö—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω">
            <i class="fas fa-search-plus"></i> –ö—Ä—É–ø–Ω—ã–π
        </button>
        <button class="camera-btn active" data-angle="wide" onclick="setCameraAngle('wide')" title="–û–±—â–∏–π –ø–ª–∞–Ω">
            <i class="fas fa-search-minus"></i> –û–±—â–∏–π
        </button>
        <button class="camera-btn" data-angle="low" onclick="setCameraAngle('low')" title="–ö–∏–Ω–æ-—Ä–∞–∫—É—Ä—Å">
            <i class="fas fa-video"></i> –ö–∏–Ω–æ-—Ä–∞–∫—É—Ä—Å
        </button>
    </div>

    <div class="input-area">
        <div class="input-bar">
            <button class="prompt-enhancer-btn" onclick="enhancePrompt()" title="–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º–ø—Ç">
                <i class="fas fa-magic"></i>
            </button>

            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <button class="voice-btn" onclick="document.getElementById('image-upload').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                <i class="fas fa-image"></i>
            </button>
            
            <textarea id="u-in" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            
            <div class="image-indicator" id="image-indicator">
                <i class="fas fa-image"></i> <span id="image-name">–§–∞–π—Ä –∑–∞–≥—Ä—É–∂–µ–Ω</span>
            </div>
            
            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceRecording()" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button class="send-btn" onclick="send()"><i class="fas fa-paper-plane"></i></button>
            <button class="stop-btn" onclick="stopGeneration()"><i class="fas fa-stop"></i></button>
        </div>
    </div>
</main>

<script>
    // ==========================================
    // THEME MANAGEMENT
    // ==========================================
    function changeTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('nexus_theme', theme);
        
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
    }

    // ==========================================
    // SIDEBAR TOGGLE FOR MOBILE
    // ==========================================
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.mobile-overlay');
        const isOpen = sidebar.classList.contains('visible');
        
        if (isOpen) {
            closeSidebar();
        } else {
            sidebar.classList.add('visible');
            overlay.classList.add('active');
            document.body.classList.add('sidebar-open');
        }
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.mobile-overlay');
        sidebar.classList.remove('visible');
        overlay.classList.remove('active');
        document.body.classList.remove('sidebar-open');
    }

    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        const screenWidth = window.innerWidth;
        const swipeDistance = touchEndX - touchStartX;
        
        if (swipeDistance > 50 && touchStartX < 20) {
            toggleSidebar();
        }
        
        if (swipeDistance < -50 && touchStartX > screenWidth - 20) {
            closeSidebar();
        }
    }

    // ==========================================
    // FOLDER SYSTEM
    // ==========================================
    let folders = {};
    let currentFolderId = null;

    function createFolder(name = null) {
        const id = 'folder_' + Date.now();
        const folderName = name || prompt('üìÅ –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏:') || `–ü–∞–ø–∫–∞ ${Object.keys(folders).length + 1}`;
        
        folders[id] = {
            id: id,
            name: folderName,
            chatIds: [],
            collapsed: false
        };
        
        saveFolders();
        updateFoldersList();
        updateChatList();
        
        return id;
    }

    function deleteFolder(folderId) {
        if (!confirm(`‚ùì –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${folders[folderId].name}" –∏ –≤—Å–µ —á–∞—Ç—ã –≤ –Ω–µ–π?`)) return;
        
        folders[folderId].chatIds.forEach(chatId => {
            if (chats[chatId]) {
                delete chats[chatId];
            }
        });
        
        delete folders[folderId];
        
        if (currentFolderId === folderId) {
            currentFolderId = null;
        }
        
        saveFolders();
        saveChats();
        updateFoldersList();
        updateChatList();
    }

    function toggleFolder(folderId) {
        folders[folderId].collapsed = !folders[folderId].collapsed;
        saveFolders();
        updateFoldersList();
    }

    function moveChatToFolder(chatId, folderId) {
        Object.values(folders).forEach(folder => {
            folder.chatIds = folder.chatIds.filter(id => id !== chatId);
        });
        
        if (folderId && folders[folderId]) {
            folders[folderId].chatIds.push(chatId);
        }
        
        saveFolders();
        updateFoldersList();
        updateChatList();
    }

    function updateFoldersList() {
        const container = document.getElementById('folders-list');
        container.innerHTML = '';
        
        const rootItem = document.createElement('div');
        rootItem.className = 'folder-item';
        rootItem.innerHTML = `
            <div class="folder-header" onclick="selectFolder(null)">
                <span><i class="fas fa-home"></i> –ö–æ—Ä–Ω–µ–≤–∞—è</span>
                <span style="font-size: 0.7rem;">${Object.values(chats).filter(c => !c.folderId).length}</span>
            </div>
        `;
        rootItem.style.opacity = currentFolderId === null ? '1' : '0.6';
        container.appendChild(rootItem);
        
        Object.values(folders).forEach(folder => {
            const item = document.createElement('div');
            item.className = 'folder-item';
            
            const chatCount = folder.chatIds.filter(id => chats[id]).length;
            item.innerHTML = `
                <div class="folder-header" onclick="toggleFolder('${folder.id}')">
                    <span><i class="fas fa-folder"></i> ${folder.name}</span>
                    <span style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-size: 0.7rem;">${chatCount}</span>
                        <button class="chat-delete" onclick="event.stopPropagation(); deleteFolder('${folder.id}')" style="width: 20px; height: 20px; border-radius: 4px; background: var(--error); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                </div>
                <div class="folder-content ${folder.collapsed ? '' : 'active'}" id="folder-${folder.id}">
                    ${folder.collapsed ? '' : `<small style="color: var(--text-secondary);">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —á–∞—Ç—ã —Å—é–¥–∞</small>`}
                </div>
            `;
            
            container.appendChild(item);
        });
    }

    function selectFolder(folderId) {
        currentFolderId = folderId;
        updateFoldersList();
        updateChatList();
    }

    // ==========================================
    // PROMPT ENHANCEMENT SYSTEM (v3.65)
    // ==========================================
    const PROMPT_ENHANCEMENTS = {
        '–Ω–∞—Ä–∏—Å—É–π': 'hyper-realistic masterpiece, cinematic lighting, 8k quality, ultra-detailed, professional digital art, trending on ArtStation',
        '–∏–∑–æ–±—Ä–∞–∑–∏': 'photorealistic rendering, sharp focus, dramatic composition, studio quality, high resolution',
        '—Å–æ–∑–¥–∞–π': 'stunning visual creation, artistic excellence, detailed craftsmanship, premium quality',
        '–æ–ø–∏—à–∏': 'comprehensive detailed description, vivid imagery, rich context, thorough analysis',
        '–Ω–∞–ø–∏—à–∏': 'creative compelling narrative, engaging storytelling, professional writing style',
        '–∫–æ–¥': 'clean efficient code, best practices, modern programming standards, well-documented',
        '—Å–¥–µ–ª–∞–π': 'professional implementation, optimized solution, expert methodology',
        '–ø–æ–∫–∞–∂–∏': 'visual demonstration, clear illustration, detailed showcase',
        '–æ–±—ä—è—Å–Ω–∏': 'thorough explanation, educational clarity, step-by-step breakdown',
        'default': 'professional quality, detailed response, expert analysis, comprehensive answer'
    };

    function enhancePrompt() {
        const input = document.getElementById('u-in');
        const text = input.value.trim();
        
        if (!text) {
            alert('üìù –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç!');
            return;
        }

        const lowerText = text.toLowerCase();
        let enhancement = PROMPT_ENHANCEMENTS.default;
        
        for (let [key, value] of Object.entries(PROMPT_ENHANCEMENTS)) {
            if (lowerText.startsWith(key)) {
                enhancement = value;
                break;
            }
        }

        const enhancedText = text + ', ' + enhancement;
        input.value = enhancedText;
        autoResize();
        
        const enhancerBtn = document.querySelector('.prompt-enhancer-btn');
        enhancerBtn.style.color = 'var(--success)';
        enhancerBtn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            enhancerBtn.style.color = '';
            enhancerBtn.innerHTML = '<i class="fas fa-magic"></i>';
        }, 1500);
    }

    // ==========================================
    // PERSONA SYSTEM
    // ==========================================
    const PERSONAS = {
        'coder': {
            name: 'Expert Coder',
            systemPrompt: 'You are an expert programmer with 20+ years of experience. Write clean, efficient, modern code following best practices. Always explain your code, provide examples, and suggest optimizations. Use proper documentation and comments.',
            icon: 'üíª'
        },
        'writer': {
            name: 'Creative Writer',
            systemPrompt: 'You are a creative writing assistant with exceptional storytelling skills. Help users craft compelling narratives, poetry, articles, and creative content. Focus on style, tone, emotional impact, and originality.',
            icon: '‚úçÔ∏è'
        },
        'vision': {
            name: 'Nexus Vision',
            systemPrompt: 'You are Nexus Vision, an AI specialized in image generation and visual analysis. Always append /img to requests for visual content. Provide detailed visual descriptions and artistic guidance.',
            icon: 'üé®'
        }
    };

    let currentPersona = null;

    function changePersona(personaId) {
        currentPersona = personaId || null;
        localStorage.setItem('nexus_persona', currentPersona || '');
        
        const selector = document.getElementById('persona-select');
        if (personaId) {
            selector.style.borderColor = 'var(--accent)';
            selector.style.boxShadow = '0 0 8px var(--accent-glow)';
        } else {
            selector.style.borderColor = 'var(--border)';
            selector.style.boxShadow = '';
        }
    }

    // ==========================================
    // ART ASSISTANT FEATURES
    // ==========================================
    const STYLES_DB = {
        'oil_painting': {
            name: '–ú–∞—Å–ª–æ (–†–µ–º–±—Ä–∞–Ω–¥—Ç)',
            prompt: 'Professional oil painting style, classical realism, rich textures, Rembrandt lighting, masterpiece quality, detailed brushwork'
        },
        'watercolor': {
            name: '–ê–∫–≤–∞—Ä–µ–ª—å (–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º)',
            prompt: 'Beautiful watercolor technique, soft washes, translucent layers, impressionistic style, fluid and expressive'
        },
        'cyberpunk': {
            name: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫',
            prompt: 'Cyberpunk aesthetic, neon lights, rain-slicked streets, Blade Runner style, dystopian future, high contrast, vivid colors'
        },
        'vangogh': {
            name: '–í–∞–Ω –ì–æ–≥',
            prompt: 'Van Gogh painting style, bold expressive brushstrokes, vibrant colors, post-impressionist, emotional intensity'
        },
        'ghibli': {
            name: '–ê–Ω–∏–º–µ (–ì–∏–±–ª–∏)',
            prompt: 'Studio Ghibli anime style, soft pastel colors, detailed backgrounds, whimsical, magical atmosphere, hand-drawn aesthetic'
        },
        'sketch': {
            name: '–ö–∞—Ä–∞–Ω–¥–∞—à–Ω—ã–π —ç—Å–∫–∏–∑',
            prompt: 'Detailed pencil sketch, artistic line art, professional shading, cross-hatching, monochromatic mastery'
        }
    };

    // IMAGE GENERATION STYLES
    const IMAGE_STYLES = {
        'anime': 'Anime style, manga illustration, detailed anime artwork',
        'realistic': 'Photorealistic, hyperrealism, 8k ultra realistic',
        'oil': 'Oil painting style, art gallery quality, impasto technique',
        'watercolor': 'Watercolor painting, soft washes, artistic',
        'sketch': 'Pencil sketch, line art, monochromatic',
        'cyberpunk': 'Cyberpunk aesthetic, neon lights, dystopian',
        'fantasy': 'Fantasy art, magical atmosphere, epic fantasy',
        'abstract': 'Abstract art, conceptual, modern art',
        'portrait': 'Professional portrait, studio lighting',
        'landscape': 'Epic landscape, cinematic lighting'
    };

    // ==========================================
    // v3.7: SMART PRESETS (Style Dictionary)
    // ==========================================
    const SMART_PRESETS = {
        'cinematic': {
            keywords: ['cinematic', '–∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω–æ', '–∫–∏–Ω–æ', 'film'],
            prompt: '(masterpiece, cinematic lighting, 8k, highly detailed, shot on 35mm lens, depth of field)'
        },
        'portrait': {
            keywords: ['portrait', '–ø–æ—Ä—Ç—Ä–µ—Ç'],
            prompt: '(professional portrait, sharp focus, detailed face, studio lighting, 85mm lens)'
        },
        'landscape': {
            keywords: ['landscape', '–ø–µ–π–∑–∞–∂', 'scenery'],
            prompt: '(breathtaking landscape, epic scenery, wide angle, atmospheric, 16mm lens)'
        }
    };

    // ==========================================
    // v3.7: Camera Angles Dictionary
    // ==========================================
    const CAMERA_ANGLES = {
        'close': 'close-up shot, facial detail, shallow depth of field, focused on face',
        'wide': 'wide angle shot, full body, landscape view, environmental composition',
        'low': 'low angle shot, epic perspective, heroic composition, dramatic viewpoint'
    };

    let currentCameraAngle = 'wide'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

    function setCameraAngle(angle) {
        currentCameraAngle = angle;
        document.querySelectorAll('.camera-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.angle === angle);
        });
        localStorage.setItem('nexus_camera_angle', angle);
    }

    // ==========================================
    // v3.7: Enhanced Negative Prompts with Anatomy Filter
    // ==========================================
    const NEGATIVE_PROMPTS = 'lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry, extra limbs, fused fingers, mutated hands, missing fingers, two heads, hands instead of feet, logo on shoulder instead of chest';
    
    const ANATOMY_FILTER = 'extra limbs, fused fingers, mutated hands, missing fingers, two heads, hands instead of feet, logo on shoulder instead of chest';

    function enhanceImagePrompt(originalPrompt) {
        const lowerPrompt = originalPrompt.toLowerCase();
        let enhancements = [];
        
        // –¢–ó #2: Prompt Expansion for short prompts
        const wordCount = originalPrompt.split(/\s+/).length;
        if (wordCount <= 3) {
            enhancements.push('8k resolution, cinematic lighting, masterpiece, highly detailed textures, professional color grading, ultra-detailed');
        }
        
        if (!lowerPrompt.includes('quality') && !lowerPrompt.includes('–∫–∞—á–µ—Å—Ç–≤–æ')) {
            enhancements.push('masterpiece, best quality, ultra detailed');
        }
        
        if (!lowerPrompt.includes('light') && !lowerPrompt.includes('lighting') && 
            !lowerPrompt.includes('—Å–≤–µ—Ç') && !lowerPrompt.includes('–æ—Å–≤–µ—â–µ–Ω–∏–µ')) {
            enhancements.push('professional lighting, cinematic');
        }
        
        if (!lowerPrompt.includes('4k') && !lowerPrompt.includes('8k') && !lowerPrompt.includes('hd')) {
            enhancements.push('8k, high resolution');
        }
        
        if (lowerPrompt.includes('–ø–æ—Ä—Ç—Ä–µ—Ç') || lowerPrompt.includes('portrait')) {
            enhancements.push('professional portrait, detailed face, sharp focus');
        }
        if (lowerPrompt.includes('–ø–µ–π–∑–∞–∂') || lowerPrompt.includes('landscape')) {
            enhancements.push('breathtaking landscape, epic scenery, atmospheric');
        }
        if (lowerPrompt.includes('–∫–æ—Ç') || lowerPrompt.includes('—Å–æ–±–∞–∫–∞') || lowerPrompt.includes('–∂–∏–≤–æ—Ç–Ω–æ–µ')) {
            enhancements.push('cute, detailed fur, expressive eyes');
        }
        
        // –¢–ó #3: Smart Presets
        for (const [style, config] of Object.entries(SMART_PRESETS)) {
            if (config.keywords.some(keyword => lowerPrompt.includes(keyword))) {
                enhancements.push(config.prompt);
                break;
            }
        }
        
        const basePrompt = originalPrompt.trim();
        const uniqueEnhancements = [...new Set(enhancements)];
        
        return uniqueEnhancements.length > 0 
            ? `${basePrompt}, ${uniqueEnhancements.join(', ')}` 
            : basePrompt;
    }

    // ==========================================
    // 22 MODELS ARRAY for v3.65
    // ==========================================
    const FALLBACK_MODELS = [
        'deepseek/deepseek-chat:free',
        'meta-llama/llama-3.3-70b-instruct:free',
        'google/gemini-flash-1.5:free',
        'qwen/qwen-2.5-72b-instruct:free',
        'anthropic/claude-3-haiku-20240307',
        'anthropic/claude-3.5-haiku-20241022:free',
        'meta-llama/llama-3.1-70b-instruct:free',
        'mistralai/mistral-large-2411:free',
        'mistralai/mistral-7b-instruct:free',
        'meta-llama/llama-3.1-8b-instruct:free',
        'cohere/command-r:free',
        'openchat/openchat-7b:free',
        'gryphe/mythomist-7b:free',
        'nousresearch/nous-hermes-2-mixtral-8x7b-dpo:free',
        'microsoft/phi-3-medium-128k-instruct:free',
        'jondurbin/airoboros-l2-70b:free',
        'gryphe/mythomax-l2-13b:free',
        'huggingfaceh4/zephyr-7b-beta:free',
        'undi95/toppy-m-7b:free',
        'lizpreciatel/lzlv-70b-fp16-hf:free',
        '01-ai/yi-34b-chat:free',
        'cognitivecomputations/dolphin-mixtral-8x7b:free'
    ];

    // ==========================================
    // v3.7: Seamless Rotation System
    // ==========================================
    const BACKUP_KEYS = [];
    let currentKeyIndex = 0;
    let isUsingBackupKey = false;

    function loadBackupKeys() {
        const saved = localStorage.getItem('nexus_backup_keys');
        if (saved) {
            BACKUP_KEYS.push(...JSON.parse(saved));
        }
        const backupKeyInput = document.getElementById('backup-key');
        if (backupKeyInput.value) {
            BACKUP_KEYS.push(backupKeyInput.value);
            localStorage.setItem('nexus_backup_keys', JSON.stringify(BACKUP_KEYS));
        }
    }

    // ==========================================
    // ENHANCED MODELS (25+ MODELS)
    // ==========================================
    const CONFIG = {
        MAX_HISTORY_LEN: 50,
        TYPING_SPEED: 30,
        MODELS: [
            /* TOP TIER - MOST RELIABLE */
            { id: 'deepseek/deepseek-chat:free', name: 'DeepSeek Chat', free: true, vision: false, reliable: true, tier: 'S' },
            { id: 'meta-llama/llama-3.3-70b-instruct:free', name: 'Llama 3.3 70B', free: true, vision: false, reliable: true, tier: 'S' },
            { id: 'google/gemini-flash-1.5:free', name: 'Gemini Flash', free: true, vision: true, reliable: true, tier: 'S' },
            { id: 'qwen/qwen-2.5-72b-instruct:free', name: 'Qwen 2.5 72B', free: true, vision: false, reliable: true, tier: 'S' },
            { id: 'anthropic/claude-3-haiku-20240307', name: 'Claude 3 Haiku', free: true, vision: false, reliable: true, tier: 'S' },
            /* EMERGENCY BACKUP - CLASSIC RELIABLE */
            { id: 'anthropic/claude-3.5-haiku-20241022:free', name: 'Claude 3.5 Haiku', free: true, vision: false, reliable: true, tier: 'A' },
            { id: 'meta-llama/llama-3.1-70b-instruct:free', name: 'Llama 3.1 70B', free: true, vision: false, reliable: true, tier: 'A' },
            { id: 'mistralai/mistral-large-2411:free', name: 'Mistral Large', free: true, vision: false, reliable: true, tier: 'A' },
            /* GOOD TIER */
            { id: 'mistralai/mistral-7b-instruct:free', name: 'Mistral 7B', free: true, vision: false, reliable: false, tier: 'B' },
            { id: 'meta-llama/llama-3.1-8b-instruct:free', name: 'Llama 3.1 8B', free: true, vision: false, reliable: false, tier: 'B' },
            { id: 'cohere/command-r:free', name: 'Command R', free: true, vision: false, reliable: false, tier: 'B' },
            /* MEDIUM TIER - EXPERIMENTAL */
            { id: 'openchat/openchat-7b:free', name: 'OpenChat 7B', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'gryphe/mythomist-7b:free', name: 'MythoMist 7B', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'nousresearch/nous-hermes-2-mixtral-8x7b-dpo:free', name: 'Nous Hermes', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'microsoft/phi-3-medium-128k-instruct:free', name: 'Phi-3 Medium', free: true, vision: false, reliable: false, tier: 'C' },
            { id: 'jondurbin/airoboros-l2-70b:free', name: 'Airoboros 70B', free: true, vision: false, reliable: false, tier: 'C' },
            /* FALLBACK TIER - LAST RESORT */
            { id: 'gryphe/mythomax-l2-13b:free', name: 'MythoMax 13B', free: true, vision: false, reliable: false, tier: 'D' },
            { id: 'huggingfaceh4/zephyr-7b-beta:free', name: 'Zephyr 7B', free: true, vision: false, reliable: false, tier: 'D' },
            { id: 'undi95/toppy-m-7b:free', name: 'Toppy 7B', free: true, vision: false, reliable: false, tier: 'D' },
            { id: 'lizpreciatel/lzlv-70b-fp16-hf:free', name: 'LZLV 70B', free: true, vision: false, reliable: false, tier: 'D' },
            /* ULTRA EMERGENCY - ALWAYS AVAILABLE */
            { id: '01-ai/yi-34b-chat:free', name: 'Yi 34B', free: true, vision: false, reliable: true, tier: 'EMG' },
            { id: 'cognitivecomputations/dolphin-mixtral-8x7b:free', name: 'Dolphin Mixtral', free: true, vision: false, reliable: true, tier: 'EMG' },
            { id: 'rwkv/rwkv-5-world-7b:free', name: 'RWKV 7B', free: true, vision: false, reliable: true, tier: 'EMG' },
            /* TESTING ZONE */
            { id: 'google/gemini-flash-1.5-8b-exp', name: 'Gemini Flash 8B', free: true, vision: true, reliable: false, tier: 'TEST' }
        ]
    };

    // ==========================================
    // ENHANCED CHAT SYSTEM
    // ==========================================
    let chats = {};
    let currentChatId = null;
    let currentMode = 'normal';
    let autoModelEnabled = false;
    let modelLimits = {};
    let abortController = null;
    let uploadedImage = null;
    let sessionTokenCount = 0;
    let limitsCache = { data: null, timestamp: 0 };
    let history = [];
    let currentImageStyle = 'realistic';
    let isEmergencyMode = false;
    let hdModeEnabled = false;
    let lastLimitUpdate = 0;
    let messagesLoaded = 20;
    let maxMessagesToShow = 20;

    // ==========================================
    // NEW: ASPECT RATIO SYSTEM (–¢–ó #4)
    // ==========================================
    let currentAspectRatio = '16:9'; // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ 16:9 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    function setAspectRatio(ratio) {
        currentAspectRatio = ratio;
        document.querySelectorAll('.aspect-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.ratio === ratio);
        });
        localStorage.setItem('nexus_aspect_ratio', ratio);
    }

    // ==========================================
    // NEW: SEED MANAGEMENT (–¢–ó #5)
    // ==========================================
    let currentSeed = null;
    let imageHistory = []; // Store image seeds for reuse

    function saveSeed(seed, prompt, url) {
        imageHistory.unshift({
            seed: seed,
            prompt: prompt,
            url: url,
            timestamp: Date.now(),
            aspectRatio: currentAspectRatio,
            style: currentImageStyle,
            cameraAngle: currentCameraAngle
        });
        
        // Keep only last 10 images
        if (imageHistory.length > 10) {
            imageHistory = imageHistory.slice(0, 10);
        }
        
        localStorage.setItem('nexus_image_seeds', JSON.stringify(imageHistory));
    }

    function loadSeedFromHistory() {
        if (imageHistory.length === 0) {
            alert('üì∑ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—É—Å—Ç–∞. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–Ω–∞—á–∞–ª–∞.');
            return;
        }

        const historyHtml = imageHistory.map((img, i) => 
            `<div style="margin: 8px 0; padding: 8px; background: var(--panel-2); border-radius: 8px; cursor: pointer;" onclick="useSeed('${img.seed}')">
                <img src="${img.url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 8px;">
                <span style="font-size: 0.7rem;">${img.prompt.substring(0, 30)}...</span>
                <br><small style="color: var(--text-secondary);">Seed: ${img.seed} | ${img.style} | ${img.aspectRatio}</small>
            </div>`
        ).join('');

        const modal = document.createElement('div');
        modal.className = 'image-modal';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        modal.innerHTML = `
            <div style="background: var(--panel); padding: 20px; border-radius: 12px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                <h3 style="margin-top: 0;">üì∑ –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h3>
                ${historyHtml}
                <button class="btn" onclick="this.parentNode.parentNode.remove()" style="margin-top: 12px; width: 100%;">
                    <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function useSeed(seed) {
        document.getElementById('seed-input').value = seed;
        currentSeed = seed;
        document.querySelector('.image-modal')?.remove();
        alert(`‚úÖ Seed ${seed} –∑–∞–≥—Ä—É–∂–µ–Ω. –°–ª–µ–¥—É—é—â–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –∑–µ—Ä–Ω–æ.`);
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ UI
        const seedContainer = document.getElementById('seed-input-container');
        seedContainer.style.borderColor = 'var(--success)';
        seedContainer.style.boxShadow = '0 0 8px var(--success-glow)';
        setTimeout(() => {
            seedContainer.style.borderColor = 'var(--border)';
            seedContainer.style.boxShadow = '';
        }, 2000);
    }

    // ==========================================
    // CHAT MANAGEMENT WITH FOLDERS
    // ==========================================
    function createChat(title = null) {
        const id = 'chat_' + Date.now();
        const chatTitle = title || `–ß–∞—Ç ${Object.keys(chats).length + 1}`;
        
        chats[id] = {
            id: id,
            title: chatTitle,
            history: [],
            sessionTokenCount: 0,
            createdAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            folderId: currentFolderId
        };
        
        switchChat(id);
        saveChats();
        updateChatList();
        
        document.getElementById('chat-window').innerHTML = `
            <div class="welcome-msg">
                <h2>üöÄ ${chatTitle}</h2>
                <p>–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É</p>
            </div>
        `;
        
        return id;
    }

    function switchChat(chatId) {
        if (!chats[chatId]) return;
        
        currentChatId = chatId;
        const chat = chats[chatId];
        
        history = [...chat.history];
        sessionTokenCount = chat.sessionTokenCount || 0;
        uploadedImage = null;
        document.getElementById('image-indicator').classList.remove('active');
        
        messagesLoaded = Math.min(maxMessagesToShow, history.length);
        
        renderChatHistory();
        updateChatList();
        saveChats();
        
        if (window.innerWidth <= 768) {
            setTimeout(closeSidebar, 300);
        }
    }

    function deleteChat(chatId) {
        const chatCount = Object.keys(chats).length;
        const folderChatCount = Object.values(folders).reduce((sum, folder) => sum + folder.chatIds.filter(id => chats[id]).length, 0);
        const rootChatCount = chatCount - folderChatCount;
        
        const chat = chats[chatId];
        const isInFolder = chat.folderId;
        const targetCount = isInFolder ? folderChatCount : rootChatCount;
        
        if (targetCount <= 1) {
            alert('‚ö†Ô∏è –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ!');
            return;
        }
        
        if (!confirm(`‚ùì –£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${chat.title}"?`)) return;
        
        if (chat.folderId && folders[chat.folderId]) {
            folders[chat.folderId].chatIds = folders[chat.folderId].chatIds.filter(id => id !== chatId);
        }
        
        delete chats[chatId];
        
        if (currentChatId === chatId) {
            const firstChatId = Object.keys(chats)[0];
            switchChat(firstChatId);
        }
        
        saveChats();
        saveFolders();
        updateChatList();
    }

    function updateChatList() {
        const container = document.getElementById('chat-list');
        container.innerHTML = '';
        
        const filteredChats = Object.values(chats).filter(chat => 
            currentFolderId === null ? !chat.folderId : chat.folderId === currentFolderId
        );
        
        filteredChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated)).forEach(chat => {
            const item = document.createElement('div');
            item.className = 'model-limit-item' + (chat.id === currentChatId ? ' best' : '');
            item.style.cursor = 'pointer';
            item.draggable = true;
            item.dataset.chatId = chat.id;
            
            const messageCount = chat.history.filter(h => h.role === 'user').length;
            
            item.innerHTML = `
                <div class="model-name" onclick="switchChat('${chat.id}')" style="flex: 1;">
                    <i class="fas fa-comments"></i> ${chat.title}
                    <div style="font-size: 0.6rem; color: var(--text-secondary);">${messageCount} —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <button class="chat-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')" style="width: 24px; height: 24px; border-radius: 6px; background: var(--error); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                        <i class="fas fa-times"></i>
                </button>
            `;
            
            item.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', chat.id);
            };
            
            container.appendChild(item);
        });
        
        Object.values(folders).forEach(folder => {
            const folderContent = document.getElementById(`folder-${folder.id}`);
            if (folderContent) {
                folderContent.ondrop = (e) => {
                    e.preventDefault();
                    const chatId = e.dataTransfer.getData('text/plain');
                    moveChatToFolder(chatId, folder.id);
                };
                
                folderContent.ondragover = (e) => {
                    e.preventDefault();
                    folderContent.style.background = 'var(--hover)';
                };
                
                folderContent.ondragleave = () => {
                    folderContent.style.background = '';
                };
            }
        });
    }

    function renderChatHistory() {
        const container = document.getElementById('chat-window');
        
        if (history.length === 0) {
            const chat = chats[currentChatId];
            container.innerHTML = `
                <div class="welcome-msg">
                    <h2>üöÄ ${chat.title}</h2>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É</p>
                </div>
            `;
            return;
        }
        
        const messagesToShow = history.slice(-messagesLoaded);
        container.innerHTML = '';
        
        messagesToShow.forEach(msg => {
            if (msg.type === 'image') {
                addImageToChat(msg.content, false);
            } else {
                addMsg(msg.role, msg.content, false);
            }
        });
        
        if (messagesLoaded < history.length) {
            const loadMoreBtn = document.createElement('div');
            loadMoreBtn.className = 'lazy-load-placeholder';
            loadMoreBtn.innerHTML = `
                <i class="fas fa-chevron-up"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë ${Math.min(maxMessagesToShow, history.length - messagesLoaded)} —Å–æ–æ–±—â–µ–Ω–∏–π
            `;
            loadMoreBtn.onclick = () => {
                messagesLoaded = Math.min(messagesLoaded + maxMessagesToShow, history.length);
                renderChatHistory();
            };
            container.insertBefore(loadMoreBtn, container.firstChild);
        }
        
        scrollToBottom();
    }

    function scrollToBottom() {
        requestAnimationFrame(() => {
            const chatWindow = document.getElementById('chat-window');
            if (chatWindow) {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        });
    }

    function saveChats() {
        try {
            localStorage.setItem('nexus_chats', JSON.stringify(chats));
            localStorage.setItem('nexus_current_chat', currentChatId);
            localStorage.setItem('nexus_image_style', currentImageStyle);
            localStorage.setItem('nexus_auto_model', autoModelEnabled);
            localStorage.setItem('nexus_hd_mode', hdModeEnabled);
            localStorage.setItem('nexus_aspect_ratio', currentAspectRatio);
            localStorage.setItem('nexus_camera_angle', currentCameraAngle);
            localStorage.setItem('nexus_image_seeds', JSON.stringify(imageHistory));
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
            if (e.name === 'QuotaExceededError') {
                const keys = Object.keys(chats).sort((a, b) => new Date(chats[a].createdAt) - new Date(chats[b].createdAt));
                if (keys.length > 5) {
                    delete chats[keys[0]];
                    localStorage.setItem('nexus_chats', JSON.stringify(chats));
                }
                alert('‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —á–∞—Ç—ã.');
            }
        }
    }

    function saveFolders() {
        localStorage.setItem('nexus_folders', JSON.stringify(folders));
    }

    function loadChats() {
        try {
            const saved = localStorage.getItem('nexus_chats');
            const savedCurrent = localStorage.getItem('nexus_current_chat');
            const savedStyle = localStorage.getItem('nexus_image_style');
            const savedAutoModel = localStorage.getItem('nexus_auto_model');
            const savedHdMode = localStorage.getItem('nexus_hd_mode');
            const savedPersona = localStorage.getItem('nexus_persona');
            const savedTheme = localStorage.getItem('nexus_theme');
            const savedFolders = localStorage.getItem('nexus_folders');
            const savedAspectRatio = localStorage.getItem('nexus_aspect_ratio');
            const savedCameraAngle = localStorage.getItem('nexus_camera_angle');
            const savedSeeds = localStorage.getItem('nexus_image_seeds');
            const savedBackupKeys = localStorage.getItem('nexus_backup_keys');
            
            if (savedFolders) folders = JSON.parse(savedFolders);
            if (savedTheme) changeTheme(savedTheme);
            if (savedAspectRatio) setAspectRatio(savedAspectRatio);
            if (savedCameraAngle) setCameraAngle(savedCameraAngle);
            if (savedSeeds) imageHistory = JSON.parse(savedSeeds);
            if (savedBackupKeys) BACKUP_KEYS.push(...JSON.parse(savedBackupKeys));
            
            if (savedPersona) {
                currentPersona = savedPersona;
                document.getElementById('persona-select').value = savedPersona;
                changePersona(savedPersona);
            }
            
            if (savedStyle) currentImageStyle = savedStyle;
            if (savedAutoModel !== null) autoModelEnabled = savedAutoModel === 'true';
            if (savedHdMode !== null) hdModeEnabled = savedHdMode === 'true';
            
            if (saved) {
                chats = JSON.parse(saved);
                
                if (Object.keys(chats).length === 0) {
                    createChat('–°—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç');
                } else {
                    const chatId = savedCurrent && chats[savedCurrent] ? savedCurrent : Object.keys(chats)[0];
                    switchChat(chatId);
                }
            } else {
                createChat('–°—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç');
            }
            
            if (autoModelEnabled) {
                document.getElementById('auto-model-icon').style.color = 'var(--success)';
                document.getElementById('auto-model-text').textContent = '–í—ã–∫–ª –∞–≤—Ç–æ-–≤—ã–±–æ—Ä';
            }
            
            if (hdModeEnabled) {
                document.getElementById('hd-mode-icon').style.color = 'var(--success)';
                document.getElementById('hd-mode-text').textContent = 'HD –†–µ–∂–∏–º ‚úì';
            }
            
            updateFoldersList();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', e);
            createChat('–°—Ç–∞—Ä—Ç–æ–≤—ã–π —á–∞—Ç');
        }
    }

    // ==========================================
    // IMAGE GENERATION FUNCTIONS (v3.7)
    // ==========================================
    function generatePollinationsUrl(prompt, style = currentImageStyle, seed = null) {
        // –¢–ó #2: Apply Prompt Expansion and Negative Prompts
        const magicWords = "ultra-detailed, sharp focus, 8k, highly coherent, cinematic masterpiece";
        let finalPrompt = prompt;
        
        if (!prompt.toLowerCase().includes('ultra-detailed')) {
            finalPrompt = `${finalPrompt}, ${magicWords}`;
        }
        
        if (hdModeEnabled && !prompt.toLowerCase().includes('high contrast')) {
            finalPrompt = `${finalPrompt}, high contrast, sharp edges`;
        }
        
        // –¢–ó #3: Add camera angle
        finalPrompt = `${finalPrompt}, ${CAMERA_ANGLES[currentCameraAngle]}`;
        
        // –¢–ó #2: Add negative prompts (–∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä)
        if (!finalPrompt.includes('negative_prompt')) {
            // –î–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä
            const isRealistic = ['realistic', 'photorealistic', 'portrait', 'cinematic'].some(k => 
                finalPrompt.toLowerCase().includes(k) || style.toLowerCase().includes(k)
            );
            const negativePrompt = isRealistic ? `${NEGATIVE_PROMPTS}, ${ANATOMY_FILTER}` : NEGATIVE_PROMPTS;
            finalPrompt = `${finalPrompt} | negative_prompt: ${negativePrompt}`;
        }
        
        const cleanPrompt = finalPrompt.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø\s]/g, '').substring(0, 300);
        const encodedPrompt = encodeURIComponent(cleanPrompt.replace(/\s+/g, '_'));
        const stylePrompt = IMAGE_STYLES[style] || '';
        const fullPrompt = stylePrompt ? `${encodedPrompt}_${stylePrompt}` : encodedPrompt;
        const finalSeed = currentSeed || seed || Date.now();
        
        // –¢–ó #1: Apply aspect ratio - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!
        const [widthRatio, heightRatio] = currentAspectRatio.split(':').map(Number);
        const maxSize = 1024;
        const ratio = widthRatio / heightRatio;
        
        let widthPx, heightPx;
        if (ratio >= 1) {
            widthPx = maxSize;
            heightPx = Math.round(maxSize / ratio);
        } else {
            heightPx = maxSize;
            widthPx = Math.round(maxSize * ratio);
        }
        
        return `https://image.pollinations.ai/prompt/${fullPrompt}?nologo=true&seed=${finalSeed}&width=${widthPx}&height=${heightPx}&enhance=true&model=flux`;
    }

    // v3.7: Smart Status Generator
    const SMART_STATUSES = [
        '[–í—ã—á–∏—Å–ª—è—é –∞–Ω–∞—Ç–æ–º–∏—é —Ä—É–∫...]',
        '[–ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã–π —Å–≤–µ—Ç...]',
        '[–£–±–∏—Ä–∞—é –ª–∏—à–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã...]',
        '[–ö–∞–ª–∏–±—Ä—É—é —Ü–≤–µ—Ç–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É...]',
        '[–û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é...]',
        '[–ü—Ä–∏–º–µ–Ω—è—é –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä...]',
        '[–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É—é seed-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é...]',
        '[–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é —Ä–∞–∫—É—Ä—Å –∫–∞–º–µ—Ä—ã...]'
    ];

    let smartStatusInterval = null;

    function startSmartStatus() {
        const statusEl = document.getElementById('smart-status');
        let index = 0;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É
        statusEl.textContent = SMART_STATUSES[0];
        
        smartStatusInterval = setInterval(() => {
            index = (index + 1) % SMART_STATUSES.length;
            statusEl.textContent = SMART_STATUSES[index];
        }, 1500);
    }

    function stopSmartStatus() {
        if (smartStatusInterval) {
            clearInterval(smartStatusInterval);
            smartStatusInterval = null;
        }
        document.getElementById('smart-status').textContent = '';
    }

    async function generateImage(prompt) {
        const container = document.createElement('div');
        container.className = 'msg ai';
        
        // –¢–ó #1: Skeleton Screen
        const skeletonDiv = document.createElement('div');
        skeletonDiv.className = 'image-container';
        skeletonDiv.innerHTML = `
            <div class="image-skeleton">
                <i class="fas fa-image-polaroid" style="font-size: 2rem; color: var(--accent);"></i>
                <div>üé® –£–ª—É—á—à–∞—é –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ Nexus Vision...</div>
            </div>
        `;
        
        container.appendChild(skeletonDiv);
        document.getElementById('chat-window').appendChild(container);
        scrollToBottom();
        
        const enhancedPrompt = enhanceImagePrompt(prompt);
        
        skeletonDiv.querySelector('.image-skeleton div').textContent = 
            `‚ú® –°–æ–∑–¥–∞–Ω–∏–µ: "${enhancedPrompt.substring(0, 50)}..."`;
        
        const imageUrl = generatePollinationsUrl(enhancedPrompt);
        const usedSeed = currentSeed || Date.now();
        const img = new Image();
        
        img.onload = () => {
            // –¢–ó #1: Blur-to-Sharp effect applied via CSS
            
            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container';
            imgContainer.onclick = () => openImageModal(imageUrl);
            imgContainer.innerHTML = `
                <div class="image-actions">
                    <button class="image-action-btn" onclick="event.stopPropagation(); openImageModal('${imageUrl}')" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="image-action-btn" onclick="event.stopPropagation(); downloadImage('${imageUrl}', '${enhancedPrompt}')" title="–°–∫–∞—á–∞—Ç—å">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="image-action-btn" onclick="event.stopPropagation(); shareImage('${imageUrl}', '${enhancedPrompt}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                        <i class="fas fa-share"></i>
                    </button>
                </div>
                <img src="${imageUrl}" alt="Generated image: ${enhancedPrompt}" class="generated-image">
                <div class="seed-display active">
                    Seed: ${usedSeed} | Aspect: ${currentAspectRatio} | Style: ${currentImageStyle}${hdModeEnabled ? ' | HD' : ''} | Angle: ${currentCameraAngle}
                </div>
                <div class="image-meta">
                    <span>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                    <button class="quick-save-btn" onclick="event.stopPropagation(); downloadImage('${imageUrl}', '${enhancedPrompt}')">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <!-- –¢–ó #5: –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Seed" -->
                    <button class="quick-save-btn" onclick="event.stopPropagation(); useSeed('${usedSeed}')" style="background: var(--accent);">
                        <i class="fas fa-seedling"></i> –°–æ—Ö—Ä. Seed
                    </button>
                </div>
            `;
            
            skeletonDiv.replaceWith(imgContainer);
            scrollToBottom();
            
            // –¢–ó #5: Save seed for reuse
            saveSeed(usedSeed, enhancedPrompt, imageUrl);
            
            history.push({ 
                type: 'image', 
                content: { url: imageUrl, prompt: enhancedPrompt, style: currentImageStyle, seed: usedSeed, aspectRatio: currentAspectRatio, cameraAngle: currentCameraAngle }
            });
            if (history.length > CONFIG.MAX_HISTORY_LEN) history = history.slice(-CONFIG.MAX_HISTORY_LEN);
            chats[currentChatId].history = [...history];
            chats[currentChatId].lastUpdated = new Date().toISOString();
            saveChats();
            
            // Reset seed after use (–¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
            if (!currentSeed) {
                document.getElementById('seed-input').value = '';
            }
        };
        
        img.onerror = () => {
            skeletonDiv.innerHTML = `
                <div class="image-skeleton" style="background: var(--error-glow);">
                    <i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </div>
            `;
            addMsg('assistant', `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.`);
        };
        
        img.src = imageUrl;
    }

    function downloadImage(url, prompt) {
        const a = document.createElement('a');
        a.href = url;
        const safePrompt = prompt.substring(0, 50).replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø]/g, '_');
        a.download = `nexus_${safePrompt}_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function openImageModal(url) {
        const originalTitle = document.title;
        document.title = 'Nexus is thinking...';
        
        const modal = document.createElement('div');
        modal.className = 'image-modal';
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
                document.body.style.overflow = '';
                document.title = originalTitle;
            }
        };
        
        document.body.style.overflow = 'hidden';
        
        const closeBtn = document.createElement('div');
        closeBtn.className = 'image-modal-close';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.onclick = () => {
            modal.remove();
            document.body.style.overflow = '';
            document.title = originalTitle;
        };
        
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Full view';
        
        modal.appendChild(closeBtn);
        modal.appendChild(img);
        document.body.appendChild(modal);
        
        const closeOnEscape = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.body.style.overflow = '';
                document.title = originalTitle;
                document.removeEventListener('keydown', closeOnEscape);
            }
        };
        document.addEventListener('keydown', closeOnEscape);
    }

    async function shareImage(url, prompt) {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Nexus AI Image',
                    text: prompt,
                    url: url
                });
            } catch (err) {
                // User cancelled share
            }
        } else {
            await navigator.clipboard.writeText(url);
            alert('üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }
    }

    function addImageToChat(imageData, animate = true) {
        const div = document.createElement('div');
        div.className = 'msg ai';
        
        const container = document.createElement('div');
        container.className = 'image-container';
        container.onclick = () => openImageModal(imageData.url);
        container.innerHTML = `
            <div class="image-actions">
                <button class="image-action-btn" onclick="event.stopPropagation(); openImageModal('${imageData.url}')" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="image-action-btn" onclick="event.stopPropagation(); downloadImage('${imageData.url}', '${imageData.prompt}')" title="–°–∫–∞—á–∞—Ç—å">
                    <i class="fas fa-download"></i>
                </button>
                <button class="image-action-btn" onclick="event.stopPropagation(); shareImage('${imageData.url}', '${imageData.prompt}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                    <i class="fas fa-share"></i>
                </button>
            </div>
            <img src="${imageData.url}" alt="Generated image: ${imageData.prompt}" class="generated-image">
            <div class="seed-display active">
                Seed: ${imageData.seed || 'N/A'} | Aspect: ${imageData.aspectRatio || '1:1'} | Style: ${imageData.style}${hdModeEnabled ? ' | HD' : ''} | Angle: ${imageData.cameraAngle || 'wide'}
            </div>
            <div class="image-meta">
                <span>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                <button class="quick-save-btn" onclick="event.stopPropagation(); downloadImage('${imageData.url}', '${imageData.prompt}')">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <!-- –¢–ó #5: –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Seed" -->
                <button class="quick-save-btn" onclick="event.stopPropagation(); useSeed('${imageData.seed || ''}')" style="background: var(--accent);">
                    <i class="fas fa-seedling"></i> –°–æ—Ö—Ä. Seed
                </button>
            </div>
        `;
        
        div.appendChild(container);
        document.getElementById('chat-window').appendChild(div);
        scrollToBottom();
    }

    // ==========================================
    // CORE FUNCTIONS
    // ==========================================
    function detectQueryType(text) {
        const lower = text.toLowerCase();
        if (lower.match(/(function|class|const|let|var|return|import|export|python|javascript|code|console\.log|def|if|else|async|await|api|library|framework)/)) {
            return 'code';
        }
        if (lower.match(/(–æ–ø–∏—Å–∞–Ω–∏–µ|–Ω–∞—Ä–∏—Å—É–π|—Å—Ç–∏–ª—å|—Ü–≤–µ—Ç|–∫–æ–º–ø–æ–∑–∏—Ü–∏—è|—Ö—É–¥–æ–∂–Ω–∏–∫|—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ|art|paint|draw|style|composition|illustration|drawing|sketch|design|visual)/)) {
            return 'art';
        }
        if (lower.match(/(–∞–Ω–∞–ª–∏–∑|–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ|–≤–≥–ª—É–±—å|—Ç–µ–æ—Ä–∏—è|research|analyze|deep|theory|critical|comprehensive|detailed)/)) {
            return 'analysis';
        }
        if (lower.match(/(—Ç–≤–æ—Ä—á–µ—Å–∫|–∫—Ä–µ–∞—Ç–∏–≤|creative|imagine|visualize|innovative|inspiration|idea|brainstorm)/)) {
            return 'creative';
        }
        return 'default';
    }

    function autoResize() {
        const input = document.getElementById('u-in');
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }

    async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5MB');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage = e.target.result;
            const indicator = document.getElementById('image-indicator');
            document.getElementById('image-name').textContent = file.name.substring(0, 12) + (file.name.length > 12 ? '...' : '');
            indicator.classList.add('active');
            setMode('art');
        };
        reader.readAsDataURL(file);
    }

    let keyValidationTimeout;
    
    function validateKey(key) {
        clearTimeout(keyValidationTimeout);
        
        const keyInput = document.getElementById('key');
        const statusEl = document.getElementById('key-status');
        
        if (!key) {
            keyInput.classList.remove('valid', 'invalid');
            statusEl.textContent = '';
            return;
        }
        
        keyValidationTimeout = setTimeout(async () => {
            try {
                keyInput.classList.add('valid');
                keyInput.classList.remove('invalid');
                statusEl.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞...';
                statusEl.style.color = 'var(--warning)';
                
                const res = await fetch('https://openrouter.ai/api/v1/auth/key', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${key}` },
                    signal: AbortSignal.timeout(5000)
                });
                
                if (res.ok) {
                    keyInput.classList.add('valid');
                    keyInput.classList.remove('invalid');
                    statusEl.textContent = '‚úÖ –ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω';
                    statusEl.style.color = 'var(--success)';
                    updateAllLimits();
                } else {
                    throw new Error('Invalid key');
                }
            } catch (e) {
                keyInput.classList.add('invalid');
                keyInput.classList.remove('valid');
                statusEl.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á';
                statusEl.style.color = 'var(--error)';
            }
        }, 800);
    }

    // ==========================================
    // LIMITS & MODEL MANAGEMENT
    // ==========================================
    async function updateAllLimits(force = false) {
        const now = Date.now();
        if (!force && now - lastLimitUpdate < 30000) {
            console.log('‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–Ω–æ–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
            return;
        }
        lastLimitUpdate = now;

        const key = document.getElementById('key').value.trim();
        if (!key) {
            alert('üîë –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!');
            return;
        }

        const limitsContainer = document.getElementById('model-limits');
        limitsContainer.innerHTML = '<div style="text-align:center; padding: 10px;"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–º–∏—Ç–æ–≤...</div>';

        try {
            let retries = 0;
            let lastError = null;
            
            while (retries < 3) {
                try {
                    const res = await fetch('https://openrouter.ai/api/v1/auth/key', {
                        headers: { 'Authorization': `Bearer ${key}` },
                        signal: AbortSignal.timeout(10000)
                    });

                    if (!res.ok) {
                        if (res.status === 401) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á (401)');
                        if (res.status === 429) {
                            const waitTime = Math.pow(2, retries) * 1000;
                            document.getElementById('thinking-text').textContent = `‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤, –∂–¥—É ${waitTime/1000}—Å... (–ø–æ–ø—ã—Ç–∫–∞ ${retries + 1}/${3})`;
                            await new Promise(r => setTimeout(r, waitTime));
                            retries++;
                            continue;
                        }
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }

                    const data = await res.json();
                    
                    modelLimits = {};
                    let totalRemaining = 0;
                    let reliableCount = 0;

                    CONFIG.MODELS.forEach(model => {
                        const modelData = data.data?.models?.[model.id];
                        let used = 0, limit = 0, remaining = Infinity;

                        if (modelData) {
                            used = modelData.usage || 0;
                            limit = modelData.limit || 0;
                            remaining = Math.max(0, limit - used);
                        }

                        modelLimits[model.id] = { used, limit, remaining };
                        totalRemaining += limit > 0 ? remaining : 0;
                        if (model.reliable && remaining > 0) reliableCount++;
                    });

                    isEmergencyMode = totalRemaining === 0 || reliableCount === 0;
                    
                    limitsCache = { data: modelLimits, timestamp: Date.now() };
                    
                    renderLimits(reliableCount);
                    updateConnectionStatus(totalRemaining > 0);
                    
                    const refreshTime = new Date(Date.now() + 5 * 60 * 1000).toLocaleTimeString('ru-RU', { minute: '2-digit', second: '2-digit' });
                    document.getElementById('limits-refresh-time').textContent = `(–∞–≤—Ç–æ –¥–æ ${refreshTime})`;
                    
                    return;
                } catch (e) {
                    lastError = e;
                    if (e.name === 'AbortError') throw e;
                    
                    if (retries < 3) {
                        await new Promise(r => setTimeout(r, 1000 * retries));
                    }
                }
            }
            
            throw lastError;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–º–∏—Ç–æ–≤:', e);
            limitsContainer.innerHTML = `<div style="color:var(--error); padding: 10px;">‚ùå ${e.message}</div>`;
            updateConnectionStatus(false);
        }
    }

    function renderLimits(reliableCount = 0) {
        const container = document.getElementById('model-limits');
        container.innerHTML = '';
        
        let bestModel = null;
        let maxRemaining = -1;
        let totalRemaining = 0;
        let emergencyModels = [];
        
        CONFIG.MODELS.forEach(model => {
            const limit = modelLimits[model.id];
            if (limit && limit.remaining > maxRemaining) {
                maxRemaining = limit.remaining;
                bestModel = model.id;
            }
            totalRemaining += limit?.remaining || 0;
            if (model.tier === 'EMG' || model.tier === 'S') {
                emergencyModels.push({ ...model, remaining: limit?.remaining || 0 });
            }
        });

        if (isEmergencyMode) {
            document.getElementById('connection-status').textContent = '–≠–ö–°–¢–†–ï–ù–ù–´–ô';
            document.getElementById('status-indicator').className = 'status-indicator emergency';
        }

        const modelsToShow = isEmergencyMode ? emergencyModels : CONFIG.MODELS;
        
        modelsToShow.forEach(model => {
            const limit = modelLimits[model.id] || { remaining: 0, limit: 0 };
            const percentage = limit.limit > 0 ? (limit.remaining / limit.limit) * 100 : 100;
            
            const item = document.createElement('div');
            item.className = 'model-limit-item';
            if (model.id === bestModel) item.classList.add('best');
            if (isEmergencyMode && model.tier === 'EMG') item.classList.add('emergency');
            if (!model.reliable) item.classList.add('unreliable');
            
            item.innerHTML = `
                <div style="flex:1;">
                    <div class="model-name" title="${model.id}">
                        ${model.name} ${model.reliable ? '‚úì' : ''} ${model.id === bestModel ? '‚≠ê' : ''}
                        <div style="font-size: 0.6rem; color: var(--text-secondary);">${model.tier} | ${model.free ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : '–ü–ª–∞—Ç–Ω–æ'}</div>
                    </div>
                    <div class="limit-bar">
                        <div class="limit-fill" style="width:${percentage}%"></div>
                    </div>
                </div>
                <div class="limit-count" style="margin-left:8px;">
                    ${limit.remaining === Infinity ? '‚àû' : limit.remaining}
                </div>
            `;
            container.appendChild(item);
        });
    }

    function toggleAutoModel() {
        autoModelEnabled = !autoModelEnabled;
        const icon = document.getElementById('auto-model-icon');
        const text = document.getElementById('auto-model-text');
        
        if (autoModelEnabled) {
            icon.style.color = 'var(--success)';
            text.textContent = '–í—ã–∫–ª –∞–≤—Ç–æ-–≤—ã–±–æ—Ä';
            updateAllLimits();
        } else {
            icon.style.color = 'var(--text-secondary)';
            text.textContent = '–í–∫–ª –∞–≤—Ç–æ-–≤—ã–±–æ—Ä';
        }
        
        saveChats();
    }

    function toggleHdMode() {
        hdModeEnabled = !hdModeEnabled;
        const icon = document.getElementById('hd-mode-icon');
        const text = document.getElementById('hd-mode-text');
        
        if (hdModeEnabled) {
            icon.style.color = 'var(--success)';
            text.textContent = 'HD –†–µ–∂–∏–º ‚úì';
        } else {
            icon.style.color = 'var(--text-secondary)';
            text.textContent = 'HD –†–µ–∂–∏–º';
        }
        
        saveChats();
    }

    const MODEL_PRIORITIES = {
        default: ['deepseek/deepseek-chat:free', 'meta-llama/llama-3.3-70b-instruct:free', 'google/gemini-flash-1.5:free'],
        code: ['deepseek/deepseek-chat:free', 'meta-llama/llama-3.3-70b-instruct:free', 'anthropic/claude-3-haiku-20240307'],
        art: ['google/gemini-flash-1.5:free', 'meta-llama/llama-3.3-70b-instruct:free', 'qwen/qwen-2.5-72b-instruct:free'],
        analysis: ['deepseek/deepseek-chat:free', 'meta-llama/llama-3.3-70b-instruct:free', 'anthropic/claude-3-haiku-20240307'],
        creative: ['meta-llama/llama-3.3-70b-instruct:free', 'google/gemini-flash-1.5:free', 'qwen/qwen-2.5-72b-instruct:free']
    };

    function getBestModel(queryType = null) {
        if (!autoModelEnabled && !queryType) return CONFIG.MODELS[0].id;
        
        const type = queryType || detectQueryType(input.value);
        const priorities = MODEL_PRIORITIES[type] || MODEL_PRIORITIES['default'];
        
        const totalRemaining = Object.values(modelLimits).reduce((sum, limit) => sum + limit.remaining, 0);
        
        if (totalRemaining === 0) {
            const emergencyModel = CONFIG.MODELS.find(m => m.tier === 'EMG') || CONFIG.MODELS.find(m => m.reliable);
            return emergencyModel.id;
        }
        
        for (let modelId of priorities) {
            const model = CONFIG.MODELS.find(m => m.id === modelId);
            const limit = modelLimits[modelId];
            
            if (!limit || limit.remaining <= 0) continue;
            if (currentMode === 'art' && uploadedImage && !model.vision) continue;
            
            return modelId;
        }
        
        for (let model of CONFIG.MODELS) {
            const limit = modelLimits[model.id];
            if (limit && limit.remaining > 0) {
                return model.id;
            }
        }
        
        return (CONFIG.MODELS.find(m => m.tier === 'EMG') || CONFIG.MODELS[0]).id;
    }

    // ==========================================
    // FALLBACK SYSTEM v3.7 (–ë–µ—Å—à–æ–≤–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è)
    // ==========================================
    async function generateWithFallback(messages, model, key, queryType) {
        const allKeys = [key, ...BACKUP_KEYS.filter(k => k && k !== key)];
        let lastError = null;
        let attempts = 0;

        for (let keyIndex = 0; keyIndex < allKeys.length && attempts < 3; keyIndex++) {
            const currentKey = allKeys[keyIndex];
            isUsingBackupKey = keyIndex > 0;
            
            const modelList = [model, ...FALLBACK_MODELS.filter(m => m !== model)];
            
            for (let i = 0; i < modelList.length && attempts < 3; i++) {
                const currentModel = modelList[i];
                const modelCfg = CONFIG.MODELS.find(m => m.id === currentModel);
                
                if (!modelCfg) continue;

                const limit = modelLimits[currentModel];
                if (limit && limit.remaining <= 0) {
                    continue;
                }

                if (currentMode === 'art' && uploadedImage && !modelCfg.vision) {
                    continue;
                }

                try {
                    attempts++;
                    // –¢–ó #1: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞..."
                    document.getElementById('thinking-text').textContent = 
                        `–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞... ${isUsingBackupKey ? '(—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–ª—é—á)' : ''}`.trim();
                    
                    const { success, response } = await makeApiRequest(
                        'https://openrouter.ai/api/v1/chat/completions',
                        {
                            method: "POST",
                            headers: { 
                                "Authorization": `Bearer ${currentKey}`, 
                                "Content-Type": "application/json" 
                            },
                            body: JSON.stringify({ 
                                model: currentModel, 
                                messages,
                                temperature: queryType === 'art' ? 0.8 : 0.7
                            })
                        }
                    );

                    if (success) {
                        const data = await response.json();
                        if (data.choices?.[0]?.message?.content) {
                            return { data, model: currentModel };
                        }
                        throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏');
                    }
                } catch (e) {
                    lastError = e;
                    if (e.name === 'AbortError') throw e;
                    
                    // –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç
                    console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, e.message);
                }
            }
        }
        
        throw lastError || new Error('–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
    }

    // ==========================================
    // RETRY LOGIC WITH CORS/ERROR HANDLING v3.65
    // ==========================================
    async function makeApiRequest(url, options, maxRetries = 3) {
        let lastError;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const timeout = 15000 + (attempt * 5000);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                const res = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (res.ok) {
                    return { success: true, response: res };
                }
                
                const status = res.status;
                if ((status === 429 || status === 500 || status === 503) && attempt < maxRetries - 1) {
                    const delay = 2000 * (attempt + 1);
                    // –¢–ó #1: –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—à–∏–±–∫–∏
                    await new Promise(r => setTimeout(r, delay));
                    continue;
                }
                
                throw new Error(`HTTP ${status}: ${res.statusText}`);
                
            } catch (e) {
                lastError = e;
                if (e.name === 'AbortError') throw e;
                
                if (attempt < maxRetries - 1) {
                    const delay = 2000 * (attempt + 1);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }
        
        throw lastError || new Error('–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã');
    }

    // ==========================================
    // SEND FUNCTION WITH ALL FEATURES v3.7
    // ==========================================
    async function send() {
        const text = input.value.trim();
        const key = document.getElementById('key').value.trim();
        
        if (!text || !key) {
            if (!key) alert('üîë –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!');
            return;
        }

        if (text.startsWith('/')) {
            handleCommand(text);
            input.value = '';
            return;
        }

        // Auto-append /img for Nexus Vision persona
        let processedText = text;
        if (currentPersona === 'vision' && !text.toLowerCase().startsWith('/img') && !text.toLowerCase().startsWith('–∏–∑–æ–±—Ä–∞–∑–∏') && !text.toLowerCase().startsWith('–Ω–∞—Ä–∏—Å—É–π')) {
            processedText = `/img ${text}`;
        }

        if (processedText.toLowerCase().startsWith('/img') || processedText.toLowerCase().startsWith('–∏–∑–æ–±—Ä–∞–∑–∏') || processedText.toLowerCase().startsWith('–Ω–∞—Ä–∏—Å—É–π')) {
            // –¢–ó #5: Show seed input in deep mode
            document.getElementById('seed-input-container').classList.toggle('active', currentMode === 'deep');
            
            const imagePrompt = processedText.replace(/^\/img\s*/i, '').replace(/^–∏–∑–æ–±—Ä–∞–∑–∏\s*/i, '').replace(/^–Ω–∞—Ä–∏—Å—É–π\s*/i, '').trim();
            if (imagePrompt) {
                await addMsg('user', `üé® ${imagePrompt} | ${currentAspectRatio}${currentSeed ? ` | Seed: ${currentSeed}` : ''}${currentCameraAngle !== 'wide' ? ` | ${currentCameraAngle}` : ''}`);
                input.value = '';
                autoResize();
                await generateImage(imagePrompt);
                return;
            }
        }

        if (autoModelEnabled || (Date.now() - limitsCache.timestamp > 300000)) {
            await updateAllLimits();
        }

        let enhancedText = processedText;
        let searchResults = null;
        
        if (currentMode === 'search') {
            searchResults = await performWebSearch(processedText);
            if (searchResults && searchResults.length > 0) {
                const searchContext = searchResults.map(r => 
                    `[–ò—Å—Ç–æ—á–Ω–∏–∫: ${r.source}]\n${r.title}\n${r.content}\n`
                ).join('\n');
                enhancedText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª: "${processedText}"\n\n–î–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞:\n${searchContext}\n\n–û—Ç–≤–µ—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö.`;
            }
        }

        if (currentMode === 'art') {
            const styleKey = document.getElementById('art-style-select').value;
            if (styleKey && STYLES_DB[styleKey]) {
                enhancedText = `${processedText}, ${STYLES_DB[styleKey].prompt}`;
            }
            if (uploadedImage) {
                enhancedText = `Analyze this artwork and provide constructive feedback. User: ${processedText}`;
            }
        }

        await addMsg('user', uploadedImage ? `üñºÔ∏è ${processedText}` : processedText);
        input.value = '';
        autoResize();
        
        const uploadedImageTemp = uploadedImage;
        uploadedImage = null;
        document.getElementById('image-indicator').classList.remove('active');
        
        localStorage.setItem('nexus_key', key);
        loadBackupKeys(); // v3.7: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–ª—é—á–∏

        const queryType = detectQueryType(processedText);
        
        let systemPrompt = {
            normal: "You are Nexus AI. Respond concisely and accurately.",
            search: "You are in Search mode. Analyze provided web data and give detailed, factual answers with sources. Always cite sources and provide comprehensive information.",
            deep: "You are in Deep Analysis mode. Provide detailed technical explanations with examples.",
            art: "You are an expert Art Assistant. Provide creative suggestions, artistic critique, and detailed visual descriptions."
        }[currentMode];
        
        if (currentPersona && PERSONAS[currentPersona]) {
            systemPrompt = PERSONAS[currentPersona].systemPrompt;
        }

        const recentHistory = history.slice(-10);
        let messages = [{ role: "system", content: systemPrompt }, ...recentHistory];

        const selectedModel = getBestModel(queryType);
        const modelCfg = CONFIG.MODELS.find(m => m.id === selectedModel);

        if (currentMode === 'art' && uploadedImageTemp && modelCfg.vision) {
            messages.push({
                role: "user",
                content: [
                    { type: "text", text: enhancedText },
                    { type: "image_url", image_url: { url: uploadedImageTemp } }
                ]
            });
        } else {
            messages.push({ role: "user", content: enhancedText });
        }

        document.getElementById('thinking').style.display = 'block';
        const originalTitle = document.title;
        document.title = 'Nexus is thinking...';
        
        document.body.classList.add('generating');
        abortController = new AbortController();
        
        // –¢–ó #4: –ó–∞–ø—É—Å—Ç–∏—Ç—å —É–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
        startSmartStatus();

        try {
            const { data, model: usedModel } = await generateWithFallback(messages, selectedModel, key, queryType);
            const aiText = data.choices[0].message.content;
            
            history.push({ role: "user", content: enhancedText }, { role: "assistant", content: aiText });
            if (history.length > CONFIG.MAX_HISTORY_LEN) history = history.slice(-CONFIG.MAX_HISTORY_LEN);
            
            chats[currentChatId].history = [...history];
            chats[currentChatId].lastUpdated = new Date().toISOString();
            chats[currentChatId].sessionTokenCount = sessionTokenCount;
            saveChats();
            
            await addMsg('assistant', aiText);
            
            document.getElementById('thinking-text').textContent = 
                `‚úÖ –ì–æ—Ç–æ–≤–æ (${CONFIG.MODELS.find(m => m.id === usedModel)?.name})`;
                
            const lastMsg = document.querySelector('#chat-window .msg:last-child .ai-content');
            if (lastMsg) {
                lastMsg.innerHTML += '<span class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
                setTimeout(() => {
                    const indicator = lastMsg.querySelector('.typing-indicator');
                    if (indicator) indicator.remove();
                }, 2000);
            }
            
        } catch (e) {
            if (e.name === 'AbortError') {
                addMsg('assistant', '‚èπÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.');
            } else {
                addMsg('assistant', `‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /help`);
            }
        } finally {
            stopSmartStatus(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
            setTimeout(() => {
                document.getElementById('thinking').style.display = 'none';
                document.body.classList.remove('generating');
                document.title = originalTitle;
            }, 500);
        }
    }

    function stopGeneration() {
        if (abortController) {
            abortController.abort();
            abortController = null;
        }
        stopSmartStatus(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ —Ä—É—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
    }

    // ==========================================
    // UI FUNCTIONS
    // ==========================================
    async function addMsg(role, text, animate = true) {
        const div = document.createElement('div');
        div.className = `msg ${role === 'user' ? 'user' : 'ai'}`;
        
        if (role === 'assistant') {
            div.innerHTML = `
                <div class="ai-header">
                    <div class="ai-avatar"><i class="fas fa-terminal"></i></div> NEXUS
                </div>
                <div class="ai-content"></div>
            `;
            document.getElementById('chat-window').appendChild(div);
            const content = div.querySelector('.ai-content');
            
            if (animate) {
                await typeWriter(content, text);
            }
            content.innerHTML = marked.parse(text, { sanitize: true });
            addCopyButtons(content);
            content.querySelectorAll('pre code').forEach(block => Prism.highlightElement(block));
        } else {
            div.textContent = text;
            document.getElementById('chat-window').appendChild(div);
        }
        
        scrollToBottom();
    }

    async function typeWriter(element, text) {
        const words = text.split(' ');
        for (let word of words) {
            element.textContent += word + ' ';
            await new Promise(r => setTimeout(r, CONFIG.TYPING_SPEED));
            scrollToBottom();
        }
    }

    function addCopyButtons(container) {
        container.querySelectorAll('pre').forEach(pre => {
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            const button = document.createElement('button');
            button.className = 'copy-btn';
            button.innerHTML = '<i class="fas fa-copy"></i>';
            button.onclick = async () => {
                await navigator.clipboard.writeText(pre.textContent);
                button.classList.add('copied');
                button.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            };
            wrapper.appendChild(button);
        });
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
        
        const modeNames = { normal: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', search: '–ü–æ–∏—Å–∫', deep: '–ì–ª—É–±–æ–∫–∏–π', art: '–•—É–¥–æ–∂–Ω–∏–∫' };
        document.getElementById('current-mode-display').textContent = modeNames[mode];
        
        const styleSelector = document.getElementById('style-selector');
        styleSelector.classList.toggle('active', mode === 'art');
        
        const personaSelector = document.getElementById('persona-selector');
        personaSelector.classList.toggle('active', mode === 'deep');
        
        // –¢–ó #5: Show seed input in deep mode
        const seedContainer = document.getElementById('seed-input-container');
        seedContainer.classList.toggle('active', mode === 'deep');
        
        // –¢–ó #4: Show aspect ratio selector in art mode
        const aspectSelector = document.getElementById('aspect-ratio-selector');
        aspectSelector.classList.toggle('active', mode === 'art');
        
        // –¢–ó #3: Show camera controls in art mode
        const cameraControls = document.getElementById('camera-controls');
        cameraControls.classList.toggle('active', mode === 'art');
        
        if (window.innerWidth <= 768) {
            setTimeout(closeSidebar, 300);
        }
    }

    function clearChat() {
        if (history.length > 0 && !confirm('‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
        
        history = [];
        sessionTokenCount = 0;
        chats[currentChatId].history = [];
        chats[currentChatId].sessionTokenCount = 0;
        chats[currentChatId].lastUpdated = new Date().toISOString();
        
        messagesLoaded = maxMessagesToShow;
        
        renderChatHistory();
        saveChats();
        
        document.getElementById('session-tokens').textContent = '0';
        uploadedImage = null;
        document.getElementById('image-indicator').classList.remove('active');
    }

    function exportChat() {
        const chat = chats[currentChatId];
        if (history.length === 0) return alert('üì≠ –ù–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å!');
        
        let content = `Nexus Chat Export | ${new Date().toLocaleString('ru-RU')}\n–ß–∞—Ç: ${chat.title}\n${'='.repeat(50)}\n\n`;
        history.forEach(msg => {
            if (msg.type === 'image') {
                content += `[IMAGE] ${new Date().toLocaleTimeString('ru-RU')}\nPrompt: ${msg.content.prompt} | Style: ${msg.content.style} | Seed: ${msg.content.seed} | Aspect: ${msg.content.aspectRatio} | Angle: ${msg.content.cameraAngle}\nURL: ${msg.content.url}\n\n`;
            } else {
                content += `[${msg.role.toUpperCase()}] ${new Date().toLocaleTimeString('ru-RU')}\n${msg.content}\n\n`;
            }
        });
        content += `\n–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${sessionTokenCount.toLocaleString('ru-RU')}`;
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nexus-chat-${chat.title.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function exportAllData() {
        const exportData = {
            chats: chats,
            folders: folders,
            imageSeeds: imageHistory,
            settings: {
                theme: localStorage.getItem('nexus_theme') || 'default',
                persona: currentPersona,
                autoModel: autoModelEnabled,
                hdMode: hdModeEnabled,
                imageStyle: currentImageStyle,
                aspectRatio: currentAspectRatio,
                cameraAngle: currentCameraAngle,
                currentChat: currentChatId,
                exportDate: new Date().toISOString(),
                version: '3.7'
            }
        };
        
        const jsonData = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nexus-ultra-v3.7-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        
        alert('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã! –°–∏–¥-–∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.');
    }

    function handleCommand(cmd) {
        const parts = cmd.split(' ');
        const command = parts[0];
        const args = parts.slice(1).join(' ');
        
        switch(command) {
            case '/clear':
                clearChat();
                break;
            case '/export':
                exportChat();
                break;
            case '/new':
                createChat(args || null);
                break;
            case '/help':
            case '/?':
                showCommands();
                break;
            case '/style':
                if (args && IMAGE_STYLES[args]) {
                    currentImageStyle = args;
                    saveChats();
                    alert(`üé® –°—Ç–∏–ª—å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${args}`);
                } else {
                    alert(`‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∏–ª—å. –î–æ—Å—Ç—É–ø–Ω—ã–µ: ${Object.keys(IMAGE_STYLES).join(', ')}`);
                }
                break;
            case '/img':
                if (args) {
                    generateImage(args);
                } else {
                    alert('‚ùì –£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }
                break;
            case '/folder':
                if (args) {
                    createFolder(args);
                } else {
                    alert('‚ùì –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏');
                }
                break;
            default:
                alert(`‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: ${cmd}\n–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥`);
        }
    }

    function showCommands() {
        alert(`ü§ñ Nexus Ultra v3.7 - –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:
    
/clear - –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
/export - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
/new [–Ω–∞–∑–≤–∞–Ω–∏–µ] - –ù–æ–≤—ã–π —á–∞—Ç
/style [—Å—Ç–∏–ª—å] - –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
/img <–æ–ø–∏—Å–∞–Ω–∏–µ> - –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
/folder <–Ω–∞–∑–≤–∞–Ω–∏–µ> - –ù–æ–≤–∞—è –ø–∞–ø–∫–∞

üé® –†–µ–∂–∏–º—ã (Ctrl+1..4):
‚Ä¢ Ctrl+1 - –°—Ç–∞–Ω–¥–∞—Ä—Ç
‚Ä¢ Ctrl+2 - –ü–æ–∏—Å–∫ (—Å –≤–µ–±-–¥–∞–Ω–Ω—ã–º–∏)
‚Ä¢ Ctrl+3 - –ì–ª—É–±–æ–∫–∏–π (—Å —Å–∏–¥-–∫–æ–Ω—Ç—Ä–æ–ª–µ–º)
‚Ä¢ Ctrl+4 - –•—É–¥–æ–∂–Ω–∏–∫ (–∞—Å–ø–µ–∫—Ç-—Ä–∞—Ç–∏–æ, –∫–∞–º–µ—Ä–∞)

üßô –ü–µ—Ä—Å–æ–Ω—ã:
‚Ä¢ Expert Coder - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥
‚Ä¢ Creative Writer - –¢–≤–æ—Ä—á–µ—Å–∫–æ–µ –ø–∏—Å—å–º–æ
‚Ä¢ Nexus Vision - –ê–≤—Ç–æ-/img —Ä–µ–∂–∏–º

üñºÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
‚Ä¢ Aspect Ratio: 1:1, 16:9, 9:16, 21:9
‚Ä¢ Seed Control: –≤ –ì–ª—É–±–æ–∫–æ–º —Ä–µ–∂–∏–º–µ
‚Ä¢ Camera Angles: close, wide, low
‚Ä¢ Negative Prompts: –ê–≤—Ç–æ + –ê–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä
‚Ä¢ Smart Presets: cinematic, portrait, landscape

üìπ –ö–∞–º–µ—Ä–∞:
‚Ä¢ –ö—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω - close-up, facial detail
‚Ä¢ –û–±—â–∏–π –ø–ª–∞–Ω - wide angle, full body
‚Ä¢ –ö–∏–Ω–æ-—Ä–∞–∫—É—Ä—Å - low angle, epic perspective

üí° –ü—Ä–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
‚Ä¢ Skeleton Screen: –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è
‚Ä¢ Blur-to-Sharp: –ø–ª–∞–≤–Ω–∞—è –ø—Ä–æ—è–≤–∫–∞
‚Ä¢ –°–∏–¥-–∫–æ–Ω—Ç—Ä–æ–ª—å: –≤ –ì–ª—É–±–æ–∫–æ–º —Ä–µ–∂–∏–º–µ
‚Ä¢ –£–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

üîÑ –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: ${CONFIG.MODELS.filter(m => m.tier === 'EMG' || m.tier === 'S').length} —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π + —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–ª—é—á–∏`);
    }

    // ==========================================
    // VOICE RECOGNITION
    // ==========================================
    let recognition = null;
    let isRecording = false;

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
            isRecording = true;
            document.getElementById('voice-btn').classList.add('recording');
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-stop"></i>';
        };

        recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                }
            }
            if (finalTranscript) {
                document.getElementById('u-in').value = finalTranscript;
                autoResize();
            }
        };

        recognition.onend = () => {
            isRecording = false;
            document.getElementById('voice-btn').classList.remove('recording');
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
            setTimeout(() => {
                if (document.getElementById('u-in').value.trim()) {
                    send();
                }
            }, 500);
        };

        recognition.onerror = (event) => {
            console.error('Voice error:', event.error);
            isRecording = false;
            document.getElementById('voice-btn').classList.remove('recording');
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
            addMsg('assistant', `üé§ –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${event.error}`);
        };
    }

    function toggleVoiceRecording() {
        if (!recognition) {
            alert('üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge.');
            return;
        }
        
        if (isRecording) {
            recognition.stop();
        } else {
            document.getElementById('u-in').value = '';
            recognition.start();
        }
    }

    function updateConnectionStatus(isConnected) {
        const statusEl = document.getElementById('connection-status');
        const indicatorEl = document.getElementById('status-indicator');
        
        if (isEmergencyMode) {
            statusEl.textContent = '–≠–ö–°–¢–†–ï–ù–ù–´–ô';
            indicatorEl.className = 'status-indicator emergency';
        } else if (isConnected) {
            statusEl.textContent = '–û–Ω–ª–∞–π–Ω';
            indicatorEl.className = 'status-indicator connected';
        } else {
            statusEl.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω';
            indicatorEl.className = 'status-indicator';
        }
    }

    // ==========================================
    // INITIALIZATION
    // ==========================================
    window.addEventListener('load', () => {
        const savedKey = localStorage.getItem('nexus_key');
        if (savedKey) {
            document.getElementById('key').value = savedKey;
            updateAllLimits();
        }
        
        loadChats();

        document.getElementById('key').addEventListener('input', (e) => {
            validateKey(e.target.value);
        });

        // v3.7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–ª—é—á–∞
        document.getElementById('backup-key').addEventListener('change', (e) => {
            if (e.target.value) {
                BACKUP_KEYS.push(e.target.value);
                localStorage.setItem('nexus_backup_keys', JSON.stringify(BACKUP_KEYS));
            }
        });

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (window.innerWidth > 768) {
                    closeSidebar();
                }
            }, 250);
        });

        let intervalId = setInterval(() => {
            if (document.hidden) return;
            if (document.getElementById('key').value.trim() && autoModelEnabled) {
                updateAllLimits();
            }
        }, 5 * 60 * 1000);
        
        document.getElementById('key').addEventListener('change', (e) => {
            localStorage.setItem('nexus_key', e.target.value);
            updateAllLimits();
        });
    });

    // Event listeners
    const input = document.getElementById('u-in');
    input.addEventListener('input', autoResize);
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });

    // Seed input handler
    document.getElementById('seed-input').addEventListener('input', (e) => {
        currentSeed = e.target.value ? parseInt(e.target.value) || e.target.value : null;
    });

    document.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            clearChat();
        }
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            exportChat();
        }
        if (e.ctrlKey && e.key === 'a') {
            e.preventDefault();
            exportAllData();
        }
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            createChat();
        }
        if (e.ctrlKey && e.key >= '1' && e.key <= '4') {
            e.preventDefault();
            const modes = ['normal', 'search', 'deep', 'art'];
            setMode(modes[parseInt(e.key) - 1]);
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (abortController) {
            abortController.abort();
        }
        stopSmartStatus();
    });
</script>
</body>
</html>
